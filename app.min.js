// Register the app and configure active modules
var activeModules = [
  // Angular Configs
  'app.config',
  'routes.config',
  // Angular Directives
  'header.directive',
  // Angular Modules
  'angular-carousel',
  'ngAnimate',
  'ngCookies',
  'ngDialog',
  'ngTouch',
  'pascalprecht.translate',
  // App Services
  'customtranslationloader.service',
  'booklet.service',
  'cache.service',
  'cachemanagement.service',
  'dataservice.service',
  'error.service',
  'httpinterceptor.service',
  'restapi.service',
  'css.service',
  'imageloading.service',
  'configuration.service',
  'nearby.service',
  //App Filters
  'htmlSafe.filter',
  // Exception Handler
  //App Models
  'achievements.model',
  'booklet.model',
  'history.model',
  // App Controllers
  'achievements.controller',
  'booklet.controller',
  'exchangetype.controller',
  'exchangecards.controller',
  'exchangefriends.controller',
  'exchangecardfriend.controller',
  'exchangecardfriendoverlay.directive',
  'history.controller',
  'main.controller',
  'error.controller',
  'prizelist.controller',
  'winshakes.controller',
  'profile.controller',
  'loading.controller',
  'qrcode.controller',
  'promocode.controller',
  'exchangecardsforwildcard.controller',

  // App Directives
  'httpSrc.directive',
  'sidemenu.directive',
  'tutorial.directive',
  'terms.directive',
  'card.directive',
  'error.directive',
  'swipe.directive',
  'reward.directive',
  'timer.directive',
  'ngPinchZoom.directive',
  'optionbutton.directive',
  'share.directive',
  'mysterybox.controller',
  'previousbooklet.controller',
  'splashvideo.directive'
];

angular
  .module('yornShakeItApp', activeModules)
  .config(InterceptorConfig)
  .config(TranslationsConfig)
  .run(Init);


// Initialize angular app
Init.$inject = ["$location", "$rootScope", 'CssService', 'CacheService', 'configurationsService', '$timeout', 'appConfig', '$translate', '$q', '$log'];

function Init($location, $rootScope, CssService,CacheService, configurationsService, $timeout, appConfig, $translate, $q, $log) {

  configurationsService.appendRemoteProperties();
  CssService.getCssFile({
    "width": window.innerWidth,
    "height": window.innerHeight
  }).then(function (data) {
    var head = document.head || document.getElementsByTagName('head')[0];
    var style = document.createElement('style');
    style.type = 'text/css';
    if (style.styleSheet) {
      style.styleSheet.cssText = data;
    } else {
      style.appendChild(document.createTextNode(data));
    }
    head.appendChild(style);
  });

  $rootScope.goto = function (destination) {
    $location.path(destination);
  };

  $rootScope.showError = function () {
    $rootScope.showErrorPage = true;
  };

  $rootScope.showErrorPage = false;
  $rootScope.canRefer = null;
  $rootScope.canSwipe = true;
  $rootScope.canSwipeUp = false;
  $rootScope.canDisplayPage = true;
  $rootScope.ignoreParams = true;
  $rootScope.overlayActive = false;
  $rootScope.notShuffledMiddlegameprizes = null;
  $rootScope.notShuffledMiddlegameprize = null;

  $rootScope.notifyUserNewPrize = null;

  $rootScope.userCanAcceptTerms = true;

  $rootScope.sessionExpired = false;
  $rootScope.exchangeCardsPrizeEnabled = undefined;
  $rootScope.exchangeCardsPrizeNumCards = undefined;

  // Initialize User Settings object
  $rootScope.userSettings = {
    sound : undefined,
    vibration: undefined
  }
  
  function loadConfigurationsFromFirstLogin(){
    CacheService.getUserFirstLogin(true).then(function (_userFirstLogin) {
      $rootScope.exchangeCardsPrizeEnabled = _userFirstLogin.exchangeCardsPrizeEnabled;
      $rootScope.exchangeCardsPrizeNumCards = _userFirstLogin.exchangeCardsPrizeNumCards;
      
      // Assign User Settings form the firstLogin
      $rootScope.userSettings = _userFirstLogin.userSettings;
      $rootScope.prizeAddress = _userFirstLogin.userSettings.prizeAddress;
    });
  }
  loadConfigurationsFromFirstLogin();
 

  // Listners for User Settings from SideMenu buttons
  $rootScope.$on('soundEnabled', function (e) {
    $rootScope.userSettings.sound = true;
  });

  $rootScope.$on('soundDisabled', function (e) {
    $rootScope.userSettings.sound = false;
  });

  $rootScope.$on('vibrateEnabled', function (e) {
    $rootScope.userSettings.vibration = true;
  });

  $rootScope.$on('vibrateDisabled', function (e) {
    $rootScope.userSettings.vibration = false;
  });


  $rootScope.$on("$locationChangeStart", function (event, next, current) {

    //Flag to show/hide the Camera Button
    $rootScope.isOnMainPage = $location.$$path === '/main';

    $rootScope.canSwipe = true;
    $rootScope.canSwipeUp = false;

    var validNextScreens = [
      "achievements",
      "history",
      "profile",
      "main"
    ];
    var isValidScreen = false;
    for (var i = 0; i < validNextScreens.length; i++) {
      if (next.indexOf(validNextScreens[i]) > 0) {
        isValidScreen = true;
        break;
      }
    }

    if (!isValidScreen) {
      delete $rootScope.animationClass;
    }

    $rootScope.showErrorPage = false;
  });

  $rootScope.$on("$locationChangeSuccess", function (event, next, current) {

    //Flag to show/hide the Camera Button
    $rootScope.isOnMainPage = $location.$$path === '/main';

    $timeout(function () {
      delete $rootScope.animationClass;
    }, 500);

    if (next == current) {
      $translate.refresh();
    }
  });

  $rootScope.isAndroid = false;
  $rootScope.isIOS = false;

  $rootScope.mcareIntegration = function (data) {
    var _deferred = $q.defer();

    // Assign User settings to the data object
    data.playSound = $rootScope.userSettings.sound;
    data.vibrate = $rootScope.userSettings.vibration;

    if ($rootScope.isAndroid) {
      if (data) { 
        vibrateAndPlaySound(data);
      }
      
      if (data.shareLink && data.shareLink !== null) {
        if (typeof android !== "undefined" && typeof android.openLinkOnHost !== "undefined") {
          android.openLinkOnHost(data.shareLink);
        }
      }
      _deferred.resolve(true);
    } else if ($rootScope.isIOS && !window.MSStream) {

      if (data) {
        vibrateAndPlaySound(data);
      }

      if (data.shareLink && data.shareLink !== null) {
        if (typeof openLinkOnHost !== "undefined") {
          openLinkOnHost(data.shareLink);
        }
      }
      _deferred.resolve(true);
    }

    _deferred.promise;
  };

  function vibrateAndPlaySound(data) {
    var soundUrl = "";
    var vibrateTimeProperties = null;

    if (appConfig['sounds.base.url'] === undefined || appConfig['sounds.base.url'] === null) {
      $log.debug("[app]  Not playing sounds (appConfig['sounds.base.url']) not defined or null ");
    }
   
    switch (data.action) {
      case 'shake':
        {
          soundUrl = appConfig['sounds.base.url'] + appConfig['sounds.shake'];
          vibrateTimeProperties = appConfig['sounds.shake.vibrate.time'];
          break;
        }
      case 'winPrize':
        {
          soundUrl = appConfig['sounds.base.url'] + appConfig['sounds.winPrize'];
          vibrateTimeProperties = appConfig['sounds.winPrize.vibrate.time'];
          break;
        }
      case 'goldCard':
        {
          soundUrl = appConfig['sounds.base.url'] + appConfig['sounds.goldCard'];
          vibrateTimeProperties = appConfig['sounds.goldCard.vibrate.time'];
          break;
        }
      case 'lineColumun':
        {
          soundUrl = appConfig['sounds.base.url'] + appConfig['sounds.lineColumun'];
          vibrateTimeProperties = appConfig['sounds.lineColumun.vibrate.time'];
          break;
        }
      case 'pasteCard':
        {
          soundUrl = appConfig['sounds.base.url'] + appConfig['sounds.pasteCard'];
          vibrateTimeProperties = appConfig['sounds.pasteCard.vibrate.time'];
          break;
        }
      case 'colectionComplete':
        {
          soundUrl = appConfig['sounds.base.url'] + appConfig['sounds.colectionComplete'];
          vibrateTimeProperties = appConfig['sounds.colectionComplete.vibrate.time'];
          break;
        }
      case 'redeem':
        {
          soundUrl = appConfig['sounds.base.url'] + appConfig['sounds.redeem'];
          vibrateTimeProperties = appConfig['sounds.redeem.vibrate.time'];
          break;
        }
      case 'notredeem':
        {
          soundUrl = appConfig['sounds.base.url'] + appConfig['sounds.notredeem'];
          vibrateTimeProperties = appConfig['sounds.notredeem.vibrate.time'];
          break;
        }
      case 'openMysteryBox':
        {
          soundUrl = appConfig['sounds.base.url'] + appConfig['sounds.openMysteryBox'];
          vibrateTimeProperties = appConfig['sounds.openMysteryBox.vibrate.time'];
          break;
        }
      case 'foundFriend':
        {
          soundUrl = appConfig['sounds.base.url'] + appConfig['sounds.foundFriend'];
          vibrateTimeProperties = appConfig['sounds.foundFriend.vibrate.time'];
          break;
        }
      case 'confirmTrade':
        {
          soundUrl = appConfig['sounds.base.url'] + appConfig['sounds.confirmTrade'];
          vibrateTimeProperties = appConfig['sounds.confirmTrade.vibrate.time'];
          break;
        }
      default:
        {
          console("Action name on mcareIntegeration " + data.action + " is not been considered.");
        }
    }

    if (soundUrl === undefined || soundUrl === null) {
      $log.debug("[app]  Not playing sounds (soundUrl) not defined or null ");
      return;
    }

    // Vibrate ACTIVE
    if(data.vibrate) {
        
        var vibrateTime = (vibrateTimeProperties !== undefined && vibrateTimeProperties !== null) ? vibrateTimeProperties : 3;

        if (vibrateTime) {
          vibrateTime = parseInt(vibrateTime);
        }
        console.log("Vibrating during " + vibrateTime);
        console.log("Vibrating during from properties " + vibrateTimeProperties);

        if ($rootScope.isAndroid) {
          if ((typeof android !== "undefined") && (typeof android.vibrate !== "undefined")) {
              android.vibrate(vibrateTime);
          }
        } else {
          if ($rootScope.isIOS) {
            if (typeof vibrate !== "undefined") {
                vibrate(vibrateTime);
            }
          }
        }
    } else {
        $log.debug("[app] Not vibrating $rootScope.userSettings.vibration === false");
    }

    // Sound is ACTIVE
    if(data.playSound) {
      console.log("Playing sound " + soundUrl + " - " + data.action);

      if ($rootScope.isAndroid) {
        if ((typeof android !== "undefined") && (typeof android.playSound !== "undefined")) {
            android.playSound(soundUrl);
        }
      } else {
        if ($rootScope.isIOS) {
          if (typeof playSound !== "undefined") {
            if($rootScope.userSettings.sound){
              playSound(soundUrl);
            }
          }
        }
      }
    } else {
        $log.debug("[app] Not playing sounds $rootScope.userSettings.sound === false");
    }
  }

  function setDeviceOS() {
    var userAgent = navigator.userAgent || navigator.vendor || window.opera;
    if (/android/i.test(userAgent)) {
      $rootScope.isAndroid = true;
    } else if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
      $rootScope.isIOS = true;
    }
  }
  setDeviceOS();
}


//Register the interceptor for the http rquests
InterceptorConfig.$inject = ['$httpProvider'];

function InterceptorConfig($httpProvider) {
  $httpProvider.defaults.withCredentials = true;
  //Enable cross domain calls
  $httpProvider.defaults.useXDomain = true;
  //remove OPTIONS
  delete $httpProvider.defaults.headers.common['X-Requested-With'];

  $httpProvider.interceptors.push('HttpInterceptorService');
}

//Register the translation provider
TranslationsConfig.$inject = ["$translateProvider"];

/****** I18n *****/
/*
var languagesAvailable = {
    pt : 'pt',
    en : 'en'
};
*/
/*
* Gets the language code for active or preferred language
* If not in storage gets the preferred language from the browser
*
var getActiveLanguage = function(){

  //Get form storage
 var lang = localStorage.getItem('NG_TRANSLATE_LANG_KEY');

  if(lang === undefined || lang == null) {
      lang = window.navigator.userLanguage || window.navigator.language;
  }

  return lang;
};
*/

function TranslationsConfig($translateProvider) {
  $translateProvider.useLoader('customTranslationLoader', {});
  $translateProvider.useLocalStorage();
  $translateProvider.preferredLanguage('pt');
  $translateProvider.useSanitizeValueStrategy('sanitizeParameters');


  // Points to the DEV/DIST path relative to root server path
  // https://angular-translate.github.io/docs/#/guide/12_asynchronous-loading
  /*
    $translateProvider.useStaticFilesLoader({
      prefix: './app/assets/texts/',
      suffix: '.json'
  });
  $translateProvider.preferredLanguage(languagesAvailable.pt);
  */
}

function onDeviceFound(content) {
  console.log("onDeviceFound" + content);
  var exchangeFriendsContainer = document.getElementById("exchangeFriendsContainer");
  if (exchangeFriendsContainer != null) {
    console.log("onDeviceFound exchangeFriendsContainer" + content);
    angular
      .element(exchangeFriendsContainer)
      .scope()
      .vm.friendsOnDeviceFound(content);
  }
}

function onDeviceLost(content) {
  console.log("onDeviceLost" + content);
  var exchangeFriendsContainer = document.getElementById("exchangeFriendsContainer");
  if (exchangeFriendsContainer != null) {
    console.log("onDeviceLost exchangeFriendsContainer" + content);
    angular
      .element(exchangeFriendsContainer)
      .scope()
      .vm.friendsOnDeviceLost(content);
  }
}

function scrollTo(element, to, duration) {
  var start = element.scrollTop,
    change = to - start,
    currentTime = 0,
    increment = 20;

  var animateScroll = function () {
    currentTime += increment;
    var val = Math.easeInOutQuad(currentTime, start, change, duration);
    element.scrollTop = val;
    if (currentTime < duration) {
      setTimeout(animateScroll, increment);
    }
  };
  animateScroll();
}

//t = current time
//b = start value
//c = change in value
//d = duration
Math.easeInOutQuad = function (t, b, c, d) {
  t /= d / 2;
  if (t < 1) return c / 2 * t * t + b;
  t--;
  return -c / 2 * (t * (t - 2) - 1) + b;
};

function getAndroidVersion(ua) {
  ua = (ua || navigator.userAgent).toLowerCase();
  var match = ua.match(/android\s([0-9\.]*)/);
  return match ? match[1] : false;
}

/*! modernizr 3.5.0 (Custom Build) | MIT *
 * https://modernizr.com/download/?-cssvwunit-setclasses !*/
!function(e,n,t){function s(e,n){return typeof e===n}function o(){var e,n,t,o,a,r,i;for(var l in c)if(c.hasOwnProperty(l)){if(e=[],n=c[l],n.name&&(e.push(n.name.toLowerCase()),n.options&&n.options.aliases&&n.options.aliases.length))for(t=0;t<n.options.aliases.length;t++)e.push(n.options.aliases[t].toLowerCase());for(o=s(n.fn,"function")?n.fn():n.fn,a=0;a<e.length;a++)r=e[a],i=r.split("."),1===i.length?Modernizr[i[0]]=o:(!Modernizr[i[0]]||Modernizr[i[0]]instanceof Boolean||(Modernizr[i[0]]=new Boolean(Modernizr[i[0]])),Modernizr[i[0]][i[1]]=o),f.push((o?"":"no-")+i.join("-"))}}function a(e){var n=p.className,t=Modernizr._config.classPrefix||"";if(h&&(n=n.baseVal),Modernizr._config.enableJSClass){var s=new RegExp("(^|\\s)"+t+"no-js(\\s|$)");n=n.replace(s,"$1"+t+"js$2")}Modernizr._config.enableClasses&&(n+=" "+t+e.join(" "+t),h?p.className.baseVal=n:p.className=n)}function r(n,t,s){var o;if("getComputedStyle"in e){o=getComputedStyle.call(e,n,t);var a=e.console;if(null!==o)s&&(o=o.getPropertyValue(s));else if(a){var r=a.error?"error":"log";a[r].call(a,"getComputedStyle returning null, its possible modernizr test results are inaccurate")}}else o=!t&&n.currentStyle&&n.currentStyle[s];return o}function i(){return"function"!=typeof n.createElement?n.createElement(arguments[0]):h?n.createElementNS.call(n,"http://www.w3.org/2000/svg",arguments[0]):n.createElement.apply(n,arguments)}function l(){var e=n.body;return e||(e=i(h?"svg":"body"),e.fake=!0),e}function d(e,t,s,o){var a,r,d,f,c="modernizr",u=i("div"),h=l();if(parseInt(s,10))for(;s--;)d=i("div"),d.id=o?o[s]:c+(s+1),u.appendChild(d);return a=i("style"),a.type="text/css",a.id="s"+c,(h.fake?h:u).appendChild(a),h.appendChild(u),a.styleSheet?a.styleSheet.cssText=e:a.appendChild(n.createTextNode(e)),u.id=c,h.fake&&(h.style.background="",h.style.overflow="hidden",f=p.style.overflow,p.style.overflow="hidden",p.appendChild(h)),r=t(u,e),h.fake?(h.parentNode.removeChild(h),p.style.overflow=f,p.offsetHeight):u.parentNode.removeChild(u),!!r}var f=[],c=[],u={_version:"3.5.0",_config:{classPrefix:"",enableClasses:!0,enableJSClass:!0,usePrefixes:!0},_q:[],on:function(e,n){var t=this;setTimeout(function(){n(t[e])},0)},addTest:function(e,n,t){c.push({name:e,fn:n,options:t})},addAsyncTest:function(e){c.push({name:null,fn:e})}},Modernizr=function(){};Modernizr.prototype=u,Modernizr=new Modernizr;var p=n.documentElement,h="svg"===p.nodeName.toLowerCase(),m=u.testStyles=d;m("#modernizr { width: 50vw; }",function(n){var t=parseInt(e.innerWidth/2,10),s=parseInt(r(n,null,"width"),10);Modernizr.addTest("cssvwunit",s==t)}),o(),a(f),delete u.addTest,delete u.addAsyncTest;for(var v=0;v<Modernizr._q.length;v++)Modernizr._q[v]();e.Modernizr=Modernizr}(window,document);
(function () {
    'use strict';

    angular.module("achievements.controller", []).controller("AchievementsController", AchievementsController);

    AchievementsController.$inject = ["$log", "$route", "DataService", "$translate"];

    function AchievementsController($log, $route, DataService, $translate) {
        var vm = this;
        vm.list = null;
        vm.unlocked = null;
        vm.showunlocked = false;
        vm.backactive = $route.current.$$route.historyBack === true;
        vm.newAchievementDescription = null;

        vm.close = _close;

        vm.goToAchievement = goToAchievement;

        function _close() {
            $log.debug("[AchievementsController][_close]");
            vm.showunlocked = false;
            vm.list.setNewAchievement(null);
        }

        function _init() {
            $log.debug("[AchievementsController][_init]");
            _getAchievements();
        }

        function goToAchievement(achievement) {
            $log.debug("[AchievementsController][goToAchievement][achievement]: " + JSON.stringify(achievement));

            if (achievement.level !== undefined && achievement.level !== null && achievement.level.length > 0) {
                vm.list.setNewAchievement(achievement);
                vm.newAchievementDescription = vm.list.getNewAchievement().description;
                vm.showunlocked = true;
            }
        }

        function _getAchievements() {
            $log.debug("[AchievementsController][_getAchievements]");
            DataService.getAchievements().then(function (_result) {
                vm.list = _result;

                if (_result.getNewAchievement()) {
                    vm.newAchievementDescription = _result.getNewAchievement().description;
                    vm.showunlocked = true;
                }

            }, function (_error) {

                $log.debug("[AchievementsController][_getAchievements]: ERROR", _error);
            });
        }

        _init();
    }
})();

(function () {

    'use strict';

    angular
        .module("booklet.controller", [])
        .directive('imageonload', ['$parse', function ($parse) {
            return {
                restrict: 'A',
                link: function (scope, element, attrs) {
                    // element.bind('load', function () {
                    //     //call the function that was passed
                    //     scope.$apply(attrs.imageonload);
                    // });

                    var fn = $parse(attrs.imageonload);
                    element.on('load', function (event) {
                        scope.$apply(function () {
                            fn(scope, { $event: event });
                        });
                    });
                }
            };
        }])
        .controller("BookletController", BookletController);

    BookletController.$inject = ['$q', '$log', '$scope', '$location', '$document', '$window', '$animateCss', '$timeout', '$routeParams', '$interval',
        'Booklet', 'BookletService', 'CacheService', 'DataService', 'ngDialog', 'appConfig', '$rootScope', 'ErrorService'
    ];

    function BookletController($q, $log, $scope, $location, $document, $window, $animateCss, $timeout, $routeParams, $interval,
                               Booklet, BookletService, CacheService, DataService, ngDialog, appConfig, $rootScope, ErrorService) {
        //variables
        var _lockedforAnimation = false;
        var vm = this;
        var doc = $document[0];
        var _ignoreSoundAndVibration = false;
        var duplicatedGoldCardRedeemActionSubmited = false;
        var newCard = null;
        var positionId;
        var _cardsForDetail = []; //keeps all collection cards (including gold)
        var isDuplicatedGoldCardExchange = false;
        vm.cards = []; //all collection cards (gold not included)
        vm.carouselIndex = 4;
        vm.goldCarouselIndex = 1;
        vm.completionKey = ''; //text key to be shown
        vm.gallery = null; //object to keep entire parsed collection
        vm.goldCards = []; //gold cards
        vm.goldSwipeanimate = false; //animates title and arrows
        vm.goldCurrcard = null;
        vm.middlegameunlocked = false; //if true, middle game will be shown
        vm.middlegameprizes = null; //if true, middle game will be shown
        vm.showDetailView = null;
        vm.swipeanimate = false; //animates title and arrows
        vm.showBooklet = false;
        vm.showoverlay = false;
        vm.showparty = false;
        vm.showWinPrize = null;
        vm.showWinCard = null;
        vm.headerInfo = null;
        vm.shakeCard = null;
        vm.showGoldCardInCarousel = false;
        vm.canContinueExchange = false;
        vm.onAnimationEndCanContinueExchange = false;
        vm.exchangeFriend = null;
        vm.canPickMiddlePrize = false;

        vm.isGuessCardNameActive = appConfig.global.isGuessCardNameActive;
        vm.alreadyAnsewrCorrect = [];

        $scope.showZoomCollection = false;
        $scope.collectionReady = false;
        $scope.collectionHeight = null;

        $rootScope.finalDescription = [];

        $rootScope.caroucelIsLocked = false;
        $rootScope.canFlipCard = true;

        //these vars control prize animation
        var _middlePrizeShown = false;
        var _columnCompletedShown = false;
        var _bookletCompletedShown = false;
        var _prizesValidationActive = false;

        //functions
        vm.close = closeDetail;
        vm.closeGoldCarousel = closeGoldCarousel;
        vm.flipCard = flipCard;
        vm.getGoldCards = _getGoldCards;
        vm.redeemPrize = _redeemPrize;
        vm.redeemPrize_Card = _redeemPrize_Card;
        vm.showCardDetail = showCardDetail;
        vm.showGoldCardDetail = showGoldCardDetail;
        vm.showCategoryDetail = showCategoryDetail;
        vm.shuffle = _shuffle;
        vm.middlePrizeCardClick = _middlePrizeCardClick;
        vm.swipe = swipe;
        vm.goldSwipe = goldSwipe;
        vm.continueExchange = continueExchange;
        vm.closeContinueExchangeOverlay = closeContinueExchangeOverlay;
        vm.processDetailImageOnLoad = _processDetailImageOnLoad;
        vm.bookletBodyFix = bookletBodyFix;
        vm.viewAllCollection = viewAllCollection;
        vm.verifyAllImageLoading = verifyAllImageLoading;
        vm.galleryCardsCount = galleryCardsCount;

        // EVENT HANDLER
        //if answer ok or terms accepted, updates prizes in order to avoid flow again
        var submitUpdateUserPrize = $scope.$on(appConfig.events.update_userprize, function (event, params) {
            var _prize = params;
            if (params) {
                for (var card in vm.gallery.cards[0]) {

                    if (vm.gallery.cards[0][card].prize &&
                        vm.gallery.cards[0][card].prize.userPrizeId == _prize.userPrizeId) {
                        vm.gallery.cards[0][card].prize = _prize;
                    }
                }
            }
        });

        //event triggered by redeem success action
        var submitUpdateBooklet = $scope.$on(appConfig.events.submiteUpdateProfileUserPrizes, function (event, params) {
            $timeout(function () {
                $scope.$apply(updateGallery(true));
                //if prize was more shakes, has to update ui
                CacheService.getUserShakesStatus(true);
                _prizesValidationActive = false;
            });
        });

        // event triggered on wrong redeem answer
        var prizeAnswerWrong = $scope.$on(appConfig.events.prizeAnswerWrong, function (event, params) {
            //avoids prize flow from appearing on gold detail after an error
            if ($scope.booklet) {
                $scope.booklet.queroOpened = false;
            }
            $timeout(function () {
                $scope.$apply(updateGallery(true));
                _prizesValidationActive = false;

            });
        });

        var submitCloseShakeCard = $scope.$on(appConfig.events.cardClose, function () {
            isDuplicatedGoldCardExchange = vm.shakeCard && vm.shakeCard.duplicatedPrize !== null && vm.shakeCard.type === appConfig.cardTypes.gold;
            if ($scope.booklet) {
                $scope.booklet.queroOpened = false;
            }

            _prizesValidationActive = false;
            if (vm.shakeCard) {
                if (vm.shakeCard.htmlId == null && vm.shakeCard.type != appConfig.cardTypes.prize && !isDuplicatedGoldCardExchange) {
                    if (vm.shakeCard.type != appConfig.cardTypes.joker) {
                        _ignoreSoundAndVibration = true;
                        placeCardOnBooklet(false, null, true);
                    }
                }
                //if(vm.shakeCard.htmlId != null){ //[https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-416]
                vm.showWinCard = false;
                // }
            } else {
                _verifyAndTriggerPrizes();
            }

            //Prevent refresh which would lead to error
            if (isDuplicatedGoldCardExchange == true) {
                //https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-525
                //This gives more visibility to number of shakes being updated
                CacheService.getUserShakesStatus(true);

                $location.path(appConfig.routes.booklet);
            }
            vm.showWinPrize = false;
            vm.prize = null;
            $rootScope.canSwipe = true;
            console.log("submitCloseShakeCard");
        });

        var submitPlaceContainerShakePosition = $scope.$on(appConfig.events.placeContainerShakePosition, function () {
            placeContainerShakePosition();
        });

        function placeContainerShakePosition() {
            angular.element(doc.getElementById("bookletContainer")).ready(function () {

                var headerCardsId = "headerCards";
                var cardPosition;
                var categoryPosition;

                if (vm.shakeCard.type == appConfig.cardTypes.collection) {
                    cardPosition = vm.shakeCard.card.position;
                    categoryPosition = vm.shakeCard.card.categoryPosition;

                    if (vm.shakeCard.card.duplicated) {
                        positionId = headerCardsId;
                    } else {
                        positionId = "position_" + cardPosition;
                    }

                } else if (vm.shakeCard.type == appConfig.cardTypes.gold) {
                    categoryPosition = vm.shakeCard.categoryPosition;
                    positionId = "position_gold_" + categoryPosition;
                    $log.debug("Gold card position " + positionId);
                }

                var position = doc.getElementById(positionId);
                var positionElem = angular.element(position);

                var scrollAmountY = ((position.getBoundingClientRect().bottom + position.getBoundingClientRect().top) * 0.5) - (screen.height * 0.5);
                var scrollAmountX = (position.getBoundingClientRect().left + position.getBoundingClientRect().width) - screen.width;
                var finalScrollAmountX = scrollAmountX + position.getBoundingClientRect().width;

                $log.debug("[placeCardOnBooklet]: scrollAmountY", scrollAmountY);
                $log.debug("[placeCardOnBooklet]: scrollAmountX", scrollAmountX);
                $log.debug("[placeCardOnBooklet]: finalScrollAmountX", finalScrollAmountX);

                doc.getElementById("bookletContainer").scrollTop = scrollAmountY;
                doc.getElementById("bookletBody").scrollLeft = finalScrollAmountX;

            });
        }

        var submitCardRedeemAction = $scope.$on(appConfig.events.cardRedeemAction, function () {
            angular.element(doc.getElementById("bookletContainer")).ready(function () {
                isDuplicatedGoldCardExchange = vm.shakeCard && vm.shakeCard.duplicatedPrize !== null && vm.shakeCard.type === appConfig.cardTypes.gold;
                if (isDuplicatedGoldCardExchange) {
                    duplicatedGoldCardRedeemActionSubmited = true;
                }
                placeCardOnBooklet(false);
                _prizesValidationActive = false;
            });
        });

        // END EVENT HANDLER
        function bookletBodyFix() {
            $timeout(function () {
                var bookletBody = document.getElementById("bookletBody");
                if (bookletBody) {
                    bookletBody.style.whiteSpace = "nowrap";
                    bookletBody.style.overflowX = "auto";
                    bookletBody.style.overflowY = "hidden";
                }
                console.log("bookletBodyFix");
            }, 1000);
        }

        /**
         * Processes the event of a card detail view image load
         */
        function _processDetailImageOnLoad(imageIndex) {
            var front = doc.getElementById("mainCardImage" + imageIndex); //img
            var back = doc.getElementById("mainCardCoverImage" + imageIndex); //div
            //make sure the back of the card has the same dimensions as the card
            back.style.width = front.width + "px";
            back.style.height = front.height + "px";
            back.style.marginLeft = "auto";
            back.style.marginRight = "auto";
        }

        function placeCardOnBooklet(count, ignoreAnimation) {

            $log.debug("[placeCardOnBooklet]: count(" + count + ") ignoreAnimation(" + ignoreAnimation + ")");

            if (vm.shakeCard != null && vm.shakeCard.card != null) {
                $log.debug("[placeCardOnBooklet]: Card", vm.shakeCard.card);
            }

            if (vm.showBooklet && !document.getElementById("position_60")) {

                var timeoutTime = 300;

                if (!count) {
                    count = 1;
                } else {
                    if (count % 10 == 0) {
                        timeoutTime += 500;
                    }

                    if (count == 50) {
                        ErrorService.setError({
                            "statusCode": appConfig.statusCode.TIMEOUT
                        });
                        $location.path(appConfig.routes.error);
                        return;
                    }
                }

                $timeout(function () {
                    placeCardOnBooklet(++count);
                }, timeoutTime);
                return;
            }

            var headerCardsId = "headerCards";
            var cardPosition;
            var categoryPosition;
            var image;
            var cardId;

            if (vm.shakeCard.type == appConfig.cardTypes.collection) {
                cardPosition = vm.shakeCard.card.position;
                categoryPosition = vm.shakeCard.card.categoryPosition;
                image = vm.shakeCard.card.image;
                cardId = vm.shakeCard.card.id;
                if (vm.shakeCard.card.duplicated) {
                    positionId = headerCardsId;
                } else {
                    positionId = "position_" + cardPosition;
                }

            } else if (vm.shakeCard.type == appConfig.cardTypes.gold) {
                categoryPosition = vm.shakeCard.categoryPosition;
                positionId = "position_gold_" + categoryPosition;
                image = vm.shakeCard.prize.image;
                cardId = vm.shakeCard.prize.id;

                $log.debug("Gold card position " + positionId);
            }

            var position = doc.getElementById(positionId);
            var positionElem = angular.element(position);

            try {
                if (vm.gallery !== null && !newCard && vm.shakeCard.type !== appConfig.cardTypes.joker) {
                    vm.shakeCard.middlePrize = $rootScope.middlePrize;
                    vm.shakeCard.middlePrizes = $rootScope.middlePrizes;
                    newCard = new Booklet().parseCardFromData(vm.shakeCard);
                    newCard.image = CacheService.addDimensionsToCardImageUrl(newCard.image);
                    newCard.imageCached = CacheService.addDimensionsToCardImageUrl(newCard.imageCached);
                    vm.gallery.addCard(newCard);
                }
            } catch (error) {
                $log.error("[placeCardOnBooklet]: ERROR", error);
            }

            var isGoldExchange = false;
            if (vm.shakeCard.duplicatedPrize !== null && vm.shakeCard.type === appConfig.cardTypes.gold) {
                isGoldExchange = true;
                image = vm.shakeCard.duplicatedPrize.image;
                cardId = vm.shakeCard.duplicatedPrize.id;

                console.log("Gold card cardId " + cardId);
            }

            var goldCardExchangeSelected = duplicatedGoldCardRedeemActionSubmited || isGoldExchange;
            var imageCardId = goldCardExchangeSelected ? "goldCardExchangeSelected" : "winCardCard";
            var card = doc.getElementById(imageCardId);
            var cardElem = angular.element(card);

            if (ignoreAnimation) {
                $log.debug("[placeCardOnBooklet]: Ignoring animation");
                animationEnd();
            }

            if (card) {
                var bodyRect = doc.body.getBoundingClientRect(),
                    elemRect = card.getBoundingClientRect(),
                    cardOffsetTop = elemRect.top,
                    cardOffsetLeft = elemRect.left,
                    cardWidth = cardElem.prop("offsetWidth"),
                    cardHeight = cardElem.prop("offsetHeight");

                cardElem.css("width", cardWidth + "px")
                    .css("height", cardHeight + "px")
                    .css("top", cardOffsetTop + "px")
                    .css("left", cardOffsetLeft + "px")
                    .css("position", "fixed");

                var placeCardOnBookletAnimation = $animateCss(cardElem, {
                    easing: 'linear',
                    from: {
                        height: cardElem.css("height"),
                        width: cardElem.css("width"),
                        top: cardElem.css("top"),
                        left: cardElem.css("left")
                    },
                    to: {
                        height: positionElem.prop("offsetHeight") + "px",
                        width: positionElem.prop("offsetWidth") + "px",
                        top: position.getBoundingClientRect().top + "px",
                        left: position.getBoundingClientRect().left + "px"
                    },
                    duration: 0.5
                });
                $timeout(function () {

                    angular.element(doc.getElementById("winCardImg")).addClass("image-full")
                        .css({
                            "box-sizing": "border-box",
                            "padding": "4%"
                        }); //https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-666
                }, 250);

                placeCardOnBookletAnimation.start().then(function () {
                    animationEnd();
                    if (!_ignoreSoundAndVibration && !(vm.shakeCard.card && vm.shakeCard.card.duplicated)) {
                        $timeout(function () {
                            console.log("Past Card - before playing sound");
                            $rootScope.mcareIntegration({
                                'playSound': true,
                                'action': 'pasteCard'
                            });
                            console.log("Past Card - after playing sound");
                        }, 0);
                    }
                });
            }

            function animationEnd() {
                if (vm.shakeCard.type == appConfig.cardTypes.collection && vm.shakeCard.card.duplicated) {
                    CacheService.udpateDuplicatedCards(1).then(function () {
                        $scope.$emit(appConfig.events.updateUserShakesStatus);

                        CacheService.getUserShakesStatus(true);
                    });
                } else {
                    var arrLength = vm.gallery.cards[0].length;
                    var row = 0;
                    var col = categoryPosition - 1;
                    var finalImage;
                    if (vm.shakeCard.type == appConfig.cardTypes.collection) {
                        row = (cardPosition - categoryPosition + arrLength) / arrLength;
                        if (vm.shakeCard && vm.shakeCard.card) {
                            var _width = Math.round(window.innerWidth * 0.7);
                            finalImage = vm.shakeCard.card.image; // + "?width=" + _width + "&height=" + Math.round(1.38*_width);
                        }
                    } else {

                        if (isGoldExchange) {
                            finalImage = cardElem.attr("src");
                        } else {
                            finalImage = cardElem.find("img").attr("src");
                        }

                    }
                    if (vm.shakeCard.type !== appConfig.cardTypes.joker) {
                        var arrElement = vm.gallery.cards[row][col];
                        arrElement.image = image;
                        arrElement.id = cardId;
                        //Add resize information so the card fits on the available space
                        finalImage = CacheService.addDimensionsToCardImageUrl(finalImage);
                        positionElem.attr("src", finalImage);

                        _verifyAndTriggerPrizes();
                    }
                }

                $timeout(function () {
                    $rootScope.canSwipe = true;
                }, 130);

                //MAJOR WORKAROUND to prevent cards image flickering on booklet [https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-633]
                var _unregisterInterval = null;

                //this "inner" function is called on interval
                function __updateCardBooklet() {

                    if (doc.getElementById(positionId) && doc.getElementById(positionId).complete) {

                        $timeout(function () {
                            vm.showWinCard = false;
                        }, 130);

                        if (_unregisterInterval) {
                            $interval.cancel(_unregisterInterval);
                        }
                    }
                }

                //if if has image already, normal flow, otherwise waits until it is loaded
                if (doc.getElementById(positionId) && doc.getElementById(positionId).complete) {
                    $timeout(function () {
                        vm.showWinCard = false;
                    }, 130);
                } else {
                    if (!_unregisterInterval) {
                        _unregisterInterval = $interval(function () {
                            __updateCardBooklet();
                        }, 150);
                    }
                }

                if (vm.onAnimationEndCanContinueExchange && vm.exchangeFriend !== null && vm.exchangeFriend.label !== null && vm.exchangeFriend.label.length > 0) {
                    vm.canContinueExchange = true;
                } else {
                    vm.canContinueExchange = false;
                }

            }
        }

        function _placeRedStripe(_position) {

            var positionId = "position_" + _position;
            var position = doc.getElementById(positionId);

            var bookletMessageOverlay = angular.element(doc.getElementById("bookletMessageOverlay"));
            bookletMessageOverlay.css("background-position-y", (position.getBoundingClientRect().bottom - (position.getBoundingClientRect().height * 0.5)) + "px");

            var bookletPrizeMessage = angular.element(doc.getElementById("bookletPrizeMessage"));
            bookletPrizeMessage.css("top", (position.getBoundingClientRect().bottom - (position.getBoundingClientRect().height * 0.10)) + "px");
        }

        function _checkColumnCompleted(_newCard) {
            $log.debug("[BookletController][_checkColumnCompleted]");
            var deferred = $q.defer();
            //on exchange gold card, animation shall not be triggered again [https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-548]
            var _shallAnimate = true && !isDuplicatedGoldCardExchange;

            if (_newCard.hasCategoryPrize === true && _newCard.prize && _columnCompletedShown === false) {
                vm.showoverlay = _shallAnimate;
                vm.completionKey = 'text.booklet.column.completed';
                _scrolltoCard(1);
                _placeRedStripe(1);

                var _colmn = _newCard.category - 1;
                vm.gallery.cards[0][_colmn].blueoverlay = _shallAnimate;
                vm.gallery.cards[0][_colmn].animate = _shallAnimate;
                for (var row = 0; row < vm.gallery.getCards().length; row++) {
                    if (vm.gallery.cards.hasOwnProperty(row)) {
                        vm.gallery.cards[row][_colmn].overlay = true;
                        vm.gallery.cards[row][_colmn].animate = _shallAnimate;
                    }
                }

                var _colmn = _newCard.category - 1;
                vm.gallery.cards[0][_colmn].blueoverlay = false;
                vm.gallery.cards[0][_colmn].animate = false;

                $timeout(function () {
                    $rootScope.mcareIntegration({
                        'playSound': true,
                        'action': 'lineColumun'
                    });
                    deferred.resolve(_shallAnimate);
                }, 3000);
            } else {
                deferred.resolve(false);
            }

            _columnCompletedShown = true;

            return deferred.promise;
        }

        function _checkFullCollectionCompleted(_newCard) {
            $log.debug("[BookletController][_checkFullCollectionCompleted]");
            var deferred = $q.defer();

            if (_newCard.fullPrize !== undefined && _newCard.fullPrize !== null && _bookletCompletedShown === false) {

                vm.showoverlay = true;
                vm.completionKey = 'text.booklet.collection.completed';

                _scrolltoCard(1);
                _placeRedStripe(1);

                for (var row = 1; row < vm.gallery.getCards().length; row++) {
                    if (vm.gallery.cards.hasOwnProperty(row)) {
                        for (var indx = 0; indx < 6; indx++) {
                            vm.gallery.cards[row][indx].overlay = true;
                            vm.gallery.cards[row][indx].animate = true;
                        }
                    }
                }

                $timeout(function () {
                    $rootScope.mcareIntegration({
                        'playSound': true,
                        'action': 'colectionComplete'
                    });
                    deferred.resolve(true);
                }, 3000);
            } else {
                deferred.resolve(false);
            }

            _bookletCompletedShown = true;

            return deferred.promise;
        }

        function _checkMiddlePrizeCompleted(_newcard) {

            $log.debug("[BookletController][_checkMiddlePrizeCompleted]");
            var deferred = $q.defer();

            if (_newcard.middlePrizes && _newcard.middlePrize && _newcard.middlePrizes.length > 0 && _middlePrizeShown === false) {

                _scrolltoCard(1);
                _placeRedStripe(1);

                vm.showoverlay = true;
                vm.completionKey = 'text.booklet.lines.completed';

                $timeout(function () {
                    $rootScope.mcareIntegration({
                        'playSound': true,
                        'action': 'lineColumun'
                    });
                    deferred.resolve(true);
                }, 3000);
            } else {
                deferred.resolve(false);
            }

            _middlePrizeShown = true;

            return deferred.promise;
        }

        function closeDetail() {

            vm.showDetailView = false;
            $rootScope.canSwipe = true;
            $timeout(function () {
                vm.showDetailView = null;
            }, 50);
            _lockedforAnimation = false;
            vm.flippedtocover = false;
        }

        function closeGoldCarousel() {
            vm.showDetailView = false;
            vm.showGoldCardInCarousel = false;
            $rootScope.canSwipe = true;
            vm.showDetailView = null;
            _lockedforAnimation = false;
            vm.flippedtocover = false;
        }

        function flipCard(index, isGoldCards) {
            var card = vm.cards[index];

            var idMainCardImage = "mainCardImage";
            var idMainCardCoverImage = "mainCardCoverImage";

            if (isGoldCards && isGoldCards === true) {

                card = vm.goldCards[index];
                idMainCardImage = "goldMainCardImage";
                idMainCardCoverImage = "goldMainCardCoverImage";

                $log.debug("[BookletController][flipCard]: Flip Card for Gold Cards");
            }

            if (card.canflip === true) {
                if (_lockedforAnimation === true) {
                    $log.debug("[BookletController][flipCard]: ALREADY animating! Will have to finish first!");
                } else {
                    _lockedforAnimation = true;

                    var _card = angular.element(doc.getElementById(idMainCardImage + index));
                    var _cover = angular.element(doc.getElementById(idMainCardCoverImage + index));

                    var _duration = 0.5;

                    if (card.flippedtocover === true) {

                        $animateCss(_cover, {
                            easing: 'linear',
                            duration: _duration,
                            from: {
                                transform: 'rotateY(0deg)'
                            },
                            to: {
                                transform: 'rotateY(-90deg)'
                            }
                        }).start().then(function () {

                            card.flippedtocover = false;

                            $animateCss(_card, {
                                easing: 'linear',
                                duration: _duration,
                                from: {
                                    transform: 'rotateY(-90deg)'
                                },
                                to: {
                                    transform: 'rotateY(0deg)'
                                }
                            }).start().then(function () {
                                _lockedforAnimation = false;
                            });
                        });

                    }
                    else {

                        $animateCss(_card, {
                            easing: 'linear',
                            duration: _duration,
                            from: {
                                transform: 'rotateY(0deg)'
                            },
                            to: {
                                transform: 'rotateY(-90deg)'
                            }
                        }).start().then(function () {

                            card.flippedtocover = true;

                            $animateCss(_cover, {
                                easing: 'linear',
                                duration: _duration,
                                from: {
                                    transform: 'rotateY(-90deg)'
                                },
                                to: {
                                    transform: 'rotateY(0deg)'
                                }
                            }).start().then(function () {
                                _lockedforAnimation = false;
                            });
                        });
                    }

                }
            } else {
                $log.debug("[BookletController][flipCard]: Cards CANNOT flip!");
            }
        }

        function updateGallery(forceUpdate) {
            $log.debug("[BookletController][updateGallery]", forceUpdate);
            CacheService.getBooklet(forceUpdate).then(function (result) {
                gallerySuccess(result);
                $scope.collectionReady = true;
            }, galleryError);
        }

        /**
         * Fix default height of the card detail view,
         * to prevent the android & ios keyboard from pulling and strech content up
         *
         * https://redmine.wit-software.com/issues/174727
        * */
        function cardDetailViewportHeight() {
            $timeout(function () {
                var cardDetailContainer = doc.getElementById("cardDetailContainer");
                var rect = cardDetailContainer.getBoundingClientRect();

                //console.log(rect.height);
                cardDetailContainer.style.height = rect.height + "px";

            }, 30);
        }

        function init() {

            if (parseInt(getAndroidVersion(), 10) < 5) {

                var submiteSwipeUp = $rootScope.$on(appConfig.events.swipeUp, function () {
                    var bookletContainer = document.getElementById("bookletContainer");
                    if (bookletContainer) {
                        scrollTo(bookletContainer, bookletContainer.scrollTop + 400, 150);
                    }
                });

                var submiteSwipeDown = $rootScope.$on(appConfig.events.swipeDown, function () {
                    var bookletContainer = document.getElementById("bookletContainer");
                    if (bookletContainer) {
                        scrollTo(bookletContainer, bookletContainer.scrollTop - 400, 150);
                    }
                });
            }

            bookletBodyFix();

            if ($rootScope.exchangeReturn != null) {
                updateGallery(false);
                shakeCardAction($rootScope.exchangeReturn);
                vm.onAnimationEndCanContinueExchange = $rootScope.exchangeReturn.canContinueExchange;
                vm.exchangeFriend = $rootScope.exchangeFriend;
                $rootScope.exchangeReturn = null;
            } else if (Object.keys($routeParams).length > 0) {
                var validRouterParam = false;
                var routerParam = "";
                if ($routeParams.hasOwnProperty(appConfig.routesParameters.option)) {

                    routerParam = $routeParams[appConfig.routesParameters.option];

                    if (!$rootScope.ignoreParams && routerParam == appConfig.routesParameters.shake) {
                        //https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-525
                        //This gives more visibility to number of shakes being updated
                        CacheService.updateShakesAvailable(-1).then(function () {
                            $scope.$emit(appConfig.events.updateUserShakesStatus);
                        });

                        $rootScope.ignoreParams = true;
                        validRouterParam = true;

                        DataService.getShakeCard().then(function (result) {
                            updateGallery(false);
                            shakeCardAction(result);
                            $scope.collectionReady = true;
                        }, function (error) {
                            vm.showBooklet = true;
                        });
                    } else if (routerParam == appConfig.routesParameters.duplicatedgold) {
                        validRouterParam = true;
                        DataService.getShakeDuplicatedGoldCard().then(function (result) {
                            updateGallery(false);
                            shakeCardAction(result);
                        }, function (error) {
                            vm.showBooklet = true;
                        });
                    } else if (routerParam == appConfig.routesParameters.middlePrizeNotShuffled) {

                        if ($rootScope.notShuffledMiddlegameprizes && $rootScope.notShuffledMiddlegameprize) {

                            $log.debug("Middle prizes found from route parameters");

                            vm.middlegameprizes = _toMiddlePrizesMap($rootScope.notShuffledMiddlegameprizes);

                            if (vm.middlegameprizes) {

                                var _newCard = {};

                                _newCard.middlePrize = $rootScope.notShuffledMiddlegameprize;

                                if (_newCard.middlePrize) {

                                    newCard = _newCard;

                                    $rootScope.notShuffledMiddlegameprizes = null;
                                    $rootScope.notShuffledMiddlegameprize = null;

                                    validRouterParam = true;
                                    vm.middlegameunlocked = true;
                                }
                            }
                        }
                    }
                }

                if (!validRouterParam) {
                    updateGallery(false);
                    vm.showBooklet = true;
                }

            } else {
                updateGallery(true);
                vm.showBooklet = true;
            }
        }

        function _toMiddlePrizesMap(_cardsList) {
            var _temp = [];
            var _map = [];
            if (_cardsList) {
                for (var i = 0; i < _cardsList.length; i++) {
                    if (_cardsList.hasOwnProperty(i)) {
                        _temp.push(_cardsList[i]);
                        if ((i + 1) % 4 === 0) {
                            _map.push(_temp);
                            _temp = [];
                        }
                    }
                    if (i === 9) {
                        break;
                    }
                }
            }
            $log.debug("[Booklet][_toMiddlePrizesMap]: parsed to a map");
            return _map;
        }

        function shakeCardAction(shakeCard) {
            vm.shakeCard = shakeCard;
            vm.showWinCard = true;
            vm.showBooklet = true;

            if (vm.shakeCard.type == appConfig.cardTypes.collection && !vm.shakeCard.duplicated) {
                $timeout(function () {
                }, 500);
            } else if (vm.shakeCard.type == appConfig.cardTypes.gold) {
                $rootScope.mcareIntegration({
                    'playSound': true,
                    'action': 'goldCard'
                });
            } else if (vm.shakeCard.type == appConfig.cardTypes.joker) {
                $rootScope.mcareIntegration({
                    'playSound': true,
                    'action': 'winPrize'
                });
            }
        }

        function galleryError(error) {
            $log.error("[BookletController][galleryError]: NOT YET IMPLEMENTED");
        }

        function gallerySuccess(result) {
            $log.debug("[BookletController][gallerySuccess]");
            vm.gallery = result;
            vm.galleryCardsCount(vm.gallery);
            _hideCompletionOverlay();
        }

        function _getCardToDetailById(cardId) {
            if (_cardsForDetail) {
                for (var index = 0; index < _cardsForDetail.length; index++) {
                    if (_cardsForDetail[index].id === cardId) {

                        return _cardsForDetail[index];
                    }
                }
            }
            return null;
        }

        function getCardsForSwipping(cardId) {
            $log.debug("[BookletController][getCardsForSwipping]: Started");
            var _currCard;

            var _cards = [];

            for (var index in vm.gallery.cards) {
                if (vm.gallery.cards.hasOwnProperty(index)) {
                    var _rows = JSON.parse(angular.toJson(vm.gallery.cards[index]));

                    for (var indx in _rows) {
                        if (_rows.hasOwnProperty(indx)) {
                            var _card = _rows[indx];
                            if (_card.inCollection === true && _card.type !== appConfig.cardTypes.gold) {
                                _cards.push(_card);
                            }
                            _cardsForDetail.push(_card)
                        }
                    }
                }
            }

            vm.cards = _cards;
        }

        function getGoldCardsForSwipping(cardId) {
            $log.debug("[BookletController][getGoldCardsForSwipping]: Started");
            var _currCard;

            var _cards = [];

            for (var index in vm.gallery.cards) {
                if (vm.gallery.cards.hasOwnProperty(index)) {
                    var _rows = JSON.parse(angular.toJson(vm.gallery.cards[index]));

                    for (var indx in _rows) {
                        if (_rows.hasOwnProperty(indx)) {
                            var _card = _rows[indx];
                            if (_card.inCollection === true && _card.type === appConfig.cardTypes.gold) {
                                _cards.push(_card);
                            }
                            //gold cards have duplicated close button https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-378
                            _card.hideParentCloseButton = true;
                            _cardsForDetail.push(_card)
                        }
                    }
                }
            }

            vm.goldCards = _cards;
        }

        function getCardDetailIndexById(cardId) {
            if (vm.cards) {
                for (var index = 0; index < vm.cards.length; index++) {
                    if (vm.cards[index].id === cardId) {

                        return index;
                    }
                }
            }
        }

        function getGoldCardDetailIndexById(cardId) {
            if (vm.goldCards) {
                for (var index = 0; index < vm.goldCards.length; index++) {
                    if (vm.goldCards[index].id === cardId) {

                        return index;
                    }
                }
            }
        }

        function _getCardDetailByPosition(index) {
            var _card = null;
            if (vm.cards && index !== null && index < vm.cards.length) {
                _card = vm.cards[index];
            }
            return _card;
        }

        function _getGoldCardDetailByPosition(index) {
            var _card = null;
            if (vm.goldCards && index !== null && index < vm.goldCards.length) {
                _card = vm.goldCards[index];
            }
            return _card;
        }

        function _getMiddleGamePrizes() {
            $log.debug("[BookletController][_getMiddleGamePrizes]");
            vm.middlegameunlocked = true;
            vm.middlegameprizes = newCard.middlePrizes;
        }

        function _hideCompletionOverlay() {
            var deferred = $q.defer();

            $timeout(function () {
                $log.debug("[BookletController][_hideCompletionOverlay]");
                vm.showoverlay = false;

                for (var row = 0; row < vm.gallery.getCards().length; row++) {
                    if (vm.gallery.cards.hasOwnProperty(row)) {
                        for (var indx = 0; indx < 6; indx++) {
                            vm.gallery.cards[row][indx].animate = false;
                        }
                    }
                }
                deferred.resolve(true);
            }, 500);
            return deferred.promise;
        }

        function _hidePartyAnimation() {
            var deferred = $q.defer();
            $timeout(function () {
                vm.showparty = false;
                deferred.resolve(true);
            }, 2000);

            return deferred.promise
        }

        function _getGoldCards() {

            var newGoldCards = [];

            for (var index = 0; index < vm.goldCards.length; index++) {

                var _goldCard = vm.goldCards[index];

                if (_goldCard.inCollection === true && _goldCard.redeemActive === true && _goldCard.prize && _goldCard.hasCategoryPrize) {
                    $log.debug("[BookletController][_redeemPrizeGoldCard]: Category has prize ", _goldCard.prize);
                    _goldCard.type = "JOKER";
                    _goldCard.showRewardForm = true;
                }
                _goldCard.hideParentCloseButton = true;

                newGoldCards.push(_goldCard);
            }

            return newGoldCards;
        }

        function _redeemPrize(category) {
            $log.debug("[BookletController][_redeemPrize]: Redeeming prize for category " + category);
            if (category && category >= 0) {
                var _card = vm.gallery.cards[0][category - 1];

                if (_card.inCollection === true && _card.redeemActive === true && _card.prize && _card.hasCategoryPrize) {
                    $log.debug("[BookletController][_redeemPrize]: Category has prize ", _card.prize);

                    _showWinPrize(_card.prize);
                } else {
                    $log.debug("[BookletController][_redeemPrize]: Prize cannot be REDEEMED " + _card.prize);
                }
            }
        }

        function _redeemPrize_Card(card) {

            $log.debug("[BookletController][_redeemPrize_Card]: Redeeming prize for category " + card.category);

            if (card.type === appConfig.cardTypes.gold) {
                getGoldCardsForSwipping(card.id);
                return showGoldCardDetail(card.id);

            } else if (card.inCollection === true) {
                getCardsForSwipping(card.id);
                return showCardDetail(card.id);
            }
        }

        var _isElementInViewport = function (element) {
            var rect = element.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= ($window.innerHeight || doc.documentElement.clientHeight) &&
                rect.right <= ($window.innerWidth || doc.documentElement.clientWidth)
            );
        };

        function _scrolltoCard(_position) {
            var positionId = "position_" + _position;
            var position = doc.getElementById(positionId);
            if (!_isElementInViewport(position)) {
                var scrollAmount = (position.getBoundingClientRect().top + position.getBoundingClientRect().height) - $window.innerHeight;
                doc.getElementById("bookletContainer").scrollTop = scrollAmount + position.getBoundingClientRect().height;
            }
        }

        function showCardDetail(cardId) {
            $log.debug("[BookletController][showCardDetail] ID ", cardId);

            var _card = null;
            vm.carouselIndex = getCardDetailIndexById(cardId);
            vm.showDetailView = true;
            $rootScope.canSwipe = false;

            cardDetailViewportHeight();

        }

        function showGoldCardDetail(cardId) {

            var _card = _getCardToDetailById(cardId);

            if (_card) {
                if (_card.inCollection === true) {
                    vm.shakeCard = _card;
                    vm.showGoldCardInCarousel = true;
                    vm.goldCarouselIndex = getGoldCardDetailIndexById(cardId);
                    _card = _getGoldCardDetailByPosition(vm.goldCarouselIndex);
                    vm.goldCurrcard = _card;
                    $rootScope.canSwipe = false;

                } else {
                    $log.debug("[BookletController][showCardDetail]: CARD not in collection");
                }
            } else {
                $log.debug("[BookletController][showCardDetail]: CARD ID ", cardId, "cannot be detailled!");
            }

        }

        function showCategoryDetail(categoryId) {

            var _category;
            for (var index in vm.gallery.categories) {
                if (vm.gallery.categories.hasOwnProperty(index)) {
                    if (vm.gallery.categories[index].id === categoryId) {
                        _category = vm.gallery.categories[index];
                        break;
                    }
                }
            }

            if (_category && _category.description) {
                ngDialog.open({
                    template: '<div id="categoryDetailText">' + _category.description + '</div>',
                    plain: true,
                    width: "80%",
                    overlay: true
                });
            }
        }

        function _showWinPrize(_prize) {
            _hideCompletionOverlay().then(function () {
                $log.debug("[_showWinPrize]: show prize won");
                vm.showWinPrize = true;
                vm.prize = {
                    "prize": _prize,
                    "type": "JOKER"
                };
            });
        }

        function _shuffle() {
            $log.debug("[BookletController][_shuffle]");

            CacheService.getBooklet(true).then(function (result) {
                vm.gallery = result;
                BookletService.shuffle(vm.gallery.deckimage, newCard.middlePrize.image).then(function () {
                    vm.canPickMiddlePrize = true;
                });
            }, galleryError);
        }

        function _middlePrizeCardClick(cardPrize) {
            if (vm.canPickMiddlePrize) {
                vm.middlegameunlocked = false;
                _showWinPrize(newCard.middlePrize);

                DataService.shuffleMiddlePrizeCards(newCard.middlePrize.userPrizeId).then(function (success) {
                    $log.debug("[BookletController][_shuffle] ShuffleMiddlePrizeCards with success [userPrizeId] " + newCard.middlePrize.userPrizeId);
                }, function (error) {
                    $log.error("[BookletController][_shuffle] Error on ShuffleMiddlePrizeCards [userPrizeId] " + newCard.middlePrize.userPrizeId);
                });

            }
        }

        function swipe(currentIndex, direction) {
            $log.debug("[BookletController][swipe]: INDEX ", currentIndex, " DIRECTION ", direction);
            vm.swipeanimate = !vm.swipeanimate;

            if ($rootScope.caroucelIsLocked === false) {
                if (direction === 'R') {
                    vm.carouselIndex = currentIndex + 1;
                 //   resetZoom(currentIndex);
                } else {
                    vm.carouselIndex = currentIndex - 1;
                  //  resetZoom(currentIndex);
                }
            }
        }

        function goldSwipe(currentIndex, direction) {
            $log.debug("[BookletController][goldSwipe]: INDEX ", currentIndex, " DIRECTION ", direction);
            vm.goldSwipeanimate = !vm.goldSwipeanimate;

            if (direction === 'R') {
                vm.goldCarouselIndex = currentIndex + 1;
            } else {
                vm.goldCarouselIndex = currentIndex - 1;
            }

            var _card = _getGoldCardDetailByPosition(vm.goldCarouselIndex);

            vm.goldCurrcard = _card;
        }

        function _verifyAndTriggerPrizes() {
            $log.debug("[BookletController][_verifyAndTriggerPrizes]");
            $timeout(function () {
                if (newCard && !_prizesValidationActive) {

                    if (_middlePrizeShown == false) {
                        _prizesValidationActive = true;
                        $log.debug("[BookletController][_verifyAndTriggerPrizes]: will check for MIDDLE PRIZES");

                        _checkMiddlePrizeCompleted(newCard).then(function (success) {
                            if (success === true) {
                                $log.debug("[BookletController][_verifyAndTriggerPrizes]: MIDDLE PRIZE COMPLETED - showing middle game");
                                _getMiddleGamePrizes();
                            } else {
                                _prizesValidationActive = false;
                                _verifyAndTriggerPrizes();
                            }
                        });

                    } else if (_columnCompletedShown === false) {
                        _prizesValidationActive = true;
                        $log.debug("[BookletController][_verifyAndTriggerPrizes]: will check for COLUMN PRIZE");

                        _checkColumnCompleted(newCard).then(function (success) {
                            if (success === true) {
                                $log.debug("[BookletController][_verifyAndTriggerPrizes]: COLUMN COMPLETED - showing prize");

                                _showWinPrize(vm.shakeCard.prize);
                            } else {
                                _prizesValidationActive = false;
                                _verifyAndTriggerPrizes();
                            }
                        });

                    } else if (_bookletCompletedShown === false) {
                        _prizesValidationActive = true;
                        $log.debug("[BookletController][_verifyAndTriggerPrizes]: will check for FULL PRIZE");

                        _checkFullCollectionCompleted(newCard).then(function (success) {

                            if (success === true) {
                                $log.debug("[BookletController][_verifyAndTriggerPrizes]: COLLECTION COMPLETED - showing prize");

                                _hideCompletionOverlay().then(function () {
                                    vm.showparty = true;
                                    _hidePartyAnimation().then(function () {
                                        _showWinPrize(newCard.fullPrize);
                                        newCard = null;
                                        vm.shakeCard = null;
                                    });
                                });
                            }
                        });
                    } else {
                        $log.debug("[BookletController][_verifyAndTriggerPrizes]: NOTHING to show");
                    }
                }
            }, 350);
        }

        function continueExchange() {
            vm.canContinueExchange = false;
            vm.onAnimationEndCanContinueExchange = false;
            $rootScope.exchangeFriend = vm.exchangeFriend;
            $location.path(appConfig.routes.exchangecardfriend);
        }

        function closeContinueExchangeOverlay() {
            vm.canContinueExchange = false;
            vm.onAnimationEndCanContinueExchange = false;
            vm.exchangeFriend = null;
            $rootScope.exchangeFriend = null;
        }

        $scope.$on('$destroy', function () {
            submitCloseShakeCard();
            submitCardRedeemAction();
            prizeAnswerWrong();
            submitUpdateBooklet();
        });

        init();

        //Toggle between states
        $scope.showZoomCollection = false;
        $scope.toogleZoomCollection = function () {
            $scope.showZoomCollection = !$scope.showZoomCollection;
        };

        //Click to zoom in/out and see the whole collection
        function viewAllCollection() {

            var collectionBody = angular.element(doc.getElementById("bookletBody"));
            var bookletContainer = angular.element(doc.getElementById("bookletContainer"));
            var btnViewCollection = angular.element(doc.getElementById("view-all-collection"));
            var bookletRowHeader = angular.element(doc.getElementById("booklet-row-header"));
            var bookletCategory = angular.element(doc.getElementById("bookletCategory"));

            // Height of elements in zoom page
            var viewportHeight = doc.getElementById("bookletContainer").clientHeight;
            var closeBtnHeight = doc.getElementById("closeBtImage").clientHeight;

            //Available Height - we need to subtract the close button to the viewport height
            var availableHeight = parseInt(viewportHeight - closeBtnHeight);

            // Calculate ratio for maximize height in zoom collection
            // var ratio - for the SCALE css property
            var ratio = (availableHeight / $scope.collectionHeight) + 0.03;

            if (!$scope.showZoomCollection) {
                $scope.toogleZoomCollection();

                collectionBody.css({
                    "transform-origin": "top center",
                    "transform": "scale(" + ratio + ")",
                    "position": "absolute",
                    "top": "8%",
                    "left": "-12.5%",
                    "right": "12.5%",
                    "margin": "auto",
                    "overflow": "unset"
                });

                bookletCategory.css({
                    "display": "none"
                });

                bookletContainer.css({
                    "background": "rgba(0, 0, 0, 1)",
                    "overflow-y": "hidden"
                });

                btnViewCollection.css({
                    "display": "none"
                });

                bookletRowHeader.css({
                    "display": "none"
                });

                //Force scrool page to top
                bookletContainer[0].scrollTop = 0;

            }
            else {
                $scope.toogleZoomCollection();

                collectionBody.css({
                    "transform": "unset",
                    "overflow": "auto hidden",
                    "position": "relative",
                    "top": "unset",
                    "left": "unset",
                    "right": "unset",
                });

                bookletCategory.css({
                    "display": "inline-block"
                });
                bookletContainer.css({
                    "background": "none",
                    "overflow-y": "visible"
                });

                btnViewCollection.css({
                    "position": "relative",
                    "top": "auto",
                    "display": "block"
                });

                bookletRowHeader.css({
                    "display": "inline-block"
                });
            }
        }

        //returns the total number of cards in the booklet array
        function galleryCardsCount(gallery){
            var totalCount = 0;

            for (var i = 0; i < 11; i++) {
                totalCount += gallery.cards[i].length;
            }
            $scope.totalCount = totalCount;
        }

        // Activate "View All Collection" button,
        // only when all images from the gallery are loaded
        var contador = 0;
        $scope.showZoomButton = false;
        function verifyAllImageLoading() {
            var totalImages = $scope.totalCount;
            contador++;
            if (contador === totalImages) {
                //Show button for Zoom All Colection
                $scope.showZoomButton = true;

                //Returns the collection height
                if ($scope.collectionReady) {
                    $timeout(function () {
                        var elem = document.getElementById("bookletBody");
                        var rect = elem.getBoundingClientRect();

                        $scope.collectionHeight = parseInt(rect.height);

                    }, 20);
                }
            }
        }

        function resetZoom(index) {
            var values = {
                "index": index
            };
            $scope.$broadcast('resetZoom', values);
            //console.log('Reset Zoom in booklet controller');
        }

        var disableCarousel = function () {
            $timeout(function () {
                $rootScope.caroucelIsLocked = true;
            });
        };

        var enableCarousel = function () {
            $timeout(function () {
                $rootScope.caroucelIsLocked = false;
            });
        };

        /*
        * @TODO - Remove this debug
        * */
        $scope.$on('imageScale', function (e, args) {
           $rootScope.scale = args.scale;
        });

        $scope.$on('lockCardFlip', function (e) {
            $rootScope.canFlipCard = false;
        });
        $scope.$on('unlockCardFlip', function (e) {
            $rootScope.canFlipCard = true;
        });
        $scope.$on('caroucelIsLocked', function (e) {
            disableCarousel();
        });
        $scope.$on('caroucelIsUnlocked', function (e) {
            enableCarousel();
        });
    }
})();

(function () {
    'use strict';

    angular.module("booklet.service", []).factory("BookletService", BookletService);

    BookletService.$inject = ["$animateCss", "$document", "$log", "$q"];

    function BookletService($animateCss, $document, $log, $q) {
        var _cardClass = "middle-game-card-img";
        var _deckImage = null;
        var _doc = $document[0];
        var i = 0;
        var _prizeImage = null;
        var _prizes = null;

        var bookletService = {
            shuffle: _shuffle
        };

        return bookletService;

        function _flipToCover() {
            $log.debug("[BookletService][_flipToCover]");
            //Hides button
            angular.element(_doc.getElementById("cardsShuffleButton")).addClass("cards-shufflebutton-disappearing");

            angular.element(_doc.getElementById("middlegameTexts")).addClass("card-prize-texts-disappearing");

            for (i = 0; i < _prizes.length; i++) {
                if (_prizes.hasOwnProperty(i)) {
                    var _prize = angular.element(_prizes[i]);

                    if (i !== _prizes.length - 1) {
                        $animateCss(_prize, {
                            easing: 'linear',
                            from: {
                                "transform": 'rotateY(90deg)',
                                "background-image": 'url(' + _deckImage + ')'
                            },
                            to: {
                                "transform": 'rotateY(0deg)',
                                "background-image": 'url(' + _deckImage + ')'
                            },
                            duration: 0.3
                        }).start();
                    } else {
                        return $animateCss(_prize, {
                            easing: 'linear',
                            from: {
                                "transform": 'rotateY(90deg)',
                                "background-image": 'url(' + _deckImage + ')'
                            },
                            to: {
                                "transform": 'rotateY(0deg)',
                                "background-image": 'url(' + _deckImage + ')'
                            },
                            duration: 0.3
                        }).start();
                    }
                }
            }
        }

        function _flipToSide() {
            $log.debug("[BookletService][_flipToSide]");

            for (i = 0; i < _prizes.length; i++) {
                if (_prizes.hasOwnProperty(i)) {
                    var _prize = angular.element(_prizes[i]);

                    if (i !== _prizes.length - 1) {
                        $animateCss(_prize, {
                            easing: 'linear',
                            from: {
                                "transform": 'rotateY(0deg)'
                                // "background-image": 'url(' + _cardImage + ')'
                            },
                            to: {
                                "transform": 'rotateY(90deg)'
                            },
                            duration: 0.3
                        }).start();
                    } else {
                        return $animateCss(_prize, {
                            easing: 'linear',
                            from: {
                                "transform": 'rotateY(0deg)'
                            },
                            to: {
                                "transform": 'rotateY(90deg)'
                            },
                            duration: 0.3
                        }).start();
                    }
                }
            }
        }


        function _joinInMidle() {
            $log.debug("[BookletService][_joinInMidle]");
            var _containerRect = _doc.getElementById("middlegameCardsContainer").getBoundingClientRect();
            var _centerX = _containerRect.left + _containerRect.width / 2;
            var _centerY = _containerRect.top + _containerRect.height / 2;

            for (i = 0; i < _prizes.length; i++) {
                if (_prizes.hasOwnProperty(i)) {
                    var _prize = angular.element(_prizes[i]);
                    var _cardRect = _prizes[i].getBoundingClientRect();

                    var _centerCardX = _cardRect.left + _cardRect.width / 2;
                    var _centerCardY = _cardRect.top + _cardRect.height / 2;

                    if (i !== _prizes.length - 1) {
                        $animateCss(_prize, {
                            easing: 'linear',
                            from: {
                                "transform": "translateX(0px) translateY(0px) scale(1)"
                            },
                            to: {
                                "transform": "translateX(" + (_centerX - _centerCardX) + "px) translateY(" + (_centerY - _centerCardY) + "px) scale(1.8)"
                            },
                            delay: 0.5,
                            duration: 0.3
                        }).start();
                    } else {
                        return $animateCss(_prize, {
                            easing: 'linear',
                            from: {
                                "transform": "translateX(0px) translateY(0px)"
                            },
                            to: {
                                "transform": "translateX(" + (_centerX - _centerCardX) + "px) translateY(" + (_centerY - _centerCardY) + "px) scale(1.8)"
                            },
                            delay: 0.5,
                            duration: 0.3
                        }).start();
                    }
                }
            }
        }

        function _invertJoinInMidle() {
            $log.debug("[BookletService][_invertJoinInMidle]");
            var _containerRect = _doc.getElementById("middlegameCardsContainer").getBoundingClientRect();
            var _centerX = _containerRect.left + _containerRect.width / 2;
            var _centerY = _containerRect.top + _containerRect.height / 2;

            for (i = 0; i < _prizes.length; i++) {
                if (_prizes.hasOwnProperty(i)) {
                    var _prize = angular.element(_prizes[i]);
                    var _cardRect = _prizes[i].getBoundingClientRect();

                    var _centerCardX = _cardRect.left + _cardRect.width / 2;
                    var _centerCardY = _cardRect.top + _cardRect.height / 2;

                    if (i !== _prizes.length - 1) {
                        $animateCss(_prize, {
                            easing: 'linear',
                            to: {
                                "transform": "translateX(0px) translateY(0px) scale(1)"
                            },
                            delay: 0.1,
                            duration: 0.3
                        }).start();
                    } else {
                        return $animateCss(_prize, {
                            easing: 'linear',
                            to: {
                                "transform": "translateX(0px) translateY(0px)"
                            },
                            delay: 0.1,
                            duration: 0.3
                        }).start();
                    }
                }
            }
        }

        function _shuffle(_coverImage, _wonPrizeImage) {
            _deckImage = _coverImage;
            _prizeImage = _wonPrizeImage;
            $log.debug("[BookletService][_shuffle]: SHUFFLING cards");
            var deferred = $q.defer();
            //Get all prizes
            _prizes = _doc.getElementsByClassName(_cardClass);

            _flipToSide().done(function () {

                _flipToCover().done(function () {

                    _joinInMidle().done(function () {

                        _invertJoinInMidle().done(function () {
                            deferred.resolve(true);
                        });
                    });
                });
            });
            return deferred.promise;
        }
    }
})();

(function () {
    'use strict';

    angular.module('card.directive', []).directive('card', CardDirective).controller("CardController", CardController);

    /** @ngInject */
    function CardDirective() {
        var directive = {
            restrict: 'E',
            templateUrl: function (element, attrs) {
                return 'app/card/card.template.html'
            },
            scope: {
                winCard: '=',
                isGoldCard: '=',
                goldCarouselIndex: '=',
                goldCardFromBooklet: '='
            },
            controller: CardController,
            controllerAs: 'wc'
        };

        return directive;
    }

    CardController.$inject = ["$scope", "$timeout", '$document', '$animateCss', 'appConfig', 'DataService', '$rootScope', '$location', '$log', '$interval', '$window', '$translate'];

    /** @ngInject */
    function CardController($scope, $timeout, $document, $animateCss, appConfig, DataService, $rootScope, $location, $log, $interval, $window, $translate) {

        $rootScope.canSwipe = false;

        var winCard = $scope.winCard;
        var isGoldCard = $scope.isGoldCard;
        var goldCards = $scope.$parent.booklet ? $scope.$parent.booklet.goldCards : null;

        var goldCarouselIndex = $scope.goldCarouselIndex;
        var goldCardFromBooklet = $scope.goldCardFromBooklet;

        var doc = $document[0];

        if (isGoldCard && isGoldCard === true && goldCardFromBooklet) {
            winCard = goldCardFromBooklet; //goldCards[goldCarouselIndex];
        }

        var vm = this;

        vm.cardExchageEnum = {
            "keepOldCard": 1,
            "keepNewCard": 2,
            "goBack": 3,
            "acceptSelection": 4
        };

        vm.goldCarouselIndex = goldCarouselIndex;
        vm.showMainCard = true;
        vm.showExchangeScreen = null;
        vm.showConfirmationScreen = null;
        vm.doExchangeFinalAnimation = null;
        vm.showCardName = null;
        vm.showCard = null;
        vm.showCardBt = false;
        vm.showBgAnimation = null;
        vm.showBg = true;
        vm.showCloseBt = null;
        vm.isPrizeInfoOpen = null;
        vm.showRewardForm = false;
        vm.closeCardContent = false;
        vm.showPrizeAppealText = false;
        vm.isGoldCard = isGoldCard;
        vm.prizeAppealTextKey = "";
        vm.cardTypes = appConfig.cardTypes;
        vm.cardType = winCard.type;
        vm.enableButton = true;
        vm.isGuessCardNameActive = appConfig.global.isGuessCardNameActive; // Flag that activate the GuessCardName functionality
        vm.cssClass = false;
        $scope.stopped = true;
        vm.showAnswerNamePage = false;
        vm.continuePlaceCardInBooklet = continuePlaceCardInBooklet;
        vm.firstCardBonus = false;
        vm.guessNameRetryPage = false;
        vm.indexOfCorrectAnswer = -1;
        vm.indexOfSelectedAnswer = -1;
        vm.showCounter = false;

        //https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-469
        //if gold card with duplicated, the duplicated shall be considered te received card and the prize, shall be considered to be the duplicated
        if (vm.cardType == vm.cardTypes.collection) {
            vm.card = winCard.card;
            vm.prizeDescription = null;
        } else {
            if (winCard.duplicatedPrize) {
                vm.card = winCard.duplicatedPrize;
                vm.duplicatedPrize = winCard.prize;
            } else {
                vm.card = winCard.prize;
                vm.duplicatedPrize = winCard.duplicatedPrize;
            }

            vm.prizeDescription = vm.card ? vm.card.description : null;
        }

        if (vm.prizeDescription) {
            $rootScope.canSwipeUp = true;
        }

        vm.showWinShake = null;

        vm.exchangeSelectedCard = null;
        var exchangeDiscardedCard;
        var initialAnimationRunning = true;

        vm.showPrizeAppealText = false;

        vm.btText = "colar na caderneta";
        if (vm.cardType == vm.cardTypes.joker) {
            vm.showCloseBt = true && vm.card.autoReclaim !== "true";
            vm.btText = "quero!";
        } else if (vm.cardType == vm.cardTypes.gold && vm.duplicatedPrize) {
            vm.showCloseBt = false;
            vm.btText = "ver opções";
        } else if (vm.cardType == vm.cardTypes.gold && winCard.prize && winCard.id) { //Detail Category Prize
            vm.showCloseBt = true && vm.card.autoReclaim !== "true";
            vm.btText = "";
            if (vm.card.userPrizeStatus === "REDEEM_CONDITIONAL") {
                vm.prizeAppealTextKey = "text.goldcard.detail.appeal";
                vm.showPrizeAppealText = true;
            } else if (vm.card.userPrizeStatus === "REDEEMED" || vm.card.userPrizeStatus === "REDEEM_PENDING") {
                vm.prizeAppealTextKey = "text.goldcard.detail.redeemed";
                vm.showPrizeAppealText = true;
            }

        } else if (vm.cardType == vm.cardTypes.collection) {
            vm.showCloseBt = false;
        } else {
            vm.showCloseBt = true;
        }

        vm.showStripe = null;
        vm.showTopLeft = null;
        vm.showTopRight = null;
        vm.showBottomLeft = null;
        vm.showBottomRight = null;

        vm.showCloseBt = vm.showCloseBt && !winCard.hideParentCloseButton;
        var auxTime = 100;
        vm.showCardBt = false;
        $timeout(function () {
            vm.showCard = true;
            $timeout(function () {
                vm.showStripe = true;
                vm.showCardName = true;

                $timeout(function () {
                    vm.showTopLeft = true;
                    $timeout(function () {
                        vm.showTopRight = true;
                        $timeout(function () {
                            vm.showBottomRight = true;
                            $timeout(function () {
                                vm.showBottomLeft = true;
                                $timeout(function () {
                                    vm.showCardBt = true;
                                    vm.showBgAnimation = true;
                                    vm.showCloseBt = vm.showCloseBt && vm.showBgAnimation;
                                    $timeout(function () {
                                        angular.element(doc.getElementById("bgCardTopLeft")).removeClass("animated slideInLeft").addClass("leftRightAnimation");
                                        angular.element(doc.getElementById("bgCardTopRight")).removeClass("animated slideInRight").addClass("rightLeftAnimation");
                                        angular.element(doc.getElementById("bgCardBottomLeft")).removeClass("animated slideInLeft").addClass("leftRightAnimation");
                                        angular.element(doc.getElementById("bgCardBottomRight")).removeClass("animated slideInRight").addClass("rightLeftAnimation");


                                        initialAnimationRunning = false;


                                    }, 700);

                                }, auxTime);
                            }, auxTime);
                        }, auxTime);
                    }, auxTime);
                }, auxTime);
            }, 400);
        }, 100);


        vm.goHome = function () {
            $location.path(appConfig.routes.landingPage);
        };

        vm.closeCard = function (winShake) {

            $rootScope.$broadcast('closeCard');

            var currentPath = $location.path();
            if (winShake) {
                vm.closeCardContent = true;
                vm.showWinShake = true;
                return;
            }
            vm.closeCardContent = true;
            if (vm.showWinShake) {
                vm.showWinShake = false;
            }
            $timeout(function () {
                if (currentPath === "/booklet/middleprize") {
                    $location.path(appConfig.routes.booklet);
                } else {
                    $scope.$emit(appConfig.events.cardClose);
                }
            }, 500);
            $rootScope.canSwipe = true;
        };

        //https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-626
        var _unregisterInterval;


        vm.doAction = function (isGoldCard) {
            var _isGoldCard = isGoldCard;
            if (vm.cardType == vm.cardTypes.joker) {
                vm.showRewardForm = true;

                if ($scope.$parent.booklet) {
                    $scope.$parent.booklet.queroOpened = true;
                    $scope.$parent.booklet.queroOpenedCard = vm.card;
                }

                $timeout(function () {
                    if (isGoldCard && isGoldCard === true) {
                        angular.element(doc.getElementById("winCardContent")).remove();

                    } else {
                        angular.element(doc.getElementById("winCardContent")).remove();
                    }
                }, 1000);
            } else if (vm.duplicatedPrize !== null && vm.cardType == vm.cardTypes.gold) {
                vm.showCardBt = false;
                vm.showCardName = false;
                vm.showBgAnimation = false;

                $timeout(function () {
                    angular.element(doc.getElementById("bgCardTopLeft")).removeClass("leftRightAnimation").addClass("animated slideOutLeft");
                    angular.element(doc.getElementById("bgCardTopRight")).removeClass("rightLeftAnimation").addClass("animated slideOutRight");
                    angular.element(doc.getElementById("bgCardBottomLeft")).removeClass("leftRightAnimation").addClass("animated slideOutLeft");
                    angular.element(doc.getElementById("bgCardBottomRight")).removeClass("rightLeftAnimation").addClass("animated slideOutRight");

                    $timeout(function () {
                        vm.showStripe = false;
                        vm.showExchangeScreen = true;
                        vm.showBg = false;
                        $timeout(function () {

                            var position = doc.getElementById("goldCardExchangeNewImg");
                            var positionElem = angular.element(position);

                            var card = doc.getElementById("winCardCard");
                            var cardElem = angular.element(card);

                            var bodyRect = doc.body.getBoundingClientRect(),
                                elemRect = card.getBoundingClientRect(),
                                cardOffsetTop = elemRect.top,
                                cardOffsetLeft = elemRect.left,
                                cardWidth = cardElem.prop("offsetWidth"),
                                cardHeight = cardElem.prop("offsetHeight");

                            cardElem.css("width", cardWidth + "px")
                                .css("height", cardHeight + "px")
                                .css("top", cardOffsetTop + "px")
                                .css("left", cardOffsetLeft + "px")
                                .css("position", "fixed");

                            var placeCardOnBookletAnimation = $animateCss(cardElem, {
                                easing: 'ease-out',
                                from: {
                                    height: cardElem.css("height"),
                                    width: cardElem.css("width"),
                                    top: cardElem.css("top"),
                                    left: cardElem.css("left")
                                },
                                to: {
                                    height: positionElem.prop("offsetHeight") + "px",
                                    width: positionElem.prop("offsetWidth") + "px",
                                    top: position.getBoundingClientRect().top + "px",
                                    left: position.getBoundingClientRect().left + "px"
                                },
                                duration: 0.4
                            });

                            placeCardOnBookletAnimation.start().then(function () {
                                angular.element(doc.getElementById("goldCardExchangeNewImgURL")).removeClass("invisible");
                                angular.element(doc.getElementById("cardDetailsContainer")).remove();
                                vm.showMainCard = false;
                            });

                        }, 300);
                    }, 200);
                }, 100);
            } else if (_isGoldCard === 'answerPage') {
                vm.showAnswerNamePage = true;
                vm.markListOfResultPage('RESUME');
            } else {

                var windCardImg = $document[0].getElementById("winCardImg");

                if (!windCardImg) {
                    windCardImg = $document[0].getElementById("winCardImgBase64");
                }
                if (windCardImg.complete) { //this tweak is an attempt to overcome the delay which sometimes affects ios devices
                    // https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-626
                    if (_unregisterInterval) {
                        $interval.cancel(_unregisterInterval);
                    }
                    vm.showCardBt = false;
                    vm.showCardBt = false;
                    vm.showCardName = false;
                    vm.showBgAnimation = false;

                    $scope.$emit(appConfig.events.placeContainerShakePosition);

                    $timeout(function () {
                        angular.element(doc.getElementById("bgCardTopLeft")).removeClass("leftRightAnimation").addClass("animated slideOutLeft");
                        angular.element(doc.getElementById("bgCardTopRight")).removeClass("rightLeftAnimation").addClass("animated slideOutRight");
                        angular.element(doc.getElementById("bgCardBottomLeft")).removeClass("leftRightAnimation").addClass("animated slideOutLeft");
                        angular.element(doc.getElementById("bgCardBottomRight")).removeClass("rightLeftAnimation").addClass("animated slideOutRight");

                        $timeout(function () {
                            vm.showStripe = false;

                            $timeout(function () {
                                vm.showBg = false;
                                $scope.$emit(appConfig.events.cardRedeemAction);
                            }, 200);
                        }, 300);
                    }, 100);
                } else {
                    //this tweak is an attempt to overcome the delay which sometimes affects ios devices
                    // https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-626
                    if (!_unregisterInterval) {

                        _unregisterInterval = $interval(function () {
                            vm.doAction(_isGoldCard);
                        }, 200);
                    }
                }
            }

        };

        vm.confirmCardSelection = function (selection) {

            switch (selection) {
                case vm.cardExchageEnum.keepOldCard:
                case vm.cardExchageEnum.keepNewCard:
                    vm.keepOldCard = (selection == vm.cardExchageEnum.keepOldCard);
                    vm.exchangeSelectedCard = (vm.keepOldCard ? vm.duplicatedPrize : vm.card);
                    vm.showExchangeScreen = false;
                    vm.showConfirmationScreen = true;
                    break;
                case vm.cardExchageEnum.goBack:
                    vm.showConfirmationScreen = false;
                    vm.showExchangeScreen = true;

                    $timeout(function () {
                        vm.showConfirmationScreen = null;
                    }, 200);

                    break;
                case vm.cardExchageEnum.acceptSelection:
                    DataService.confirmGoldExchangeCard(vm.exchangeSelectedCard.userPrizeId);
                    //at this point, the duplicated card is the old one
                    if (vm.exchangeSelectedCard.userPrizeId == vm.duplicatedPrize.userPrizeId) {
                        vm.card = vm.duplicatedPrize;
                        vm.closeCard(true);
                    } else {
                        vm.doExchangeFinalAnimation = true;
                        //the new prize has to be set
                        $scope.winCard.prize = vm.card;
                        $timeout(function () {
                            $scope.$emit(appConfig.events.cardRedeemAction);

                        }, 500);
                    }

                    break;
            }

        };

        vm.showPrizeInfo = null;
        var animating = false;
        vm.openPrize = function (isGoldCard) {
            if (!vm.prizeDescription || animating) {
                return;
            }

            animating = true;

            var cardDetails = angular.element(doc.getElementById("cardDetails"));
            var prizeDetails = angular.element(doc.getElementById("prizeDetails"));

            if (isGoldCard && isGoldCard === true) {
                cardDetails = angular.element(doc.getElementById("cardDetails" + vm.goldCarouselIndex));
                prizeDetails = angular.element(doc.getElementById("prizeDetails" + vm.goldCarouselIndex));
            }

            var infoPannelHeight = prizeDetails.prop("offsetHeight");

            vm.showPrizeInfo = !vm.isPrizeInfoOpen;
            var cardAnimation = $animateCss(cardDetails, {
                easing: 'linear',
                // from: {
                //     top:  vm.isPrizeInfoOpen ? (infoPannelHeight * -1) + "px" : "0"
                // },
                to: {

                    top: vm.isPrizeInfoOpen ? "0" : ((infoPannelHeight - 1) * -1) + "px" //'-1' is a tweak to remove a pixel shown in some device [https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-630]
                },
                duration: 0.0
            });

            var infoAnimation = $animateCss(prizeDetails, {
                easing: 'linear',
                // from: {
                //     bottom:  !vm.isPrizeInfoOpen ? (infoPannelHeight * -1) + "px" : "0"
                // },
                to: {
                    bottom: !vm.isPrizeInfoOpen ? "0" : (infoPannelHeight * -1) + "px"
                },
                duration: 0.0
            });

            cardAnimation.start();
            infoAnimation.start().then(function () {
                animating = false;
            });


            var winCardInfo = angular.element(doc.getElementById("winCardMoreInfo"));
            winCardInfo.addClass("fadeOut");
            $timeout(function () {
                winCardInfo.text(vm.isPrizeInfoOpen ? "menos info" : "mais info");
                winCardInfo.removeClass("fadeOut");
                winCardInfo.addClass("fadeIn");
            }, 300);

            vm.isPrizeInfoOpen = !vm.isPrizeInfoOpen;
        };

        /*#region GuessCardName */

        /** Function for Randomize items on an array
         * @param items (array)
         * @return array
         * */
        function getRandom(items) {
            var j, x, i;
            for (i = items.length - 1; i > 0; i--) {
                j = Math.floor(Math.random() * (i + 1));
                x = items[i];
                items[i] = items[j];
                items[j] = x;
            }
            return items;
        }

        function objectValues(obj) {
            var res = [];
            for (var i in obj) {
                if (obj.hasOwnProperty(i)) {
                    res.push(obj[i]);
                }
            }
            return res;
        }

        // MAIN FLAG -  Boolean to validate the showing the Guess Card Name on the view
        vm.showGuessCardName =
            vm.isGuessCardNameActive
            && !vm.duplicatedPrize
            && vm.cardType === 'COLLECTION'
            && vm.cardType !== 'GOLD'
            && !vm.showExchangeScreen
            && !vm.showConfirmationScreen
            && !vm.card.duplicated;

        /**
         * @param card (object) - card
         */
        vm.guessCardName = function (card) {
            //Init
            vm.showCardName = false;
            vm.nameOptions = [];

            // MOCKED CARD NAME object
            var cardNameObj = {
                name: card.name,
                nameWrong1: card.nameWrong1,
                nameWrong2: card.nameWrong2,
                nameWrong3: card.nameWrong3,
            };

            //Put the object Values into the array
            vm.nameOptions = objectValues(cardNameObj);
            //Shuffle Array indexes
            vm.nameOptions = getRandom(vm.nameOptions);
            //Get index of correct answer
            vm.indexOfCorrectAnswer = vm.nameOptions.indexOf(cardNameObj.name);
        };

        //#region Countdown
        vm.initCountDown = function(){
            vm.showCounter = true;
            $scope.counter = 11;
            vm.guessNameCountdown();
        };
        vm.guessNameTimeout = $timeout(vm.guessNameCountdown, 1000);
        vm.guessNameCountdown = function () {
            if ($scope.counter > 0) {
                $scope.counter--;
                vm.guessNameTimeout = $timeout(vm.guessNameCountdown, 1000);
            } else if ($scope.counter === 0) {

                //Run verifyCorrectAnswer when time is over
                vm.selectedOptionName();
                vm.verifyCorrectAnswer('', $scope.counter);

                //Cancel timeout
                $timeout.cancel(vm.guessNameTimeout);
            }
        };
        //#endregion

        //Send selected value to BE
        /*Response enum:
        * CARD_NOT_EXISTS,
        * ALREADY_GUESSED,
        * CARD_NAME_CORRECT,
        * CARD_NAME_WRONG,
        * ERROR;
        * */
        var retryCounter = 0;
        var counter = 0;
        vm.selectedOptionName = function (option, index) {
            $timeout.cancel(vm.guessNameTimeout);
            var timeleft = $scope.counter;

            vm.answerSelected = {
                id: vm.card.id,
                name: option,
                time: timeleft,
                index: index
            };
            counter ++;
            //Send Answer to BE
            if (counter<=1){
                DataService.guessCardName(vm.answerSelected).then(function (response) {

                    vm.dataResponse = response;

                    //First Card Bonus
                    vm.firstCardBonus = response.guessCardNameResult.firstCardBonus;
                    if(vm.firstCardBonus){
                        vm.firstCardBonusPoints = response.guessCardNameResult.points;
                    }

                    vm.verifyCorrectAnswer(vm.dataResponse, timeleft, index);

                    $rootScope.middlePrizes = response.guessCardNameResult.middlePrizes;
                    $rootScope.middlePrize = response.guessCardNameResult.middlePrize;

                }, function (error) {

                    //If send response FAIL
                    if(retryCounter < 3){

                        //Lock Selection
                        vm.freezeOptions(vm.answerSelected.index, '');

                        //Show RETRY Page
                        vm.guessNameRetryPage = true;
                        //Mark the selected option on RETRY page
                        vm.markListOfResultPage('RETRY');
                    }
                });
            }
        };

        vm.imgBase64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOYAAAA9CAYAAAC5kxVXAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA4ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDoyMmRlMzg1My1hZTU0LTQxY2ItOTJkZS00MGM4YThiODFjZTAiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MzFFMTgwQTQ1QTNCMTFFOTg5NENFMkFDOEZBNDg1MjIiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MzFFMTgwQTM1QTNCMTFFOTg5NENFMkFDOEZBNDg1MjIiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKE1hY2ludG9zaCkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpmZjkxMTlmNi01NDNmLTRiYWMtOGFkMy05ZDA1MTI3NzRjNjIiIHN0UmVmOmRvY3VtZW50SUQ9ImFkb2JlOmRvY2lkOnBob3Rvc2hvcDpmNzc3NGI1MC0zZjVmLTU2NDEtOTdmZi1jNWNhYTM3MmEyMjIiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7xeUyDAAANe0lEQVR42uydCZSVZR3G3zsjuwwgbgg2oIYUYpCAhIomoJkRiSwunaQ0U1xyS5ZKcCvwVJJFSYcMooRKTLIyAg1BCyjMYRMVBJcBRjDWmUEYZnqf8/2+cz8us9yZubN88n/O+Z+5c+/7Lfd89/me//a+X6KsrMwZDA2ALG8Jb6X8n4j8f9T/KI+x34ehgVCWQsAyI6QR09A4iGmoxJ0wGAxHsWI29ZZjd8pGDcV47fhd1Nd1yqrifJp7a+Ztt7cS3kvdvrW3Jmkc66C3AxHF/pDXO7xtP9qIme1trLcbvLWIBPuGxokW9exJJar4vAm/of0V3CwSEDedc9Zv7xD7SUB0B0Ef9/ZgZEzD3iHrISt7i7ef2u/dEAPotzrTW1Ga40/3doq317x9UA0vI1HV2Lq+M3b0Ns6utyEm+Jy38d4u9NbW21nljPmYt/a8HuNtibdrvJ3hrVt9+PeZwO3eOtn1NsQIr3jb622ft/xyPh/o7a/eWnmb7u1Sb48RAvTy1iaNY1SprHXpynb39hJ3HoOhsaPQ23XeTvb2GxckmyRcysMchExKXrb01hvB0dhJkX0MZqy2fc/VIqFUl8T8lbfRdr0NMcEKb0O8vR+JAfthU73lejuJccLFxKLLUvZzrEsmrFLjTu3jHG9PNxQxz/f2gksvhW0wNDRExqGooFTyjyif3NLjvG3y9mmIuAUv8J1K9ne1t1HernSHZ3ibo7rvN1SMOd5IaYgRpqN8Cr3OJgw7gThzE+7sq97Wu6BmOtQdWeZRUqgzr+Xunuft+JQx+9MhZV0p5pe44xgMcYCUb4ALSiUi6Nsom1Tv9y7IwHbwtsvbWrbp6+0/kFhKWuBtmreNLkgO5UDMPIhYUt2TyrRiqtA7wa61IUb4H6STWm6FRFLM53BdVTrpQbzoiDMv4bf+urc93gZ5u9/bRMYUsX0JsWa1kenOH2W1+ti1NsQEb3h72AUJmq64sxdB0AQx4n7e38M2u1HSsBPpKSyKXrizL6YhZIfKU9RMKqaC5HvsWhtihL+5oB1PCvlVFyQsx/FbnultNqr4YSReFCFHRQRIMedg3OEQqoUuT+P4cpGb1rVi3uzt43atDTGKLdVA0N8FXTuf5H0p4wIXJHp6envX263e3mSbJpByMePnQcz3eH8bKlhev+253ta5oIEhPIfSuiRmF2/ftGttiBGKiR/1d0jk/Rz+ysVVUkeNB99HMXPgzFyIeKK3hZB7QxoeaGEKESuc0JEpV/ZOF6SXDYY4QE3na7ytJM5MdSd/ghL+zAWlEcWSHXFxlSx60gWlFMWhP/f2CRdkY7ewr44VHPdABTkYCdtqb78LzyUTxFQnw/V2rQ0xgpRrDoq10CXnaIY4zQUJn/V81gXXdCufy53dhaJ+3tvXIKegemZ5ze8jcXlXV+C5SpGV8c3OlCt7rwsyUAZDXJCH6yl8l7hPKnkVeRKpn8oj81FBEbKNS7bXdYeUYXllEhwYh3s8G25JsIZ5e9QFiaUiV/6Usjchdgmuda2JOZg7gcEQF4hoqlleitvYjHjyOcjxDERR7TIftdQsqV+4oH652AVdQCHU96p5me/jgT6LyraD9HJrV7kgA5zqacot3sT/uyKfta9N548k9+8uaOY1GOKAF1Clfvx2FStu9vYjF5Q3VkDayyGnun6+jTL+ANdWWVuVT9QddNAdnn2VqioRtAA3Wdy4iNhxbSSv05J97+ZmkOA8TuP4p9QmxhxppDTECCW4r6o75kCyhZBO6qblb2a5oG7ZgwTRZNRRCaBRuKa3sA+NPyPlGLtR3tLIjeC+CCnVJN8K5ZVyf93bP10w2fpCl5ypsqWmxGzlbGUCQ/wSPs1RrB2QStWEtojMIhdM2crCxdQMqaXeHmL7P+D2ipyqb05FLT+bxrGVHPoCoWMx7q/UcULE++zjIh1ANY0xtbDW2XatDTFCMaQTEZUBVdeNsqenevuXt5tcMtsqJZvigiVD1ATQCzd3Byq4C3X8FK7oPyLH6Ywir+L/BPsuJq4NyXeApFN/jvHr6MnWhJhK6d5l19kQI0jZTiDek6t5pgta6BK8VpvdRlzKsMFgI7/1AajbBlzSX7pgZYJxjF/CeJFdDQcqn7wRIaaSOEqSFhGThmSV8t5IAko3h3vYr2Laopq4sre5oFZjMMQF2ZhiQ03TCpsDHCrZ1SVngSi5kwdpXkUBtdTIXrzE0S5oTgjREXLtRlE17mVvwwn5HC6yYtIhEbJ+xwWLf0nkvuLtWm93OBb0qq5i6guMsetsiBFEAvWvFpCUOZEET88IGeViajGtnRBKn90NERcxTi7olbjDUr7LUUUpobKsuRB6Lm5qHnGtoBrpFbwWAZ/k9cvEvQWo5sIwUVRdYupk29m1NsQIUjD1tarj5lxIdQ6Jny7EfyJeP+LIJqjflyGelPVkXNR9uKWLIO0FLpgClosXmYfiHleOYocYECHmMpfMxD7hIr2z1SGmTvw6u86GGKEApeuDzSdxE8Z7E4kHFUNejFIKqkdeBXE1HezHLmhCGE6i5zIX1Dnlem4mifMW2+ZA3ugczQkuuWLe1ArO9bCG9urEmAp2m9m1NsQIrSLq9RdIKNKoDDIZct1HjLglZdttJHwGQhplT5WRVXlE68pq1YK+qGR02RGpbTEqG2Irn2uVg/XpnHi6xFQNZqhdZ0PMcCykK0IF5Z7qkQY381mYSe0AmaJQzPk0qlsQIdS/cX/fRQkL2bcaBDpxvHzi1RD7sbSf25NOS14T7hTn23U2xBB5CFCPSsbsIRFzWUTh1Nu6mMSQGg6m8X5T/j8GV3c96iiyqglhhAtKHj1R4Z01Oel0FPNaI6UhhsiHcGooOLWKscqijiGWVB/sXFxZKZyaCLSCgVr0RkLe7oyTUnZm7CTc1e3EnXJ3f1vTk68q+aMDf8uusSFmUCJGyR1lVFu7qh/TIWVTcvMR1E+dOEoaqWavUscD7FOTp7u65Po/u9l/FNNQ1DBpVCNU5cqOJUg2GOICqdwzkFGZVk2ryq3CO5wBEZ/C9VWJJZyTKXJrrdluxKEipqZ4rXMVr8Ze5WP2akNMdTSsIFg2GOJCyjDBku0qfyiuxq3E5RUZB+GG3gWZs8iv5OKuaiqXOnsGsI2Irxkn011yactU/ii+LKrJF6nsLnKHkdIQIyjruY/wbFMFZClBBYuJC6dARvFAiZsfuqAOqWL/MOJIEXA4aroN93QP7q9I16qC8wkzwp3ckY9KqHGMqaX8brRrbYgRwulcZeRGRIxCiKMOHj19Tokclf40SVrdQHqcxxcho9RNS4CoTKKe1jnsV3XQ3ozVNoNRUsWwi13Q8bON42rMrRzjdbZXSUV102czQcxxLtllbzDEAdmQqiW2ATdzGJ+peb0X6tWOpM6MyO88gbqpd1WZV03n0soDar97MBJPrmNMOHVsLUKmvwuJT0vYn0j9gEv2zNbKlVVp5Gq7zoYYErMDarYXd3MgbqkW2FLHjrKl6vbRGj3KqD7ugq6d6RBQ2z/vggcGqa9W5ZFHIGovjqO1fz6DOyzXWbXN1+BSIduLmOqSu4AxZZkg5gSX+WeaGAz1AS3TsRHXMheCrsEt/QDiaPLzMsRHcyuvwLU9Hhc2rNkv4G9bFPK/Lpie9T3GH4io6Jmu/Efuza/pF0nNykr259n1NcQMuyCCEpZaNX0yv+O2EFVx5pKIciqp8yJx6DyUVSqnNjtNpL4fomk+prKryuCqiX0WCqmkTzdUdRZJnlKU8VAmvlBUGXVXGGvX2BAziGRvQSAtcvUKpJEyPkQsuRTyiHyqbRa4ZHO7Zp2oRNIaVZSruhx3VuTtgXt8EiR3xKXbIKXQn8TTmkx9qSgxR7ugW95giBOUZNlJckeu5kHcVtUmtxNLtiB+XML7E4k12xADajrjTRBcS1m+DdGuZ0w4vStEaikmz9WwXllVjKm7x912jQ0xRFNc0VBoRMJOxIGbScAshXDq2FH9Uc0EZ+HWqllAJZAR7GNWhKBK5KihQN0+jxK3loedKHfGifkNd+QamQZDnDAHpQuJci9kURzZhdhzEASTeqqxXaWPmSRyVkX2pcnMd6KW81DT3pH91zmyuHNYM4EhzjhEzFdCAkbxokogWpfnMcg4iBhQfbTKvIZr8PzZBZnWlZH9haURJXqycYnX1ecXyuLuYKveGeKMLBTudEim2PAl8iaHiP/U9TMF5ZM7q0ceKOGpBoBluLlCZxfUIBWvXuKSS07W+xca6DL7yHeDob4RNqtr0eRpeIH5EEvK+QRjlD1dTQyqJgGVWN7BrQ05INXVHOTZrpYzRGpLTPnQpXZtDR8BSAE1OVmTL5R1Vbb1NtxQ9bCOd8HCWyKjmgLUmqcSyPIIB/Lr220tD8pi3YBcj3CHL7NnMDQmqItHLXUtXfmdaaXEjYojNQNElYbzXLAWz59csBiX1voJlwOZgaJe0yhdADp/VEBVUbZ9Q8q3wWJFfn9lvM7m9QFiQJFT5ZCmuKalKS6o4slCYkrVGvtCQK3B8zxKqrqmkjm34/KOcZGH+TQ2YhoMH1W0xyPcE6ug2YhpMDRO18FgMBgxDQaDEdNgMGIajgIkXOWrzxkygP8LMACYHT/RhC6+bgAAAABJRU5ErkJggg==';

        /*RETRY PAGE*/

        vm.retrySendGuessNameAnswer = function () {
            if (retryCounter < 3) {
                vm.loadingSearch = true;
                vm.disableButton = true;

                //Send Answer to BE
                DataService.guessCardName(vm.answerSelected).then(function (response) {

                    vm.dataRetryResponse = response;

                    //First Card Bonus
                    vm.firstCardBonus = response.guessCardNameResult.firstCardBonus;
                    if (vm.firstCardBonus) {
                        vm.firstCardBonusPoints = response.guessCardNameResult.points;
                    }

                    vm.verifyCorrectAnswer(vm.dataRetryResponse, $scope.counter, vm.dataRetryResponse.index);

                    $rootScope.middlePrizes = response.guessCardNameResult.middlePrizes;
                    $rootScope.middlePrize = response.guessCardNameResult.middlePrize;

                    vm.loadingSearch = false;
                    vm.disableButton = true;
                    vm.markListOfResultPage('RESUME');

console.log('INDEX CORRECT ANSWER: ' + vm.indexOfCorrectAnswer + "|| INDEX SELECTED: " + vm.indexOfSelectedAnswer);

                }, function (error) {

                    $timeout(function(){
                        vm.loadingSearch = false;
                        vm.disableButton = false;
                        vm.guessNameRetryPage = true;
                        retryCounter++;
                    },3500);
                });

            } else {
                vm.closeRetryPage();
            }
        };

        //Close Retry Page
        vm.closeRetryPage = function(){
            vm.guessNameRetryPage= false;
            vm.showGuessCardName = false;
            vm.showAnswerNamePage = false;
            $location.path(appConfig.routes.booklet);
        };

        var correct = false;
        vm.verifyCorrectAnswer = function (answer, time, index) {
            if (answer) {
                if (answer.guessCardNameResult.result === 'CARD_NAME_CORRECT') {

                    correct = true;

                    //Freeze options and add css classes
                    vm.freezeOptions(index, correct);

                    //Open Resume Page
                    $timeout(function () {
                        //Close Retry Page
                        vm.guessNameRetryPage = false;
                        //Open Resume Page
                        vm.showAnswerNamePage = true;
                        vm.doAction('answerPage');
                    }, 2500);

                } else if (answer.guessCardNameResult.result === 'CARD_NAME_WRONG' && time > 0) {

                    correct = false;

                    //Freeze options and add css classes
                    vm.freezeOptions(index, correct);

                    //Open Resume Page
                    $timeout(function () {
                        //Close Retry Page
                        vm.guessNameRetryPage = false;
                        //Open Resume Page
                        vm.showAnswerNamePage = true;
                        vm.doAction('answerPage');
                    }, 2500);

                } else if (answer.guessCardNameResult.result === 'CARD_NAME_WRONG' && time === 0) {

                    correct = false;

                    //Freeze options and add css classes
                    vm.freezeOptions(index, correct);

                    //Open Resume Page
                    $timeout(function () {
                        //Close Retry Page
                         vm.guessNameRetryPage = false;
                        //Open Resume Page
                         vm.showAnswerNamePage = true;
                         vm.doAction('answerPage');
                    }, 2500);
                }
            }
        };

        vm.freezeOptions = function (index, correct) {
            //Get List elements of overlay
            angular.element(document.getElementById("optionsListOverlay")).addClass("freeze");

            //Get the List element
            var list = angular.element(document.getElementById("optionsList"));
            if (!list) {
                list = angular.element(document.getElementById("optionsListRetry"));
            }

            //Lock the options so that only one can be selected
            list.addClass("freeze");

            if (index || index === 0) {
                vm.indexOfSelectedAnswer = index;
                $timeout(function () {
                    //Mark all with the "answered" state
                    list.children().addClass('answered');
                    //Mark the selected option with "selected" state
                    angular.element(document.getElementById("option_" + index)).addClass("selected");

                    $timeout(function () {
                        if (correct) {
                            //Mark the Correct answer
                            angular.element(document.getElementById("option_" + index)).removeClass('selected').removeClass('answered').addClass("correct");
                            angular.element(document.getElementById("resultOption_" + index)).removeClass('selected').removeClass('answered').addClass("correct");
                            angular.element(document.getElementById("resultOptionOverlay_" + index)).removeClass('selected').removeClass('answered').addClass("correct");
                        } else {
                            //Mark the Wrong answer
                            angular.element(document.getElementById("option_" + index)).removeClass('selected').removeClass('answered').addClass("wrong");
                            angular.element(document.getElementById("resultOption_" + index)).removeClass('selected').removeClass('answered').addClass("wrong");
                            angular.element(document.getElementById("resultOptionOverlay_" + index)).removeClass('selected').removeClass('answered').addClass("wrong");

                            //Mark the Correct answer
                            $timeout(function () {
                                angular.element(document.getElementById("option_" + vm.indexOfCorrectAnswer)).removeClass('selected').removeClass('answered').addClass("correct");
                                angular.element(document.getElementById("resultOption_" + vm.indexOfCorrectAnswer)).removeClass('selected').removeClass('answered').addClass("correct");
                                angular.element(document.getElementById("resultOptionOverlay_" + vm.indexOfCorrectAnswer)).removeClass('selected').removeClass('answered').addClass("correct");

                            }, 200);
                        }
                    }, 500);
                }, 100);
            }
        };

        // INIT - GuessCardName
        if (vm.showGuessCardName) {
            vm.guessCardName(vm.card);
            vm.initCountDown();
        }

        //Final Action - Hide Answer Resume popup and show the Add Card to Booklet screen
        function continuePlaceCardInBooklet() {

              vm.showGuessCardName = false;
              if(!vm.showGuessCardName){
                  $timeout(function(){
                      angular.element(document.getElementById("cardAnswerPopup")).removeClass('animated slideInRight').addClass('animated slideOutLeft');
                  }, 0);
              }
            vm.showAnswerNamePage = false;
        }

        //Mark the wrong and correct answers in the resume popup
        vm.markListOfResultPage = function(page) {

            if (page === 'RESUME') {
                $timeout(function () {
                    //Mark correct answer
                    angular.element(document.getElementById("resultOptionOverlay_" + vm.indexOfCorrectAnswer)).removeClass('answered').addClass("correct");

                    //Mark Wrong answer too
                    if (vm.indexOfSelectedAnswer !== vm.indexOfCorrectAnswer) {
                        angular.element(document.getElementById("resultOptionOverlay_" + vm.indexOfSelectedAnswer)).removeClass('answered').addClass("wrong");
                    }
                }, 200);

                $timeout(function () {
                    vm.showCard = true;
                    $timeout(function () {
                        $timeout(function () {
                            vm.showTopLeft = true;
                            $timeout(function () {
                                vm.showTopRight = true;
                                $timeout(function () {
                                    vm.showBottomRight = true;
                                    $timeout(function () {
                                        vm.showBottomLeft = true;
                                        $timeout(function () {
                                            vm.showBgAnimation = true;
                                            $timeout(function () {
                                                angular.element(doc.getElementById("bgCardTopLeft")).removeClass("animated slideInLeft").addClass("leftRightAnimation");
                                                angular.element(doc.getElementById("bgCardTopRight")).removeClass("animated slideInRight").addClass("rightLeftAnimation");
                                                angular.element(doc.getElementById("bgCardBottomLeft")).removeClass("animated slideInLeft").addClass("leftRightAnimation");
                                                angular.element(doc.getElementById("bgCardBottomRight")).removeClass("animated slideInRight").addClass("rightLeftAnimation");
                                                initialAnimationRunning = false;
                                            }, 700);
                                        }, auxTime);
                                    }, auxTime);
                                }, auxTime);
                            }, auxTime);
                        }, auxTime);
                    }, 400);
                }, 100);
            }
            if (page === 'RETRY') {
                $timeout(function () {

console.log("SELECTED: " + vm.indexOfSelectedAnswer);
                    //Mark answer
                    angular.element(document.getElementById("resultOptionRetry_" + vm.indexOfSelectedAnswer)).removeClass('answered').addClass('selected');
                }, 100);
            }
        };

        /*#endregion GuessCardName */

        var submiteSwipeUp = $rootScope.$on(appConfig.events.swipeUp, function () {
            if (vm.isPrizeInfoOpen != null && !vm.isPrizeInfoOpen) {
                $timeout(function () {
                    vm.openPrize(vm.isGoldCard && vm.isGoldCard === true);
                }, 100);
            }
        });

        var submiteSwipeDown = $rootScope.$on(appConfig.events.swipeDown, function () {
            if (vm.isPrizeInfoOpen != null && !vm.isPrizeInfoOpen) {
                $timeout(function () {
                    vm.openPrize(vm.isGoldCard && vm.isGoldCard === true);
                }, 100);
            }
        });

        $scope.$on('$destroy', function () {

            if (submiteSwipeUp) {
                $log.debug("[CardController][$destroy] - submiteSwipeUp");
                submiteSwipeUp();
            }

            if (submiteSwipeDown) {
                $log.debug("[CardController][$destroy] - submiteSwipeDown");
                submiteSwipeDown();
            }
        });

        function isCollectionDuplicated() {
            if (!initialAnimationRunning) {
                vm.doAction();
            } else {
                $timeout(function () {
                    isCollectionDuplicated();
                }, 500);
            }
        }

        function init() {
            if (vm.cardType == vm.cardTypes.collection && vm.card.duplicated) {
                isCollectionDuplicated();
            }
        }

        init();
    }
})();

/**
 * Created by RCarvalho on 30-05-2017.
 */
(function () {
        'use strict';
    angular.module("configuration.service",[]).factory("configurationsService", ConfigurationsService);

    ConfigurationsService.$inject= ["appConfig", "DataService"];

    function ConfigurationsService(appConfig, DataService) {
        return {
            appendRemoteProperties : _appendRemoteProperties
        };

        function _appendRemoteProperties(){

            DataService.getRemoteProperties().then(function (response) {
                if(response){
                    for (var key in response){
                        appConfig[key] = response[key];
                    }
                    appConfig.facebook_id;
                }
            }, function (error) {

            });
        }
    }
})();

/**
 * Module to work as middleware between rest methods and ui layer
 * responsible for data parsing and promises deferring or rejecting
 */
angular.module("dataservice.service", []).factory("DataService", DataService);

// Inject service dependencies
DataService.$inject = ["$q", "$log", "Achievements", "Booklet", "History", "RestApi"];

var Menu;
// Handle requests
function DataService($q, $log, Achievements, Booklet, History, RestApi) {
  return {
    acceptPrizeTermsAndConditions: _acceptPrizeTermsAndConditions,
    acceptTermsAndConditions: acceptTermsAndConditions,
    checkAchievements: _checkAchievements,
    confirmGoldExchangeCard: confirmGoldExchangeCard,
    exchangeRepeatedCardsForPrize: _exchangeRepeatedCardsForPrize,
    exchangeRepeatedCards: _exchangeRepeatedCards,
    getAchievements: _getAchievements,
    getAddress: getAddress,
    getGallery: _getGallery,
    getPreviousBooklet: _getPreviousBooklet,
    getHistory: _getHistory,
    getPrizeList: getPrizeList,
    getProfileShakes: _getProfileShakes,
    getUserPrizes: getUserPrizes,
    getProfileAchievements: _getProfileAchievements,
    getQuestion: getQuestion,
    getQuestionValidation: getQuestionValidation,
    getReferral: getReferral,
    getRemoteProperties: _getRemoteProperties,
    getSplashScreens: getSplashScreens,
    getShakeCard: getShakeCard,
    getShakeDuplicatedGoldCard: getShakeDuplicatedGoldCard,
    getTermsAndConditions: getTermsAndConditions,
    getTexts: getTexts,
    getLocalTexts: getLocalTexts,
    getUserAvailableShakes: getUserAvailableShakes,
    getUserFirstLogin: getUserFirstLogin,
    getUserTutorial: getUserTutorial,
    shuffleMiddlePrizeCards: shuffleMiddlePrizeCards,
    keepAlive: keepAlive,
    setUserTutorialCompleted: setUserTutorialCompleted,
    postPrizeRedeem: postPrizeRedeem,
    validateReferralCode: validateReferralCode,
    getListOfDuplicatedCards: getListOfDuplicatedCards,
    connectToFriend: connectToFriend,
    checkStatusFriend: checkStatusFriend,
    abortExchangeCardFriend: abortExchangeCardFriend,
    selectCard: selectCard,
    confirmTrade: confirmTrade,
    statusMysteryBox: statusMysteryBox,
    openMysteryBox: openMysteryBox,
    getExchangeCardsInitialize: _getExchangeCardsInitialize,
    getExchangeCardsConnectToGateway: _getExchangeCardsConnectToGateway,
    getExchangeWithFriendInfo: _getExchangeWithFriendInfo,
    getUserInfo: _getUserInfo,
    saveFacebookInfo: _saveFacebookInfo,
    saveNickName: _saveNickName,
    setUserVisibility: _setUserVisibility,
    sendQrCodeCampaign: _sendQrCodeCampaign,
    guessCardName: _guessCardName,
    promotionsRedeem: _promotionsRedeem,
    userSettings: _userSettings
  };

  function shuffleMiddlePrizeCards(_userPrizeId) {
    var deferred = $q.defer();
    RestApi.shuffleMiddlePrizeCards(_userPrizeId).then(
      function(success) {
        deferred.resolve(true);
      },
      function(error) {
        deferred.resolve(true);
      }
    );
    return deferred.promise;
  }

  function _acceptPrizeTermsAndConditions(_userPrizeId) {
    var deferred = $q.defer();
    RestApi.acceptPrizeTermsAndConditions(_userPrizeId).then(
      function(success) {
        deferred.resolve(true);
      },
      function(error) {
        deferred.resolve(true);
      }
    );
    return deferred.promise;
  }

  function acceptTermsAndConditions() {
    var deferred = $q.defer();
    RestApi.acceptTermsAndConditions().then(
      function(success) {
        deferred.resolve(true);
      },
      function(error) {
        deferred.resolve(true);
      }
    );
    return deferred.promise;
  }

  function _checkAchievements() {
    var deferred = $q.defer();

    RestApi.checkAchievements().then(
      function(success) {
        deferred.resolve(true);
      },
      function(error) {
        deferred.resolve(true);
      }
    );

    return deferred.promise;
  }

  function confirmGoldExchangeCard(selectedUserPrizeId) {
    var deferred = $q.defer();
    RestApi.confirmGoldExchangeCard(selectedUserPrizeId).then(function(response) {
      if (response.statusCode === 0) {
        $log.debug("[DataService][confirmGoldExchangeCard]: SUCCESS received ");

        deferred.resolve(response);
      }
    });
    return deferred.promise;
  }

  /**
   * Receives information on the exchange cards initializing process
   */
  function _getExchangeCardsInitialize() {
    var deferred = $q.defer();
    RestApi.getExchangeCardsInitialize().then(function(response) {
      if (response.statusCode === 0) {
        $log.debug("[DataService][getExchangeInitialize]: SUCCESS received ");

        deferred.resolve(response);
      }
    });
    return deferred.promise;
  }

  /**
   * Receives information on the exchange cards authorizing process
   */
  function _getExchangeCardsConnectToGateway(gatewayUrl) {
    $log.debug("3g validation start");
    console.log("3g validation start");
    var deferred = $q.defer();
    //test if user is in 3g
    var tester = new Image();
    var obj = {};
    tester.onload = function() {
      $log.debug("3g validation image loaded");
      console.log("3g validation image loaded");
      obj.result = "USER_IS_IN_3G";
      deferred.resolve(obj);
    };
    tester.onerror = function() {
      $log.debug("3g validation image error ");
      console.log("3g validation image error ");
      deferred.resolve(null);
    };
    tester.src = gatewayUrl;
    return deferred.promise;
  }

  /**
   * Receives information on the exschange cards with friend functionality
   */
  function _getExchangeWithFriendInfo() {
    var deferred = $q.defer();
    RestApi.getExchangeWithFriendInfo().then(function(response) {
      if (response.statusCode === 0) {
        $log.debug("[DataService][getExchangeWithFriendInfo]: SUCCESS received ");

        deferred.resolve(response);
      }
    });
    return deferred.promise;
  }

  /**
   * Receives a comma separated list of card ids to exchange
   */
  function _exchangeRepeatedCards(cardIds) {
    var deferred = $q.defer();
    RestApi.exchangeRepeatedCards(cardIds).then(function(response) {
      if (response.statusCode === 0) {
        $log.debug("[DataService][exchangeRepeatedCards]: SUCCESS received ");

        deferred.resolve(response);
      }
    });
    return deferred.promise;
  }

  /**
   * Receives a comma separated list of card ids to exchange
   */
  function _exchangeRepeatedCardsForPrize(cardIds) {
    var deferred = $q.defer();
    RestApi.exchangeRepeatedCardsForPrize(cardIds).then(function(response) {

      if (response.statusCode === 0) {
        $log.debug("[DataService][exchangeRepeatedCardsForPrize]: SUCCESS received ");

        deferred.resolve(response);
      }
    });
    return deferred.promise;
  }

  function getListOfDuplicatedCards() {
    var deferred = $q.defer();
    RestApi.getListOfDuplicatedCards().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function _getAchievements() {
    var deferred = $q.defer();
    var _achievements = new Achievements();
    RestApi.getAchievements().then(
      function(response) {
        if (response.statusCode == 0) {
          $log.debug("[DataService][_getAchievements]: SUCCESS received ");
          _achievements.parseFromRest(response);
          deferred.resolve(_achievements);
        } else {
          $log.error("[DataService][_getAchievements]: ERROR received ", response);
          deferred.reject(response);
        }
      },
      function(error) {
        $log.error("[DataService][_getAchievements]: ERROR received ", error);
        deferred.reject(error);
      }
    );
    return deferred.promise;
  }

  function getAddress(cp4, cp3) {
    var deferred = $q.defer();
    RestApi.getAddress(cp4, cp3).then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function _getGallery(ignoreModelReturnObject) {
    var deferred = $q.defer();
    RestApi.getCardsGallery().then(
      function(response) {
        if (response.statusCode == 0) {
          $log.debug("[DataService][getGallery]: SUCCESS received ");

          var _booklet;
          if (ignoreModelReturnObject) {
            _booklet = response;
          } else {
            _booklet = new Booklet();
            _booklet.parseFromRest(response, false);
          }

          deferred.resolve(_booklet);
        } else {
          $log.error("[DataService][getGallery]: ERROR received ", response);
          deferred.reject(response);
        }
      },
      function(error) {
        $log.error("[DataService][getGallery]: ERROR received ", error);
        deferred.reject(error);
      }
    );
    return deferred.promise;
  }

  function _getPreviousBooklet(ignoreModelReturnObject) {
    var deferred = $q.defer();
    RestApi.getPreviousBooklet().then(
      function(response) {
        if (response.statusCode == 0) {
          $log.debug("[DataService][getGallery]: SUCCESS received ");

          var _booklet;
          if (ignoreModelReturnObject) {
            _booklet = response;
          } else {
            _booklet = new Booklet();
            _booklet.parseFromRest(response, true);
          }

          deferred.resolve(_booklet);
        } else {
          $log.error("[DataService][getGallery]: ERROR received ", response);
          deferred.reject(response);
        }
      },
      function(error) {
        $log.error("[DataService][getGallery]: ERROR received ", error);
        deferred.reject(error);
      }
    );
    return deferred.promise;
  }

  function _getHistory(_type, monthIndex, monthCount) {
    var deferred = $q.defer();

    $log.debug("[DataService][_getHistory]: Getting history for type '" + _type + "'");

    if (!_type) {
      var _promises = [];
      _promises.push(RestApi.getHistory("prizes", monthIndex, monthCount));
      _promises.push(RestApi.getHistory("plays", monthIndex, monthCount));

      $q.all(_promises).then(
        function(_results) {
          var _history = new History();
          _history.parseFromRest(_results[0], "prizes");
          _history.parseFromRest(_results[1], "plays");

          deferred.resolve(_history);
        },
        function(_error) {
          $log.error("[DataService][_getHistory]: ERROR received ", _error);
          deferred.reject(_error);
        }
      );
    } else {
      RestApi.getHistory(_type, monthIndex, monthCount).then(
        function(response) {
          if (response.statusCode == 0) {
            $log.debug("[DataService][_getHistory]: SUCCESS received ");

            var _history = new History();
            _history.parseFromRest(response, _type);

            deferred.resolve(_history);
          } else {
            $log.error("[DataService][_getHistory]: ERROR received ", response);
            deferred.reject(response);
          }
        },
        function(error) {
          $log.error("[DataService][_getHistory]: ERROR received ", error);
          deferred.reject(error);
        }
      );
    }
    return deferred.promise;
  }

  function getPrizeList(removeNotifyUserNewPrize) {
    var deferred = $q.defer();
    RestApi.getPrizeList(removeNotifyUserNewPrize).then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function _getProfileShakes() {
    var deferred = $q.defer();
    RestApi.getProfileShakes().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function getUserPrizes() {
    var deferred = $q.defer();
    RestApi.getUserPrizes().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function _getProfileAchievements() {
    var deferred = $q.defer();
    var _achievements = new Achievements();
    RestApi.getProfileAchievements().then(
      function(response) {
        if (response.statusCode == 0) {
          $log.debug("[DataService][_getProfileAchievements]: SUCCESS received ");
          _achievements.parseFromRest(response);
          deferred.resolve(_achievements);
        } else {
          $log.error("[DataService][_getProfileAchievements]: ERROR received ", response);
          deferred.reject(response);
        }
      },
      function(error) {
        $log.error("[DataService][_getProfileAchievements]: ERROR received ", error);
        deferred.reject(error);
      }
    );
    return deferred.promise;
  }

  function getQuestion(prizeId) {
    var deferred = $q.defer();
    RestApi.getQuestion(prizeId).then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function getQuestionValidation(prizeId, questionId, answerId) {
    var deferred = $q.defer();
    RestApi.getQuestionValidation(prizeId, questionId, answerId).then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function getReferral() {
    var deferred = $q.defer();
    RestApi.getReferral().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function _getRemoteProperties() {
    var deferred = $q.defer();
    RestApi.getRemoteProperties().then(
      function(response) {
        deferred.resolve(response.texts);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function getSplashScreens() {
    var deferred = $q.defer();
    RestApi.getSplashScreens().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function getShakeCard() {
    var deferred = $q.defer();
    RestApi.getShakeCard().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function getShakeDuplicatedGoldCard() {
    var deferred = $q.defer();

    RestApi.getShakeDuplicatedGoldCard().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );
    return deferred.promise;
  }

  function getTermsAndConditions() {
    var deferred = $q.defer();

    RestApi.getTermsAndConditions().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );
    return deferred.promise;
  }

  function getTexts() {
    var deferred = $q.defer();
    RestApi.getTexts().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function getLocalTexts() {
    var deferred = $q.defer();
    RestApi.getLocalTexts().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function getUserAvailableShakes() {
    var deferred = $q.defer();
    RestApi.getUserAvailableShakes().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function getUserFirstLogin() {
    var deferred = $q.defer();
    RestApi.getUserFirstLogin().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function getUserTutorial() {
    var deferred = $q.defer();
    RestApi.getUserTutorial().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function keepAlive() {
    var deferred = $q.defer();
    RestApi.keepAlive().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function setUserTutorialCompleted() {
    var deferred = $q.defer();
    RestApi.setUserTutorialCompleted().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function postPrizeRedeem(data) {
    var deferred = $q.defer();
    RestApi.postPrizeRedeem(data).then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function validateReferralCode(referralCode) {
    var deferred = $q.defer();
    RestApi.validateReferralCode(referralCode).then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function connectToFriend(msisdn) {
    var deferred = $q.defer();
    RestApi.connectToFriend(msisdn).then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function checkStatusFriend(msisdn) {
    var deferred = $q.defer();
    RestApi.checkStatusFriend(msisdn).then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function abortExchangeCardFriend() {
    var deferred = $q.defer();
    RestApi.abortExchangeCardFriend().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function selectCard(msisdn, cardId) {
    var deferred = $q.defer();
    RestApi.selectCard(msisdn, cardId).then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function confirmTrade(msisdn) {
    var deferred = $q.defer();
    RestApi.confirmTrade(msisdn).then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function statusMysteryBox() {
    var deferred = $q.defer();
    RestApi.statusMysteryBox().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function openMysteryBox() {
    var deferred = $q.defer();
    RestApi.openMysteryBox().then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  /**
   * Gets extra user info for given msisdn
   */
  function _getUserInfo(msisdn) {
    var deferred = $q.defer();
    RestApi.getUserInfo(msisdn).then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  /**
   * Saves extra facebook info for a user
   */
  function _saveFacebookInfo(name, facebookId, birthDate) {
    var deferred = $q.defer();
    RestApi.saveFacebookInfo(name, facebookId, birthDate).then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  /**
   * Updates user info visibility status
   */
  function _setUserVisibility(isVisible) {
    var deferred = $q.defer();
    RestApi.setUserVisibility(isVisible).then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function _saveNickName(nickname) {
    var deferred = $q.defer();
    RestApi.saveNickName(nickname).then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function _guessCardName(answer) {
    var deferred = $q.defer();
    RestApi.guessCardName(answer).then(
      function(response) {
        // console.log('[RESPONSE FROM API] : ' + response);
        if (response.statusCode === 0) {
          deferred.resolve(response);
        }
      },
      function(error) {
        deferred.reject(error);
      }
    );
    return deferred.promise;
  }

  function _sendQrCodeCampaign(code) {
    var deferred = $q.defer();
    RestApi.sendQrCodeCampaign(code).then(
      function(response) {
        if (response.statusCode === 0 || response.statusCode === 305) {
          console.log("DATA SERVICE - QR CODE RESPONSE", response);
          deferred.resolve(response);
        }
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }
  
  function _promotionsRedeem(code) {
    var deferred = $q.defer();
    RestApi.promotionsRedeem(code).then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }

  function _userSettings(data) {
    var deferred = $q.defer();
    RestApi.userSettings(data).then(
      function(response) {
        deferred.resolve(response);
      },
      function(error) {
        deferred.reject(error);
      }
    );

    return deferred.promise;
  }
}

(function () {
    'use strict';

    angular.module('restapi.service', []).factory('RestApi', RestApi);

    RestApi.$inject = ['$http', '$q', '$log', 'appConfig', '$timeout', '$rootScope'];

    function RestApi($http, $q, $log, appConfig, $timeout, $rootScope) {
        var vm = this;
        var HttpMethod = {
            "GET": "GET",
            "POST": "POST",
            "PUT": "PUT"
        };

        vm.configurations = appConfig;

        var service = {
            acceptPrizeTermsAndConditions: acceptPrizeTermsAndConditions,
            acceptTermsAndConditions: acceptTermsAndConditions,
            checkAchievements: checkAchievements,
            confirmGoldExchangeCard: confirmGoldExchangeCard,
            exchangeRepeatedCards: exchangeRepeatedCards,
            exchangeRepeatedCardsForPrize: exchangeRepeatedCardsForPrize,
            getAchievements: getAchievements,
            getAddress: getAddress,
            getCardsGallery: getCardsGallery,
            getPreviousBooklet: getPreviousBooklet,
            getHistory: getHistory,
            getPrizeList: getPrizeList,
            getProfileAchievements: getProfileAchievements,
            getProfileShakes: getProfileShakes,
            getUserPrizes: getUserPrizes,
            getQuestion: getQuestion,
            getQuestionValidation: getQuestionValidation,
            getReferral: getReferral,
            getRemoteProperties: getRemoteProperties,
            getSplashScreens: getSplashScreens,
            getShakeCard: getShakeCard,
            getShakeDuplicatedGoldCard: getShakeDuplicatedGoldCard,
            getTermsAndConditions: getTermsAndConditions,
            getTexts: getTexts,
            getLocalTexts: getLocalTexts,
            getUserAvailableShakes: getUserAvailableShakes,
            getUserFirstLogin: getUserFirstLogin,
            getUserTutorial: getUserTutorial,
            shuffleMiddlePrizeCards: shuffleMiddlePrizeCards,
            keepAlive: keepAlive,
            setUserTutorialCompleted: setUserTutorialCompleted,
            postPrizeRedeem: postPrizeRedeem,
            validateReferralCode: validateReferralCode,
            getListOfDuplicatedCards: getListOfDuplicatedCards,
            connectToFriend: connectToFriend,
            checkStatusFriend: checkStatusFriend,
            abortExchangeCardFriend: abortExchangeCardFriend,
            selectCard: selectCard,
            confirmTrade: confirmTrade,
            statusMysteryBox: statusMysteryBox,
            openMysteryBox: openMysteryBox,
            getExchangeCardsInitialize: getExchangeCardsInitialize,
            getExchangeCardsConnectToGateway: getExchangeCardsConnectToGateway,
            getExchangeWithFriendInfo: getExchangeWithFriendInfo,
            getUserInfo: _getUserInfo,
            saveFacebookInfo: _saveFacebookInfo,
            saveNickName: _saveNickName,
            setUserVisibility: _setUserVisibility,
            sendQrCodeCampaign: _sendQrCodeCampaign,
            guessCardName: _guessCardName,
            promotionsRedeem: _promotionsRedeem,
            userSettings: _userSettings,
        };
        return service;

        function shuffleMiddlePrizeCards(userPrizeId) {
            var data = "userPrizeId=" + userPrizeId;

            var header = {
                "Content-Type": "application/x-www-form-urlencoded"
            };

            return makeHttpRequest(HttpMethod.PUT, appConfig.endpoint.shuffleMiddlePrizeCards, data, header);
        }

        function acceptPrizeTermsAndConditions(_userPrizeId) {
            var body = "accepted=true&userPrizeId=" + _userPrizeId;

            var header = {
                "Content-Type": "application/x-www-form-urlencoded"
            };
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.prizeTermsAcceptance, body, header);
        }

        function acceptTermsAndConditions() {
            var body = "accepted=true";

            var header = {
                "Content-Type": "application/x-www-form-urlencoded"
            };
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.termsAcceptance, body, header);
        }

        function checkAchievements() {
            if ($rootScope.sessionExpired === false) {
                return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.checkachievements);
            }
        }

        function confirmGoldExchangeCard(selectedUserPrizeId) {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.exchangegoldcard.replace(":selectedUserPrizeId", selectedUserPrizeId));
        }

        /**
         * Initialize exchange cards
         */
        function getExchangeCardsInitialize() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.exchangeCardsInitialize);
        }

        /**
         * Call gateway to headers injection
         */
        function getExchangeCardsConnectToGateway(gatewayUrl) {
            return makeExternalRequest(HttpMethod.GET, gatewayUrl);
        }

        /**
         * Gets information on the exchange cards with friends functionality
         */
        function getExchangeWithFriendInfo() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.exchangeCardsFriendInfo);
        }
        /**
         * Receives a comma separated list of card ids to exchange
         */
        function exchangeRepeatedCards(cardIds) {
            var body = "cardIds=" + cardIds;

            var header = {
                "Content-Type": "application/x-www-form-urlencoded"
            };
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.exchangecardsshake, body, header);
        }

        /**
         * Receives a comma separated list of card ids to exchange
         * Used on exchange cards for Wildcard
         */
        function exchangeRepeatedCardsForPrize(cardIds) {
            var body = "cardIds=" + cardIds;

            var header = {
                "Content-Type": "application/x-www-form-urlencoded"
            };
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.exchangeCardsForPrize, body, header);
        }


        function getAchievements() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.achievements);
        }

        function getCardsGallery() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.booklet);
        }

        function getPreviousBooklet() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.previousbooklet);
        }

        function getListOfDuplicatedCards() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.listOfDuplicatedCards);
        }

        function getAddress(cp4, cp3) {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.address.replace(":cp4", cp4).replace(":cp3", cp3));
        }

        function getHistory(type, monthIndex, monthCount) {
            var _endpoint = "";
            if (type === "prizes") {
                _endpoint = appConfig.endpoint.history_prizes;
            } else if (type === "plays") {
                _endpoint = appConfig.endpoint.history_plays;
            }
            return makeHttpRequest(HttpMethod.GET, _endpoint + "?monthIndex=" + monthIndex + "&monthCount=" + monthCount);

        }

        function getPrizeList(removeNotifyUserNewPrize) {
            return updateLocation().then(function (_location) {
                var header = null;
                if (_location) {
                    header = {
                        "user-location" : JSON.stringify(_location)
                    };
                }
                var endPoint = appConfig.endpoint.eligibleprizes;

                if (removeNotifyUserNewPrize) {
                    endPoint = appConfig.endpoint.eligibleprizes + '?removeNotifyUserNewPrize=' + removeNotifyUserNewPrize;
                }
                return makeHttpRequest(HttpMethod.GET, endPoint, null, header);
            });
        }

        function getProfileAchievements() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.profileAchievements);
        }

        function getProfileShakes() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.profileShakes);
        }

        function getUserPrizes(option) {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.userPrizes);
        }

        function getQuestion(prizeId) {
            var body = "prizeId=" + prizeId;

            var header = {
                "Content-Type": "application/x-www-form-urlencoded"
            };
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.question, body, header);
        }

        function getQuestionValidation(prizeId, questionId, answerId) {
            var body = "userPrizeId=" + prizeId + "&questionId=" + questionId + "&answerId=" + answerId;

            var header = {
                "Content-Type": "application/x-www-form-urlencoded"
            };
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.questionValidation, body, header);
        }

        function getReferral() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.referral);
        }

        function getRemoteProperties() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.remote_properties);
        }

        function getSplashScreens() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.splashscreens);
        }

        function getShakeCard() {
            return updateLocation().then(function (_location) {
                var header = null;
                if (_location) {
                    header = {
                        "user-location" : JSON.stringify(_location)
                    };
                }
                return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.shakes_shake, null, header);
            });
        }

        function getShakeDuplicatedGoldCard() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.duplicatedGoldCard);
        }

        function getTermsAndConditions() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.termsAndConditions);
        }

        function getTexts() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.texts);
        }

        function getLocalTexts() {
            return makeLocalRequest(HttpMethod.GET, appConfig.global.translateTextsFile);
        }

        function getUserAvailableShakes() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.shakes_available);
        }

        function getUserFirstLogin() {
            return updateLocation().then(function (_location) {
                var header = null;
                if (_location) {
                    header = {
                        "user-location" : JSON.stringify(_location)
                    };
                }
                return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.userFirstlogin);
            });
        }

        function getUserTutorial() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.tutorials);
        }

        function keepAlive() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.keepAlive);
        }

        function setUserTutorialCompleted() {
            var data = "status=true";

            var header = {
                "Content-Type": "application/x-www-form-urlencoded"
            };

            return makeHttpRequest(HttpMethod.PUT, appConfig.endpoint.tutorialsCompleted, data, header);
        }

        function postPrizeRedeem(data) {
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.prizeRedeem, data);
        }

        function validateReferralCode(referralCode) {
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.validateRefferralCode.replace(":code", referralCode));
        }

        function makeHttpRequest(httpMethod, endpoint, body, header) {
            return makeRequest(true, httpMethod, endpoint, body, header);
        }

        function makeLocalRequest(httpMethod, file) {
            return makeRequest(false, httpMethod, file);
        }

        function makeExternalRequest(httpMethod, endpoint) {
            return makeRequest(false, httpMethod, endpoint);
        }

        function makeRequest(isHttpsRequest, httpMethod, target, body, header) {
            var deferred = $q.defer();
            var url = target;

            if (isHttpsRequest) {
                url = appConfig.restapi + url;
                $log.debug("[restapi.service]: invoking httprequest on url " + url);
            } else {
                $log.debug("[restapi.service]: invoking local file " + url);
            }
            var request = {
                method: httpMethod,
                url: url
            };

            if (body) {
                request.data = body;
            }

            if (header) {
                request.headers = header;
            }

            $http(request).then(function (response) {
                deferred.resolve(response.data);
            }, function (error) {
                deferred.reject(error.data);
            });

            return deferred.promise;
        }

        function updateLocation() {
            var deferred = $q.defer();

            if (navigator.geolocation) {

                $timeout(function () {
                    deferred.resolve();
                }, 5000);

                navigator.geolocation.getCurrentPosition(function (position) {
                    deferred.resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    });
                }, function (error) {
                    deferred.resolve();
                });
            } else {
                deferred.resolve();
            }

            return deferred.promise;
        }

        function getMockData(data) {
            var deferred = $q.defer();
            deferred.resolve(data);
            return deferred.promise;
        }

        /**
         * Receives a comma separated list of card ids to exchange
         */
        function connectToFriend(msisdn) {
            var body = "friend=" + msisdn;

            var header = {
                "Content-Type": "application/x-www-form-urlencoded"
            };
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.connectToFriend, body, header);
        }

        function checkStatusFriend(msisdn) {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.checkStatusFriend + "?friend=" + msisdn);
        }

        function abortExchangeCardFriend() {
            var body = "";
            var header = {
                "Content-Type": "application/x-www-form-urlencoded"
            };
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.abortExchangeCardFriend, body, header);
        }

        function selectCard(msisdn, cardId) {
            var body = "friend=" + msisdn + "&cardId=" + cardId;
            var header = {
                "Content-Type": "application/x-www-form-urlencoded"
            };
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.selectCard, body, header);
        }

        function confirmTrade(msisdn) {
            var body = "friend=" + msisdn;
            var header = {
                "Content-Type": "application/x-www-form-urlencoded"
            };
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.confirmTrade, body, header);
        }

        function statusMysteryBox() {
            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.statusMysteryBox);
        }

        function openMysteryBox() {
            var body = "";
            var header = {
                "Content-Type": "application/x-www-form-urlencoded"
            };
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.openMysteryBox, body, header);
        }
        /**
         * Gets extra user info for the msisdn
         */
        function _getUserInfo(msisdn) {

            return makeHttpRequest(HttpMethod.GET, appConfig.endpoint.userInfo.replace(":msisdn", btoa(msisdn)));
        }

        /**
         * sets user info visibility
         */
        function _setUserVisibility(isVisible) {
            var body = "visible=" + isVisible;
            var header = {
                "Content-Type": "application/x-www-form-urlencoded"
            };
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.userStatus, body, header);
        }

        function _saveFacebookInfo(name, facebookId, birthDate) {
            var body = "{ \"name\":\"" + name + "\", \"facebookId\":\"" + facebookId + "\",\"birthDate\":\"" + birthDate + "\"}";
            var header = {
                "Content-Type": "application/json"
            };
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.saveFacebookInfo, body, header);
        }

        function _saveNickName(nickname) {
            var body = "nickname=" + nickname;
            var header = {
                "Content-Type": "application/x-www-form-urlencoded"
            };
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.saveNickName, body, header);
        }

        function _guessCardName(answer) {
            var body = {
                "cardId": answer.id,
                "cardName": answer.name,
                "time" : answer.time
            };
            var header = {
                "Content-Type": "application/json"
            };
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.guessCardName, body, header);
        }

        function _sendQrCodeCampaign(code) {
            return updateLocation().then(function (_location) {

                var body = {
                    code: code
                };

                var header = null;
                if (_location) {
                    header = {
                        "Content-Type": "application/json",
                        "user-location" : JSON.stringify(_location),
                    };

                }
                return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.sendQrCodeCampaignCode, body, header);
            });
        }

        function _promotionsRedeem(code) {
            var body = {
                code: code
            };
            var header = {
                "Content-Type": "application/json"
            };
            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.promotionsredeem, body, header);
        }

        function _userSettings(userSettings) {
            var body = {
                vibration: userSettings.vibration,
                sound: userSettings.sound
            };
            var header = {
                "Content-Type": "application/json"
            };

            return makeHttpRequest(HttpMethod.POST, appConfig.endpoint.userSettings, body, header);
        }
    }

})();

angular.module("routes.config", ["ngRoute", "ngSanitize"]).config(ConfigureRoutes);

//App configuraton
ConfigureRoutes.$inject = ['$routeProvider'];

function ConfigureRoutes($routeProvider) {
  $routeProvider
    .when("/msisdn/:msisdn", {
      templateUrl: "app/loading/loading.view.html?ver=3.0.0",
      controller: "LoadingController",
      controllerAs: "loading"
    })
    .when("/", {
      templateUrl: "app/loading/loading.view.html?ver=3.0.0",
      controller: "LoadingController",
      controllerAs: "loading"
    })
    .when("/main", {
      templateUrl: "app/main/main.view.html?ver=3.0.0",
      controller: "MainController",
      controllerAs: "main"
    })
    .when("/achievements", {
      templateUrl: "app/achievements/achievements.view.html?ver=3.0.0",
      controller: "AchievementsController",
      controllerAs: "achievements",
      historyBack: true
    })
    .when("/booklet/:option?", {
      templateUrl: "app/booklet/booklet.view.html?ver=3.0.0",
      controller: "BookletController",
      controllerAs: "booklet"
    })
    .when("/exchangetype", {
      templateUrl: "app/exchangetype/exchangetype.view.html?ver=3.0.0",
      controller: "ExchangeTypeController",
      controllerAs: "exchgtype"
    })
    .when("/cardsexchange", {
      templateUrl: "app/exchangecards/exchangecards.view.html?ver=3.0.0",
      controller: "ExchangeCardsController",
      controllerAs: "exchgcards"
    })
    .when("/promocode", {
      templateUrl: "app/promocode/promocode.view.html?ver=3.0.0",
      controller: "PromoCodeController",
      controllerAs: "promo"
    })
    .when("/exchangecardsforwildcard", {
      templateUrl: "app/exchangecardsforwildcard/exchangecardsforwildcard.view.html?ver=3.0.0",
      controller: "ExchangeCardsWildcardController",
      controllerAs: "exchgcardswc"
    })
    .when("/exchangefriends", {
      templateUrl: "app/exchangefriends/exchangefriends.view.html?ver=3.0.0",
      controller: "ExchangeFriendsController",
      controllerAs: "exchgf"
    })
    .when("/exchangecardfriend", {
      templateUrl: "app/exchangecardfriend/exchangecardfriend.view.html?ver=3.0.0",
      controller: "ExchangeCardFriendController",
      controllerAs: "exchgcardf"
    })
    .when("/exchangecardfriendoverlay", {
      template: "<exchangecardfriendoverlay></exchangecardfriendoverlay>"
    })
    .when("/history", {
      templateUrl: "app/history/history.view.html?ver=3.0.0",
      controller: "HistoryController",
      controllerAs: "history"
    })
    .when("/prizes", {
      templateUrl: "app/prizelist/prizelist.view.html?ver=3.0.0",
      controller: "PrizeListController",
      controllerAs: "prizes"
    })
    .when("/referral", {
      templateUrl: "app/winshakes/winshakes.view.html?ver=3.0.0",
      controller: "WinShakestController",
      controllerAs: "winshakes"
    })
    .when("/profile", {
      templateUrl: "app/profile/profile.view.html?ver=3.0.0",
      controller: "ProfileController",
      controllerAs: "profile"
    })
    .when("/mysterybox", {
      templateUrl: "app/mysterybox/mysterybox.view.html?ver=3.0.0",
      controller: "MysteryBoxController",
      controllerAs: "mysterybox"
    })
    .when("/previousbooklet", {
      templateUrl: "app/previousbooklet/previousbooklet.view.html?ver=3.0.0",
      controller: "PreviousBookletController",
      controllerAs: "previousbooklet"
    })
    .when("/terms", {
      template: "<terms></terms>"
    })
    .when("/qrcode", {
      templateUrl: "app/qrcode/qrcode.template.html",
      controller: "QrCodeController",
      controllerAs: "qrcode"
    })
    .when("/error", {
      template: "",
      controller: "ErrorController",
      controllerAs: "error"
    })
    .otherwise({
      redirectTo: "/error"
    });
}

(function () {
    'use strict';

    angular.module('httpSrc.directive', []).directive('httpSrc', HttpSrc);

    /** @ngInject */
    HttpSrc.$inject=['$q'];
    function HttpSrc($q) {
        var directive = {
            scope: {
                httpSrcFactor: "@"
            },
            restrict: 'A',
            link: link
        };

        /** @ngInject */
        function link(scope, element, attrs) {
            var _DEFAULT_FACTOR = 1;
            var width = element.prop("width");
            var height = element.prop("height");
            var sizeParam = "";

            if(!width || width < 0){
                width = window.innerWidth;
                _DEFAULT_FACTOR = 0.7;
            }

            var _resizeFactor = scope.httpSrcFactor || _DEFAULT_FACTOR;

            //https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-355
            //2017-07-17:https://redmine.wit-software.com/issues/124712
            if(width > 0){
                sizeParam = "width=" + Math.round(_resizeFactor*width);
                height = Math.round(1.38 * width);
            }

            if(height > 0){
                if(sizeParam.length > 0) {
                    sizeParam += "&";
                }
                sizeParam += "height=" + Math.round(_resizeFactor*height);
            }

            if(sizeParam.length > 0) {
                var ch = "?";
                if (attrs.httpSrc.indexOf("?") > 0) {
                    ch = "&";
                }

                sizeParam = ch + sizeParam;
            }

            var src = attrs.httpSrc + sizeParam;

            attrs.$set('src', src);
        }

        return directive;
    }

})();
(function () {
    'use strict';

    angular
        .module ('optionbutton.directive', [])
        .directive ('optionButton', OptionButtonDirective);

    /** @ngInject */
    function OptionButtonDirective() {

        var directive = {
            restrict: 'E',
            scope : {
                text: '@',
                textbind: '@',
                btcolorclass: "@"
            },
            controller: OptionButtonController,
            controllerAs: 'obt',
            template: '<div class="option-bt {{obt.btcolorclass}}">'
                    + '<div ng-if="obt.textbind === undefined" class="options-bt-text align-middle"> {{::obt.text}} </div>'
                    + '<div ng-if="obt.textbind !== undefined" class="options-bt-text align-middle" ng-bind="{{::obt.textbind}}"></div>'
                    + '</div>'
    };

        return directive;
    }

    OptionButtonController.$inject = ["$scope"];
    /** @ngInject */
    function OptionButtonController($scope) {
        var vm = this;
        vm.text = $scope.text;
        vm.textbind = $scope.textbind;
        vm.btcolorclass = $scope.btcolorclass;
    }

} ());

/*! angular-pinch-zoom - v0.2.1 */
(function () {
    'use strict';

    angular
        .module('ngPinchZoom.directive', [])
        .directive('ngPinchZoom', PinchZoomDirective);

    /** @ngInject */

    /**
     * @ngdoc directive
     * @name ngPinchZoom
     * @restrict A
     * @scope false
     **/

    function PinchZoomDirective() {

        var _directive = {
            restrict: 'A',
            scope: false,
            link: _link
        };

        function _link(scope, element, attrs) {
            var elWidth, elHeight;

            // mode : 'pinch' or 'swipe'
            var mode = '';

            // distance between two touche points (mode : 'pinch')
            var distance = 0;
            var initialDistance = 0;

            // image scaling
            var scale = 1;
            var relativeScale = 1;
            var initialScale = 1;
            var maxScale = 3; //parseInt(attrs.maxScale, 10);
            // if (isNaN(maxScale) || maxScale <= 1) {
            //     maxScale = 3;
            // }

            // position of the upper left corner of the element
            var positionX = 0;
            var positionY = 0;

            var initialPositionX = 0;
            var initialPositionY = 0;

            // central origin (mode : 'pinch')
            var originX = 0;
            var originY = 0;

            // start coordinate and amount of movement (mode : 'swipe')
            var startX = 0;
            var startY = 0;
            var moveX = 0;
            var moveY = 0;

            var values = {};

            var image = new Image();
            image.onload = function () {
                elWidth = element[0].clientWidth;
                elHeight = element[0].clientHeight;

                element.on('touchstart', touchstartHandler);
                element.on('touchmove', touchmoveHandler);
                element.on('touchend', touchendHandler);
            };

            if (attrs.ngSrc) {
                image.src = attrs.ngSrc;
            } else {
                image.src = attrs.src;
            }

            scope.$on('resetZoom', function (e, args) {
                resetZoom(args.index);
            });

            function resetZoom(index) {

                scale = 1;
                relativeScale = 1;
                initialScale = 1;
                positionX = 0;
                positionY = 0;
                transformElement(0.3);

                console.log('entrou na directiva e correu a funcao resetZoom()-INDEX: ' + index);
            }

            /**
             * @param {object} evt
             */
            function touchstartHandler(evt) {

                var touches = evt.originalEvent ? evt.originalEvent.touches : evt.touches;

                if (touches.length >= 1 && scale > 1) {
                    scope.$emit('caroucelIsLocked');
                }

                if (touches.length === 1 && scale === 1) {
                    scope.$emit('caroucelIsUnlocked');
                    scope.$emit('unlockCardFlip');
                }
                if (touches.length === 1 && scale > 1) {
                    resetZoom();
                    //Prevent Card to flip
                    scope.$emit('lockCardFlip');
                }

                startX = touches[0].clientX;
                startY = touches[0].clientY;
                initialPositionX = positionX;
                initialPositionY = positionY;
                moveX = 0;
                moveY = 0;
            }

            /**
             * @param {object} evt
             */
            function touchmoveHandler(evt) {
                var touches = evt.originalEvent ? evt.originalEvent.touches : evt.touches;

                if (mode === '') {

                    if (touches.length === 1 && scale > 1) {
                        mode = 'swipe';

                        scope.$emit('caroucelIsLocked');

                        //Restore the Origin anchor point to rotate card
                        element.css({
                            '-webkit-transform-origin': 'center top 0',
                            'transform-origin': 'center top 0'
                        });
                    }
                    else if (touches.length === 1 && scale === 1) {
                        mode = '';
                        scope.$emit('caroucelIsUnlocked');

                        // Restore the original scale
                        values = { "scale": 1 };
                        scope.$emit('imageScale', values);

                    }
                    else if (touches.length === 2) {

                        mode = 'pinch';

                        scope.$emit('caroucelIsLocked');

                        initialScale = scale;
                        initialDistance = getDistance(touches);
                        originX = touches[0].clientX -
                            parseInt((touches[0].clientX - touches[1].clientX) / 2, 10) -
                            element[0].offsetLeft - initialPositionX;
                        originY = touches[0].clientY -
                            parseInt((touches[0].clientY - touches[1].clientY) / 2, 10) -
                            element[0].offsetTop - initialPositionY;

                    }
                }

                if (mode === 'swipe') {
                    evt.preventDefault();

                    scope.$emit('caroucelIsLocked');

                    moveX = touches[0].clientX - startX;
                    moveY = touches[0].clientY - startY;
                    positionX = initialPositionX + moveX;
                    positionY = initialPositionY + moveY;

                    transformElement();

                    element.css({
                        '-webkit-transform-origin': '0 0',
                        'transform-origin': '0 0'
                    });
                }
                else if (mode === 'pinch') {

                    evt.preventDefault();

                    scope.$emit('caroucelIsLocked');

                    element.css({
                        '-webkit-transform-origin': '0 0',
                        'transform-origin': '0 0'
                    });

                    distance = getDistance(touches);
                    relativeScale = distance / initialDistance;
                    scale = relativeScale * initialScale;

                    if (scale >= 1 && scale <= 3) {
                        positionX = originX * (1 - relativeScale) + initialPositionX + moveX;
                        positionY = originY * (1 - relativeScale) + initialPositionY + moveY;

                        transformElement();

                        /* INIT DEBUG
                         @TODO - REMOVE this DEBUG*/
                        var values = { "scale": scale };
                        scope.$emit('imageScale', values);
                        /* End DEBUG */
                    }
                }
            }

            /**
             * @param {object} evt
             */
            function touchendHandler(evt) {
                var touches = evt.originalEvent ? evt.originalEvent.touches : evt.touches;

                if (mode === '' || touches.length > 0) {
                    return;
                }

                //Scale minor than default
                if (scale <= 1) {

                    scope.$emit('caroucelIsUnlocked');
                    scale = 1;
                    positionX = 0;
                    positionY = 0;

                    //Restore the Origin anchor point to rotate card
                    element.css({
                        '-webkit-transform-origin': 'center top 0',
                        'transform-origin': 'center top 0'
                    });
                }

                //Scale superior from maxScale
                else if (scale > maxScale) {

                    scope.$emit('caroucelIsLocked');

                    scale = maxScale;
                    relativeScale = scale / initialScale;
                    positionX = originX * (1 - relativeScale) + initialPositionX + moveX;
                    positionY = originY * (1 - relativeScale) + initialPositionY + moveY;

                }
                //Scale superior from default but minor from maxScale
                else if (scale <= maxScale) {
                    scope.$emit('caroucelIsLocked');

                    if (positionX > 0) {
                        positionX = 0;
                    } else if (positionX < elWidth * (1 - scale)) {
                        positionX = elWidth * (1 - scale);
                    }
                    if (positionY > 0) {
                        positionY = 0;
                    } else if (positionY < elHeight * (1 - scale)) {
                        positionY = elHeight * (1 - scale);
                    }
                }

                transformElement(0.1);
                mode = '';
            }

            /**
             * @param {Array} touches
             * @return {number}
             */
            function getDistance(touches) {
                var d = Math.sqrt(Math.pow(touches[0].clientX - touches[1].clientX, 2) +
                    Math.pow(touches[0].clientY - touches[1].clientY, 2));
                return parseInt(d, 10);
            }

            /**
             * @param {number} [duration]
             */
            function transformElement(duration) {
                var transition = duration ? 'all cubic-bezier(0,0,.5,1) ' + duration + 's' : '';
                var matrixArray = [scale, 0, 0, scale, positionX, positionY];
                var matrix = 'matrix(' + matrixArray.join(',') + ')';

                element.css({
                    '-webkit-transition': transition,
                    transition: transition,
                    '-webkit-transform': matrix + ' translate3d(0,0,0)',
                    transform: matrix
                });
            }
        }

        return _directive;
    }

}());

(function () {
    'use strict';

    angular
        .module ('swipe.directive', [])
        .directive ('swipe', SwipeDirective);


    /** @ngInject */
    function SwipeDirective() {

        var directive = {
            restrict: 'E',
            controller: SwipeDirectiveeController,
            controllerAs: 'error',
            scope: {}
        };

        return directive;
    }

    SwipeDirectiveeController.$inject = ['$window', 'appConfig', '$rootScope'];
    function SwipeDirectiveeController($window, appConfig, $rootScope){
        $window.addEventListener('touchstart', handleTouchStart, false);
        $window.addEventListener('touchmove', handleTouchMove, false);

        var swipeConf = {
            'left': true,
            'right': true,
            'up': true,
            'down': true
        };

        var xDown = null;
        var yDown = null;
        var threshold = appConfig.global.swipeThreshold;

        function handleTouchStart(evt) {
            evt.stopPropagation();
            xDown = evt.touches[0].clientX;
            yDown = evt.touches[0].clientY;
        }

        function isElementInside(element, mainElement){
            if(!mainElement){
                return false;
            }

            if(!element.id){
                var parent = angular.element(element).parent();
                if( parent[0] && parent.attr("id") != "yornShakeitView") {
                    isElementInside(parent[0], mainElement);
                }
                return false;
            }


            return !!mainElement.querySelector("#" + element.id);
        }

        function handleTouchMove(evt) {
            evt.stopPropagation();
            if ($rootScope.canSwipeUp && ( ! xDown && ! yDown)) {
                xDown = evt.touches[0].clientX;
                yDown = evt.touches[0].clientY;
            }

            if ( ! xDown || ! yDown || (!$rootScope.canSwipe && !$rootScope.canSwipeUp)) {
                return;
            }

            //var achievementsContainerElement = document.getElementById("achievementsContents");
            var historyContainerElement = document.getElementById("historyContents");

            //var allowHorizontalSwipe = isElementInside(evt.srcElement, achievementsContainerElement);
            var blockVerticalSwipe = isElementInside(evt.srcElement, historyContainerElement);

            var xUp = evt.touches[0].clientX;
            var yUp = evt.touches[0].clientY;

            var xDiff = xDown - xUp;
            var yDiff = yDown - yUp;

            var _location = $window.location;
            //https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-569
            // if on gold detail use bigger threshold
            var _isDetailView = document.getElementById("previousCardButtonContainer")?true:false;
            threshold = appConfig.global.swipeThreshold;
            if(_isDetailView){
                threshold = appConfig.global.swipeCardsThreshold;
            }

            if(Math.abs(xDiff) > threshold || Math.abs(yDiff) > threshold) {
                if (($rootScope.canSwipe && Math.abs(xDiff) > Math.abs(yDiff))) {
                    if (xDiff > threshold && swipeConf.left) {
                        $rootScope.$emit(appConfig.events.swipeLeft);
                    } else if(xDiff < threshold && swipeConf.right) {
                        $rootScope.$emit(appConfig.events.swipeRight);
                    }
                } else if(!blockVerticalSwipe && ($rootScope.canSwipe || (!$rootScope.canSwipe && $rootScope.canSwipeUp))) {
                    if (yDiff > threshold && swipeConf.up) {
                        $rootScope.$emit(appConfig.events.swipeUp);
                    } else if (yDiff < threshold && swipeConf.down) {
                        $rootScope.$emit(appConfig.events.swipeDown);
                    }
                }
            }

            /* reset values */
            xDown = null;
            yDown = null;

        }
    }

} ());

(function () {
    'use strict';

    angular.module('timer.directive', []).directive("timer", TimerDirective);
    TimerDirective.$inject = ['$interval'];

    function TimerDirective($interval) {
        var timer = {
            restrict: 'A',
            transclude: true,
            scope: {
                timerStartMs: "@",
                timerEndMs: "@",
                timerTickSc: "@",
                timerMask: "@",

            },
            link: TimerDirectiveLink($interval)

        };

        return timer;
    }

    function TimerDirectiveLink($interval) {
        return function (scope, element, attrs) {
            var _timer = null;
            var _endtime = attrs.timerEndMs ? attrs.timerEndMs : -1;
            var _starttime = attrs.timerStartMs ? attrs.timerStartMs : new Date().getTime();
            var _tick = (attrs.timerTickSc === null ? 1 : attrs.timerTickSc) * 1000;
            var _time = '00:00:00';
            var _mask = (attrs.timerMask ||"hh:mi:ss").toLowerCase();

            var _duration = _endtime - _starttime;

            function _start() {
                if (_endtime > 0) {
                    _timer = $interval(function () {
                        if (_endtime > -1) {
                            if (_duration <= 0) {
                                _stop();
                                _time = '00:00:00';
                            } else {
                                _time = _udpateTimer();
                            }
                        } else {
                            _time = _udpateTimer();
                        }

                        element.text(_time);
                    }, _tick, 0);
                }
            }

            function _stop() {
                if (_timer !== null) {
                    $interval.cancel(_timer);
                    _timer = null;
                }
            }

            function _udpateTimer() {
                var _days = "";
                var _hours = "";
                var _minutes = "";
                var _parsed = "";
                var _seconds = "";

                _duration -= 1000;

                // var _date = new Date(_currtime);
                // Time calculations for days, hours, minutes and seconds
                if(_mask.indexOf("dd")> -1) {
                    _days = Math.floor(_duration / (1000 * 60 * 60 * 24));
                    _hours = ("0" + Math.floor((_duration % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))).substr(-2);
                    _minutes = ("0" + Math.floor((_duration % (1000 * 60 * 60)) / (1000 * 60))).substr(-2);
                    _seconds = ("0" + Math.floor((_duration % (1000 * 60)) / 1000)).substr(-2);
                    _parsed = _mask.replace("hh", _hours).replace("mi", _minutes).replace("ss", _seconds);

                    if (_days > 0) {
                        _parsed = _parsed.replace("dd", _days);
                    } else {
                        try {
                            _parsed = _parsed.substring(_parsed.indexOf(":") - 2);
                        } catch (error) {
                        }
                    }
                }else {
                    _hours = ("0" + Math.floor(_duration / (1000 * 60 * 60))).substr(-2);
                    _minutes = ("0" + Math.floor((_duration % (1000 * 60 * 60)) / (1000 * 60))).substr(-2);
                    _seconds = ("0" + Math.floor((_duration % (1000 * 60)) / 1000)).substr(-2);

                    _parsed = _mask.replace("hh", _hours).replace("mi", _minutes).replace("ss", _seconds);
                }
                return _parsed;
            }

            element.on('$destroy', function () {
                _stop();
            });

            _start();
        };
    }
})();
(function () {

    'use strict';

    angular.module("error.controller", []).controller("ErrorController", ErrorController);

    ErrorController.$inject=['ErrorService', 'appConfig', '$rootScope'];
    function ErrorController(ErrorService, appConfig, $rootScope) {
        $rootScope.showError();

        if(!ErrorService.getError()) {
            ErrorService.setError(appConfig.defaultError);
        }
    }
})();
(function() {
  "use strict";

  angular.module("error.directive", []).directive("errorPage", ErrorDirective);

  /** @ngInject */
  function ErrorDirective() {
    var directive = {
      templateUrl: "app/error/error.template.html",
      controller: ErrorDirectiveController,
      controllerAs: "error",
      restrict: "AE",
      scope: {
        removebuttons: "@"
      }
    };

    return directive;
  }

  ErrorDirectiveController.$inject = [
    "$scope",
    "$location",
    "$timeout",
    "ErrorService",
    "appConfig",
    "$rootScope"
  ];

  function ErrorDirectiveController(
    $scope,
    $location,
    $timeout,
    ErrorService,
    appConfig,
    $rootScope
  ) {
    var vm = this;
    vm.statusMessage = null;
    vm.statusCode = null;
    vm.showError = null;
    vm.hideBts = $scope.removebuttons === "true";
    vm.isCriticalError = false;
    vm.isTimeout = false;
    vm.isBlacklisted = false;
    vm.isMajorError = false;
    vm.location = null;

    vm.closeError = function() {
      $rootScope.canSwipe = true;

      if (vm.hideBts) {
        vm.goToLocation();
        return;
      }

      vm.showError = false;
      $timeout(function() {
        vm.showError = null;
        $rootScope.showErrorPage = false;
      }, 500);

      $timeout(function() {
        angular.element(document.getElementById("rewardForm")).remove();
        $rootScope.canSwipe = true;
        vm.goToLocation();
      }, 10);
    };

    vm.goToLocation = function() {
      if (vm.location != undefined && vm.location != null) $location.path(vm.location);
      else $location.path(appConfig.routes.landingPage);
    };

    vm.goToLoading = function() {
      $location.path(vm.location);
    }

    function init() {
      $rootScope.canSwipe = false;

      if (ErrorService.getError()) {
        var _error = ErrorService.getError();
        console.log("_error", _error);
        vm.statusMessage = _error.statusMessage;
        vm.statusCode = _error.statusCode;
        vm.location = _error.location;
        vm.isTimeout = vm.statusCode == appConfig.statusCode.TIMEOUT;
        vm.isBlacklisted = vm.statusCode == appConfig.statusCode.ERROR_USER_BLACKLISTED;
        vm.isHotline = vm.statusCode === appConfig.statusCode.ERROR_AUTH_HOTLINE_PRE_PAID || vm.statusCode === appConfig.statusCode.ERROR_AUTH_HOTLINE_POST_PAID;
        vm.isMajorError = vm.isTimeout || vm.isBlacklisted || vm.isHotline;

        if (appConfig.criticalErrors.indexOf(_error.statusCode) > -1) {
          vm.isCriticalError = true;
        }

        vm.showError = true;
      }
    }
    init();
  }
})();

(function () {
    'use strict';

angular.module("error.service", []).service("ErrorService", ErrorService);


function ErrorService (){

	var _error= null;

	return {
		getError: _getError,
		setError: _setError
	};

	function _getError (){
		return _error;
	}

	function _setError(error){
		_error = error;
	}

}

})();

(function () {
  "use strict";

  angular.module("exchangecardfriend.controller", []).controller("ExchangeCardFriendController", ExchangeCardFriendController);

  ExchangeCardFriendController.$inject = [
    "$animateCss",
    "$document",
    "$location",
    "$log",
    "$rootScope",
    "$timeout",
    "CacheService",
    "DataService",
    "appConfig",
    "$scope",
    '$window',
    "NearbyService"
  ];

  var ECFState = {
    "Error": 0,
    "Connecting": 1,
    "NoCards": 2,
    "SelectedCard": 3,
    "Aborted": 4,
    "ConnectTimeOut": 5,
    "CardSelectPending": 6,
    "CardSelectTimeout": 7,
    "CardSelectOk": 8,
    "CardTradePending": 9,
    "CardTradeTimeout": 10,
    "CardTradeOK": 11

  }
  Object.freeze(ECFState);

  function ExchangeCardFriendController($animateCss, $document, $location, $log, $rootScope, $timeout, CacheService, DataService, appConfig, $scope, $window, NearbyService) {
    var vm = this;
    vm.state = ECFState.Connecting;
    vm.msisdn = $rootScope.exchangeFriend.msisdn;
    vm.tradeableCards = null;
    vm.selectedCard = null;
    vm.advanceButtonActive = false;
    vm.sentCard = null;
    vm.receivedCard = null;
    vm.exchangeReturn = null;
    vm.goBack = goBack;
    vm.clickOnCard = clickOnCard;
    vm.confirmTrade = confirmTrade;
    vm.exchangeCardFriend = exchangeCardFriend;
    vm.keepNearbyActive = false;

    (function init() {
      $log.debug("[ExchangeCardFriendController][init]: Started!");

      vm.keepNearbyActive = false;
      DataService.connectToFriend(vm.msisdn).then(function (result) {
        alterState(result);
      });

    })();



    function alterState(result) {
      $log.debug("[ExchangeCardFriendController][alterState]:  " + JSON.stringify(result));
      if (result != null && result.statusCode === 0) {
        switch (result.result) {

          case "CONNECT_PENDING":
            $timeout(function () {
              checkStatusFriend();
            }, 5000);
            break;
          case "ERROR_INTERACTION_ABORTED":
          case "INTERACTION_ABORTED":
            vm.state = ECFState.Aborted;
            break;
          case "CONNECT_TIMEOUT":
            vm.state = ECFState.ConnectTimeOut;
            break;
          case "CARD_SELECT_PENDING":
            vm.state = ECFState.CardSelectPending;
            $timeout(function () {
              checkStatusFriend();
            }, 5000);
            break;
          case "CARD_SELECT_TIMEOUT":
            vm.state = ECFState.CardSelectTimeout;
            break;
          case "CARD_SELECT_OK":
            vm.state = ECFState.CardSelectOk;
            vm.sentCard = result.sentCard;
            vm.receivedCard = result.receivedCard;
            break;
          case "CARD_TRADE_PENDING":
            vm.state = ECFState.CardTradePending;
            $timeout(function () {
              checkStatusFriend();
            }, 5000);
            break;
          case "CARD_TRADE_OK":
            vm.state = ECFState.CardTradeOK;
            vm.exchangeReturn = result.exchangeReturn;
            vm.exchangeReturn.canContinueExchange = result.canContinueExchange;
            $rootScope.exchangeReturn = vm.exchangeReturn;
            $location.path(appConfig.routes.booklet);
            break;
          case "CARD_TRADE_TIMEOUT":
            vm.state = ECFState.CardTradeTimeout;
            break;
          case "ERROR_NO_CARDS":
            vm.state = ECFState.NoCards;
            break;
          case "CONNECT_OK":
            vm.state = ECFState.SelectedCard;
            vm.tradeableCards = result.tradeableCards;
            break;
          default:
          case "ERROR_CARD_NOT_REPEATED":
          case "ERROR_FRIEND_HAS_CARD":
          case "ERROR_NOT_CONNECTED":
          case "ERROR_CARD_NOT_SELECTED":
          case "ERROR_GENERIC":
            vm.state = ECFState.Error;
            break;
        }
      }
    }

    function checkStatusFriend() {
      DataService.checkStatusFriend(vm.msisdn).then(function (result) {
        alterState(result);
      });
    }

    function clickOnCard(index) {

      for (var i = 0; i < vm.tradeableCards.length; i++)
        vm.tradeableCards[i].selected = false;

      vm.tradeableCards[index].selected = true;
      vm.selectedCard = vm.tradeableCards[index];
      vm.advanceButtonActive = true;
    }

    function exchangeCardFriend() {
      if (vm.advanceButtonActive == true && vm.selectedCard !== null) {
        DataService.selectCard(vm.msisdn, vm.selectedCard.cardId).then(function (result) {
          alterState(result);
        });
      }
    }

    function goBack() {
      vm.keepNearbyActive = true;
      $log.debug("[ExchangeCardFriendController][goBack]");
      DataService.abortExchangeCardFriend().then(function (result) {
        $rootScope.exchangeFriend = null;
        $log.debug("[ExchangeCardFriendController][goBack][Abort] " + JSON.stringify(result));
      });
      $window.history.back();
    }

    function confirmTrade() {
      DataService.confirmTrade(vm.msisdn).then(function (result) {
        $log.debug("[ExchangeCardFriendController][confirmTrade] Playing Sound.");
        alterState(result);
        $rootScope.mcareIntegration({
          'playSound': true,
          'action': 'confirmTrade'
        });
      });
    }

    $scope.$on("$destroy", function () {
      if (vm.keepNearbyActive !== true && $rootScope.nearByIsEnabled === true) {
        NearbyService.stopAPI("ExchangeCardFriendController");
      }
    });

  }
})();
(function () {
	'use strict';

	angular.module('exchangecardfriendoverlay.directive', []).directive('exchangecardfriendoverlay', ExchangecardFriendOverlayDirective).controller("ExchangecardFriendOverlayController", ExchangecardFriendOverlayController);

	/** @ngInject */
	function ExchangecardFriendOverlayDirective() {
		var directive = {
			restrict: 'E',
			templateUrl: 'app/exchangecardfriendoverlay/exchangecardfriendoverlay.template.html',
			scope: true,
			controller: ExchangecardFriendOverlayController,
			controllerAs: 'exchangecardfriendoverlay'
		};

		return directive;
	}

	ExchangecardFriendOverlayController.$inject = ['$scope', '$timeout', 'appConfig', 'DataService', '$rootScope', '$location', '$window', '$log'];
	/** @ngInject */
	function ExchangecardFriendOverlayController($scope, $timeout, appConfig, DataService, $rootScope, $location, $window, $log) {
		var vm = this;
		vm.showActions = true;
		vm.exchgcardf = $scope.$parent.exchgcardf;

		vm.closeOverlay = function () {
			$log.debug("[ExchangecardFriendOverlayController][closeOverlay]");
			DataService.abortExchangeCardFriend().then(function (result) {
				$rootScope.exchangeFriend = null;
				$log.debug("[ExchangecardFriendOverlayController][closeOverlay][Abort] ", result);
			});
			$window.history.back();
		};

		vm.confirmTrade = function () {
			vm.exchgcardf.confirmTrade();
		}
	}

})();
(function () {
    'use strict';

    angular.module("exchangecards.controller",[]).controller("ExchangeCardsController", ExchangeCardsController);

    ExchangeCardsController.$inject = ["$animateCss", "$document", "$location", "$log","$rootScope", "$timeout", "CacheService", "DataService", "appConfig"];

    function ExchangeCardsController ($animateCss, $document, $location, $log, $rootScope, $timeout, CacheService, DataService, appConfig){

        var _cardslocked = false;
        var _doc = $document[0];
       
        var vm = this;
        vm.buttonActive = false;
        vm.carddeckCover = null;
        vm.cardPlaceholder = "app/assets/images/exchangecards/card_placeholder.png";
        vm.hasmoreRepeatedCards = false;
        vm.repeatedCards = null;
        vm.showsuccess = false;

        vm.continueexchangingcards = continueexchangingcardsforshakes;
        vm.exchangecardsforshake = exchangecardsforshake;       
        vm.galleryCardClick = galleryCardClick;       
        vm.slotCardClick = slotCardClick;       
        vm.updateButtonStatus = updateButtonStatus;
        vm.shakeit = shakeitnow;
        vm.repeatedCards = null;
        vm.cardsMap = [];        
        vm.cardSlots = [];
        vm.numSlots = 4;


        $rootScope.cardsMap = vm.cardsMap;
        
        (function init(){
            $log.debug("[ExchangeCardsController][init]: Started!");            
            CacheService.getUserShakesStatus().then(function(_headerinfo) {
                vm.headerInfo = _headerinfo;
                vm.headerInfo.tempDuplicated = _headerinfo.duplicated;
                _buildCardGallery();
            });
            angular.element(_doc.getElementById("yornHeader")).ready(function() {
                angular.element(_doc.querySelector("#yornTitleContainer")).css({
                    padding: "4% 11% 8% 0%"
                });
            });
        })();
        
        function updateButtonStatus() {
            var canExchange = true;
            for (var i = 0; i < vm.numSlots; i++) {                
                if (vm.cardSlots[i].isFilled == false) {
                    canExchange = false;
                    break;
                }
            }
            vm.buttonActive = canExchange;
        }

        function _buildCardGallery() {
            vm.cardSlots = [];
            for (var i = 0; i < vm.numSlots; i++) {
                vm.cardSlots.push({isFilled: false});
            }                       
            CacheService.getListOfDuplicatedCards(true).then(function (_cardInfo) {
                vm.repeatedCards = _cardInfo.duplicates;
                for (var index = 0; index < vm.repeatedCards.length; index++) {
                    vm.repeatedCards[index].show = true;               
                }
                // console.log(vm.repeatedCards);
            });            
        }


        function continueexchangingcardsforshakes(){
            $log.debug("[ExchangeCardsController][continueexchangingcardsforshakes]: Started!");
            $location.path(appConfig.routes.cardsexchange);
            
            //Reset data
            vm.showsuccess = false;
            $rootScope.canSwipe = true;
            vm.cardPlaceholder = "app/assets/images/exchangecards/card_placeholder.png";
            vm.buttonActive = false;
            _cardslocked = false;    
            _buildCardGallery();        
        }

        function exchangecardsforshake(){
            $log.debug("[ExchangeCardsController][exchangecardsforshake]: Started!");
            //prepare list of card ids
            var cardIds = "" + vm.cardSlots[0].card.cardId;
            for (var i = 1; i < vm.numSlots; i++) {
                cardIds += "," + vm.cardSlots[i].card.cardId;
            }
            vm.buttonActive = false;
            $rootScope.canSwipe = false;
            $log.debug("[ExchangeCardsController][exchangecardsforshake]: exchanging cards in list : " + cardIds);
            DataService.exchangeRepeatedCards(cardIds).then(function(response){                
                vm.headerInfo.duplicated = response.duplicated = vm.headerInfo.tempDuplicated;
                
                vm.headerInfo.shakesAvailable++;
                $rootScope.$broadcast("udpateHeaderValues", vm.headerInfo);

                vm.showsuccess = true;
                CacheService.getUserShakesStatus(true);
                _cardslocked = false;
            }, function(error){
                $log.error("[ExchangeCardsController][exchangecardsforshake]: ERROR! Not yet treated");
                vm.showsuccess = true;
                _cardslocked = false;
            });
        }
       
        function shakeitnow(){
            $log.debug("[ExchangeCardsController][shakeitnow]: Started!");

            $location.path(appConfig.routes.landingPage);
        }

        function moveToPlaceholder(cardId, slotIndex){
            $log.debug("[ExchangeCardsController][moveToPlaceholder]: Started!");

            var position = _doc.getElementById("cardPlaceHolderImage" + slotIndex);                            
            var card = _doc.getElementById("galleryCard" + cardId);
            var oldW = position.width;
            var oldH = position.height;
            position.src = card.src;
            //restore placeholder widths
            position.width = oldW;
            position.height = oldH;            
        }   

        function moveToDeck(slotIndex){
            $log.debug("[ExchangeCardsController][moveToPlaceholder]: Started!");

            var position = _doc.getElementById("cardPlaceHolderImage" + slotIndex);            
            position.src = vm.cardPlaceholder;            
        }        
        
        function galleryCardClick(card) {
            for (var i=0; i < vm.numSlots; i++) {
                if (vm.cardSlots[i].isFilled == false) {
                    moveToPlaceholder(card.cardId, i + 1);
                    if (card.numberOfRepeats == 1) {
                        card.show = false;
                    } else {
                        card.numberOfRepeats--;
                    }
                    vm.cardSlots[i].isFilled = true; 
                    vm.cardSlots[i].card = card; 
                    updateButtonStatus();
                    $log.debug("[ExchangeCardsController][galleryCardClick]: Moved card " 
                        + card.cardId + " from gallery to slot " + (i + 1));
                    break;
                }
            }            
        }

        function slotCardClick(slotIndex) {
            var slot = vm.cardSlots[slotIndex];
            var card = slot.card;
            if (slot.isFilled == true) {
                if (card.show == false) {
                    card.show = true;
                } else {
                    card.numberOfRepeats++;
                }                       
                //slot elements ids are from 1 to N 
                moveToDeck(slotIndex + 1);
                slot.isFilled = false;
                slot.card = null;                
                updateButtonStatus();
                $log.debug("[ExchangeCardsController][slotCardClick]: Moved card " 
                    + card.cardPosition + " from slot " + (slotIndex + 1) + " to deck");
            }            
        }

    }

})();
(function() {
  "use strict";

  angular
    .module("exchangecardsforwildcard.controller", [])
    .controller("ExchangeCardsWildcardController", ExchangeCardsWildcardController);

  ExchangeCardsWildcardController.$inject = [
    "$animateCss",
    "$document",
    "$location",
    "$translate",
    "appConfig",
    "$log",
    "$rootScope",
    "$timeout",
    "CacheService",
    "ErrorService",
    "DataService"
  ];

  function ExchangeCardsWildcardController(
    $animateCss,
    $document,
    $location,
    $translate,
    appConfig,
    $log,
    $rootScope,
    $timeout,
    CacheService,
    ErrorService,
    DataService
  ) {
    var doc = $document[0];
    var vm = this;
    vm.disableSubmitButton = false;
    vm.isSubmiting = false;
    vm.repeatedCards = null;
    vm.showsuccess = false;

    vm.selectedCounter = 0;
    vm.exchangeCardsPrizeEnabled = $rootScope.exchangeCardsPrizeEnabled;
    vm.exchangeCardsPrizeNumCards = $rootScope.exchangeCardsPrizeNumCards;

    vm.galleryCardClick = galleryCardClick;
    vm.updateButtonStatus = updateButtonStatus;
    vm.exchangecards = exchangecards;
    vm.stickyHeader = stickyHeader;
    vm.goBack = goBack;
    vm.arraySelected = [];

    (function init() {
      $log.debug("[ExchangeCardsController][init]: Started!");
      stickyHeader();
      vm.responseMessage = undefined;

      CacheService.getUserShakesStatus().then(function(_headerinfo) {
        console.log("headerINfo no INIT: ", _headerinfo);
        vm.headerInfo = _headerinfo;
        vm.headerInfo.tempDuplicated = _headerinfo.duplicated;
        _buildCardGallery();
      });
    })();

    $rootScope.$on("closeCard", function(event) {
      $location.path(appConfig.routes.exchangetype);
    });

    function stickyHeader() {
      angular.element(doc.getElementById("yornHeader")).ready(function() {
        angular.element(doc.querySelector("#yornHeader")).css({
          position: "fixed",
          transform: "translate3d(0,0,0)",
          "z-index": "2",
          width: "100%"
        });
        angular.element(doc.querySelector("#yornTitleContainer")).css({
          position: "relative",
          top: "10vh",
          padding: "4% 11% 8% 0%"
        });
        angular.element(doc.querySelector("#exchangeCardsBody")).css({ "padding-top": "160px" });
        angular.element(doc.querySelector("#headerCardsHolder")).css({ top: "12%" });
        angular.element(doc.querySelector("#headerShakeHolder")).css({ top: "12%" });
        $timeout(function() {
          var headerMB = angular.element(doc.querySelector("#headerMysteryBoxHolder"));
          if (headerMB) {
            if (headerMB.length && headerMB[0].classList.contains("mysterybox-open")) {
              headerMB.css({ top: "8%" });
            } else {
              headerMB.css({ top: "12%" });
            }
          }
        }, 1);
        angular.element(doc.querySelector("#yornLogo")).css({ top: "6%" });
      });
    }

    function updateButtonStatus() {
      vm.disableSubmitButton = vm.arraySelected.length === vm.exchangeCardsPrizeNumCards;

      vm.selectedCounter = vm.arraySelected.length;
    }

    function goBack() {
      console.log("clicou no goback");
      resetPage();
      $location.path(appConfig.routes.cardsexchange);
    }

    function _buildCardGallery() {
      CacheService.getListOfDuplicatedCards(true).then(function(_cardInfo) {
        var repeatedCards = _cardInfo.duplicates;
        var cardsArray = [];
        for (var index = 0; index < repeatedCards.length; index++) {
          //Repeat element array the same number of repeats
          var repeats = repeatedCards[index].numberOfRepeats;

          //Rebuild array to show repeated Cards in the deck
          for (var i = 0; i < repeats; i++) {
            cardsArray = cardsArray.concat(repeatedCards[index]);
          }
        }
        //All Cards
        vm.repeatedCards = cardsArray;
      });
    }

    /**
     * Method to build an array of ID's of the selected Cards
     * @param card - Object card selected on the cards list
     * @param index - index array of the card
     */
    function galleryCardClick(card, index) {
      // Verify if selected not exceed the max selections permit
      if (vm.arraySelected.length < vm.exchangeCardsPrizeNumCards) {
        //Card will be selected
        if (card[index].selected) {
          //Add to array
          vm.arraySelected.push(card.cardId);
          updateButtonStatus();
        }
        // Card will be un-selected
        else if (card[index].selected === false) {
          //Remove from array
          var indexToRemove = vm.arraySelected.indexOf(card.cardId);
          if (indexToRemove > -1) {
            vm.arraySelected.splice(indexToRemove, 1);
          }
          updateButtonStatus();
        }
      }
      //Number of selected will EXCEED the max selections permit
      else {
        // Card can be selected - permit no further selections
        if (card[index].selected) {
          card[index].selected = false;
        }
        // Card is already selected, permit un-selecting this card
        else {
          //Remove it from the array
          indexToRemove = vm.arraySelected.indexOf(card.cardId);
          if (indexToRemove > -1) {
            vm.arraySelected.splice(indexToRemove, 1);
          }
          updateButtonStatus();
        }
      }
    }

    function exchangecards() {
      vm.disableSubmitButton = true;
      vm.isSubmiting = true;
      var cardIds = "" + vm.arraySelected[0];
      for (var i = 1; i < vm.exchangeCardsPrizeNumCards; i++) {
        cardIds += "," + vm.arraySelected[i];
      }

      //Send to BE
      DataService.exchangeRepeatedCardsForPrize(cardIds).then(
        function(response) {
          console.log("response", response);
          if (response) {
            //Disable button on submit
            vm.disableSubmitButton = false;
            vm.showsuccess = true;

            vm.prize = {
              prize: response.prize,
              type: "JOKER"
            };

            //Update Header Values
            vm.headerInfo.duplicated = response.duplicated;
            $rootScope.$broadcast("udpateHeaderValues", vm.headerInfo);
            vm.isSubmiting = false;
          }
        },
        function(error) {
          $log.error("[ExchangeCardsWildcardController][exchangecardsforwildcard]: ERROR!", error);
          vm.showsuccess = false;
        }
      );
    }
  }
})();

(function () {
  "use strict";

  angular.module("exchangefriends.controller", []).controller("ExchangeFriendsController", ExchangeFriendsController);

  ExchangeFriendsController.$inject = [
    "$animateCss",
    "$document",
    "$location",
    "$log",
    "$rootScope",
    "$timeout",
    "CacheService",
    "DataService",
    "appConfig",
    "$scope",
    "NearbyService"
  ];

  function Friend(data) {
    var _friend = {
      msisdn: data.msisdn,
      name: data.name,
      photoBase64: data.photoBase64,
      yornCode: data.yornCode,
      label: data.name ? data.name : data.yornCode ? data.yornCode : data.msisdn,
      selected: false,
      hasPhoto: data.photoBase64 ? true : false,
      image: function () {
        if (this.hasPhoto === true) {
          return "data:image/png;base64," + this.photoBase64;
        } else {
          return ''; //no photo. use default background
        }
      }
    };
    return _friend;
  }

  function ExchangeFriendsController($animateCss, $document, $location, $log, $rootScope, $timeout, CacheService, DataService, appConfig, $scope, NearbyService) {
    var vm = this;
    vm.maxHorizontalFriends = 5;
    vm.friends = [];
    vm.friendsOnDeviceFound = friendsOnDeviceFound;
    vm.friendsOnDeviceLost = friendsOnDeviceLost;
    vm.clickFriend = clickFriend;
    vm.displayMoreFriends = displayMoreFriends;
    vm.exchangecardfriend = exchangecardfriend;
    vm.selectedFriend = null;
    vm.showPlusButton = false;
    vm.advanceButtonActive = false;
    vm.yornCode = $rootScope.yornCode;
    vm.keepNearbyActive = false;
    vm.showExtendedView = false;
    vm.gotoEditReferralCode = gotoEditReferralCode;

    $scope.vm = vm;

    (function init() {
      $log.debug("[ExchangeFriendsController][init]: Started!");
      DataService.setUserVisibility(true);

      vm.keepNearbyActive = false;

      //Remove all previous attempts to connect
      DataService.abortExchangeCardFriend().then(function (result) {
        console.log(result);
      });

      // start nearby engine, if not started already
      if ($rootScope.nearByIsEnabled !== true) {
        NearbyService.startAPI("ExchangeFriendsController");
      }

    })();

    $scope.$on("$destroy", function () {
      DataService.setUserVisibility(false);
      if (vm.keepNearbyActive !== true && $rootScope.nearByIsEnabled === true) {
        NearbyService.stopAPI("ExchangeFriendsController");
      }

    });

    function friendsOnDeviceFound(content) {
      console.log("friendsOnDeviceFound " + content);
      var device = JSON.parse(content);
      //fetch user info from server
      DataService.getUserInfo(device.msisdn).then(function (_userInfo) {
        if (!_userInfo.yornCode) {
          console.log("friendsOnDeviceFound: received empty info. User might be invisible ");
          return;
        }
        device.yornCode = _userInfo.yornCode;
        device.name = _userInfo.name;
        device.photoBase64 = _userInfo.photoBase64;

        var friend = new Friend(device);
        var exists = false;
        for (var i = 0; i < vm.friends.length; i++) {
          if (vm.friends[i].msisdn === friend.msisdn) {
            exists = true;
            break;
          }
        }

        if (exists === false) {
          vm.friends.push(friend);
          vm.showPlusButton = vm.friends.length > vm.maxHorizontalFriends;

          if (vm.friends.length === 1) {
            $log.debug("[ExchangeFriendsController][friendsOnDeviceFound] Playing Sound.")
            $rootScope.mcareIntegration({
              'playSound': true,
              'action': 'foundFriend'
            });
          }

          $scope.$apply();
        }
      });

    }

    function friendsOnDeviceLost(content) {
      console.log("friendsOnDeviceLost" + content);
      var oldFriend = new Friend(JSON.parse(content));

      //If remove it the one selected
      if (vm.selectedFriend != null) {
        if (oldFriend.msisdn === vm.selectedFriend.msisdn) {
          vm.advanceButtonActive = false;
          vm.selectedFriend = null;
        }
      }

      //remove from friends
      for (var i = 0; i < vm.friends.length; i++) {
        if (vm.friends[i].msisdn === oldFriend.msisdn) {
          vm.friends.splice(i, 1);
          break;
        }
      }

      vm.showPlusButton = vm.friends.length > vm.maxHorizontalFriends;
      $scope.$apply();
    }

    function clickFriend(index) {
      for (var i = 0; i < vm.friends.length; i++) vm.friends[i].selected = false;
      vm.friends[index].selected = true;
      vm.advanceButtonActive = true;
      vm.selectedFriend = vm.friends[index];
    }

    function displayMoreFriends() {
      vm.showExtendedView = true;
      $scope.$apply();
    }

    function exchangecardfriend() {
      vm.keepNearbyActive = true;
      $rootScope.exchangeFriend = vm.selectedFriend;
      $location.path(appConfig.routes.exchangecardfriend);
    }

    function gotoEditReferralCode() {
      $rootScope.winshakesEditOnEnter = true;
      $location.path(appConfig.routes.winshakes);
    }
  }
})();
(function () {
    'use strict';

    angular.module("exchangetype.controller", []).controller("ExchangeTypeController", ExchangeTypeController);

    ExchangeTypeController.$inject = ["$animateCss", "$document", "$location", "$log", "$rootScope", "$timeout", "CacheService", "DataService",
        "appConfig", "ErrorService", "$translate", "NearbyService", "$routeParams"
    ];

    function ExchangeTypeController($animateCss, $document, $location, $log, $rootScope, $timeout, CacheService, DataService,
        appConfig, ErrorService, $translate, NearbyService,  $routeParams) {

        var _cardslocked = false;
        var doc = $document[0];
        var repeatedCards;
        var vm = this;
        vm.exchangecardswithfriendButtonDisabled = false;
        vm.exchangecardsforwildcardButtonDisabled = false;
        vm.repeatedCards = null;
        vm.showOopsOverlay = false;
        vm.apiIsAvailable = true;
        vm.update = update;
        vm.closeOverlay = closeOverlay;
        vm.back = back;
        vm.exchangecardsforshakes = exchangecardsforshakes;
        vm.exchangecardswithfriend = exchangecardswithfriend;
        vm.exchangecardsforwildcard = exchangecardsforwildcard;
        vm.oopsOverlayMsg = {
            textKey : null,
            imageSrc : null
        };

        function init() {
            if ($rootScope.show3gError === true) {
                $rootScope.show3gError = undefined;
                vm.showOopsOverlay = true;
                    vm.oopsOverlayMsg.textKey = 'text.exchangetype.not.possible.to.authenticate.user.description';
            }
            $log.debug("[ExchangeTypeController][init]: Started!");
            var result = $routeParams.result;
            $location.search('result', null);
            //Check if it is after 3g authentication
            switch (result){
                case "USER_IS_IN_3G":{
                    $rootScope.show3gError = false;
                    exchangeWithFriendInfo();
                }
                case "ERROR_NOT_POSSIBLE_TO_AUTHENTICATE_USER":{
                    $rootScope.show3gError = true;
                }
            }
            stickyHeader();
            CacheService.getListOfDuplicatedCards(true).then(function (_cardInfo) {
                vm.repeatedCards = _cardInfo.duplicates;
            });

        }

        function exchangecardsforshakes() {
            $location.path(appConfig.routes.cardsexchange);
        }

        function stickyHeader() {
            angular.element(doc.getElementById("yornHeader")).ready(function() {
              angular.element(doc.querySelector("#yornHeader")).css({
                position: "fixed",
                transform: "translate3d(0,0,0)",
                "z-index": "2",
                width: "100%"
              });
              angular.element(doc.querySelector("#yornTitleContainer")).css({
                position: "relative",
                top: "10vh",
                padding: "4% 11% 8% 0%"
              });
              angular.element(doc.querySelector("#exchangeCardsBody")).css({ "padding-top": "160px" });
              angular.element(doc.querySelector("#headerCardsHolder")).css({ top: "12%" });
              angular.element(doc.querySelector("#headerShakeHolder")).css({ top: "12%" });
              $timeout(function() {
                var headerMB = angular.element(doc.getElementById("headerMysteryBoxHolder")); //
                if (headerMB) {
                  if (headerMB[0].classList.contains("mysterybox-open")) {
                    headerMB.css({ top: "8%" });
                  } else {
                    headerMB.css({ top: "12%" });
                  }
                }
              }, 1);
              angular.element(doc.querySelector("#yornLogo")).css({ top: "6%" });
            });
          }

        function exchangecardswithfriend() {

            if(vm.exchangecardswithfriendButtonDisabled){
               return;
            }
            //Check if nearby API is available
            if (NearbyService.isAPIAvailable() !== true) {
                vm.showOopsOverlay = true;
                vm.apiIsAvailable = false;
                vm.oopsOverlayMsg.textKey = 'text.exchangetype.update.description';
                return;
            }

            DataService.getExchangeCardsInitialize().then(function (response) {
                vm.exchangecardswithfriendButtonDisabled = true;

                if(response.result === "USER_LOGIN_VALIDATED"){
                    exchangeWithFriendInfo();
                    return;
                }

                if(response.result === "ERROR_NOT_POSSIBLE_TO_AUTHENTICATE_USER") {
                    vm.showOopsOverlay = true;
                    vm.oopsOverlayMsg.textKey = 'text.exchangetype.not.possible.to.authenticate.user.description';
                    return;
                }

                $rootScope.gatewayUrl = response.serviceUrl;

                if (!$rootScope.gatewayUrl) {
                    showErrorIsNoPossibleToExchangeCards();
                    return;
                }
                $log.debug("3g validation url is: " + $rootScope.gatewayUrl);
                window.location.href = $rootScope.gatewayUrl;
             });
        }

        function exchangeWithFriendInfo() {
            DataService.getExchangeWithFriendInfo().then(function (_exchangeInfo) {
                $rootScope.yornCode = _exchangeInfo.yornCode;
                vm.exchangecardswithfriendButtonDisabled = false;
                if (_exchangeInfo.isExchangeEnabled === true) {
                    $location.path(appConfig.routes.exchangefriends);
                } else {
                    showErrorIsNoPossibleToExchangeCards();
                }
            });
        }

        function exchangecardsforwildcard(){
            $location.path(appConfig.routes.exchangecardsforwildcard);
        }


        function showErrorIsNoPossibleToExchangeCards(){
            //generic error
            ErrorService.setError({
                "statusMessage": $translate.instant("text.error.exchangefriends.message")
            });

            $rootScope.showError();

            vm.exchangecardswithfriendButtonDisabled = false;
        }

        function update() {
            if ($rootScope.isAndroid) {
                var androidStoreLink = "market://details?id=com.vodafone.mCare";
                if (appConfig.androidStoreLink != undefined)
                    androidStoreLink = appConfig.androidStoreLink;
                window.open(androidStoreLink, "_self")
            } else if ($rootScope.isIOS) {
                var iOSStoreLink = "itms-apps://itunes.apple.com/app/id400485671";
                if (appConfig.iOSStoreLink != undefined)
                    iOSStoreLink = appConfig.iOSStoreLink;
                window.open(iOSStoreLink, "_self")
            }
        }

        function closeOverlay() {
            var container = document.getElementById("exchangeTypeOverlayContainer");
            container.className = "animated fadeOut";
            vm.showOopsOverlay = false;
            vm.exchangecardswithfriendButtonDisabled = false;
        }

        function back(){
            //$window.history.back();
            closeOverlay();
        }

        init();
    }

})();

(function () {
    'use strict';

    angular.module('htmlSafe.filter', []).filter("htmlSafe", HtmlSafe);
	HtmlSafe.$inject = ['$sce'];
	
	function HtmlSafe($sce) {
	    return function(htmlCode){
	        return $sce.trustAsHtml(htmlCode);
	    };
	}
})();
(function () {
    'use strict';

    angular.module('header.directive', []).directive('yornHeader', YornHeader);

    /** @ngInject */
    function YornHeader() {
        var directive = {
            restrict: 'AE',
            templateUrl: 'app/header/header.template.html',
            transclude: true,
            scope: {
                title: '@',
                subtitle: '@',
                logoVisible: '=',
                menuVisible: '=',
                showBack: '=?',
                showUp: '=?'
            },
            controller: YornHeaderController,
            controllerAs: 'header'
        };

        return directive;
    }

    YornHeaderController.$inject = ['$location', 'appConfig', 'CacheService', 'DataService', '$scope', '$rootScope', '$timeout'];
    /** @ngInject */
    function YornHeaderController($location, appConfig, CacheService, DataService, $scope, $rootScope, $timeout) {
        var vm = this;
        vm.headerInfo = {};
        vm.back = _back;
        vm.mysteryBoxStatus = $rootScope.mysteryBoxStatus; // 0 - Not Available // 1 - Available To Open // 2 - Available Opened
        vm.mysteryBoxAvailable = false;
        vm.showShakesPlus = false;
        vm.navigateToMysteryBox = function () {            
            if ($location.path() === appConfig.routes.mysterybox 
                || $location.path() === "/" + appConfig.routes.mysterybox) {
                $scope.$emit(appConfig.events.openMysteryBox);                
            } else {         
                $location.path(appConfig.routes.mysterybox);
            }
        };

        vm.navigateToCardsExchange = function () {
            $location.path(appConfig.routes.exchangetype);
        };

        vm.navigateToHome = function () {
            $location.path(appConfig.routes.landingPage);
        };

        var updateUserShakesStatus = $rootScope.$on(appConfig.events.updateUserShakesStatus, function () {
            updateHeaderInfo();
        });

        var updateMysteryBoxStatusEvent = $rootScope.$on(appConfig.events.updateMysteryBox, function () {
            updateMysteryBoxStatus();
        });

        $rootScope.$on('$destroy', function () {
            updateUserShakesStatus();
        });

        $rootScope.$on('udpateHeaderValues', function (event, headerInfo) {
            CacheService.setUserShakesStatus(headerInfo);
            updateHeaderInfo();
        });

        function init() {
            updateHeaderInfo();
            updateMysteryBoxStatus();
        }

        function _back(_active) {
            if (_active === true) {
                $rootScope.animationClass = "slideright";
                $timeout(function () {
                    window.history.back();
                });
            }
        }

        function updateHeaderInfo() {            
            CacheService.getUserShakesStatus().then(function (_userShakesStatus) {
                vm.headerInfo.duplicated = _userShakesStatus.duplicated;
                vm.showShakesPlus = _userShakesStatus.shakesAvailable > appConfig.global.maxShakes;
                vm.headerInfo.shakesAvailable = (vm.showShakesPlus ? appConfig.global.maxShakes : _userShakesStatus.shakesAvailable);
            });
        }

        function updateMysteryBoxStatus() {
            vm.mysteryBoxStatus = $rootScope.mysteryBoxStatus;
            CacheService.getMysteryBoxStatus().then(function (result) {                
                if (result.mysteryBoxEnabled) {
                    if (result.canOpen) {
                        vm.mysteryBoxStatus = 1;
                    } else
                        vm.mysteryBoxStatus = 2;
                } else
                    vm.mysteryBoxStatus = 0;
                $rootScope.mysteryBoxStatus = vm.mysteryBoxStatus;
            });
        }
        init();
    }

})();
(function () {
    'use strict';

    angular.module("history.controller", []).controller("HistoryController", HistoryController);

    HistoryController.$inject = ["DataService", "$document", "$location", "$log", "$rootScope", "$scope", "$timeout", "$window", "appConfig"];

    function HistoryController(DataService, $document, $location, $log, $rootScope, $scope, $timeout, $window, appConfig) {
        var vm = this;
        var _model = null;
        var _userPrizes = null;

        vm.playsSelected = false;
        vm.prizeSelected = false;

        vm.prizesItems = [];
        vm.hasMorePrizes = true;
        vm.prizesLastMonthIndex = 0;

        vm.playsItems = [];
        vm.hasMorePlays = true;
        vm.playsLastMonthIndex = 0;

        vm.items = vm.prizesItems;
        vm.selectTab = _selectTab;
        vm.goToProfile = _goToProfile;
        vm.redeemPrize = _redeemPrize;


        vm.checkLastItemDisplayed = checkLastItemDisplayed;

        var paramTab = $location.search();

        if (paramTab && paramTab.tab && paramTab.tab === "1") {
            vm.items = vm.playsItems;
            vm.playsSelected = true;
            vm.prizeSelected = false;
        } else {
            vm.items = vm.prizesItems;
            vm.playsSelected = false;
            vm.prizeSelected = true;
        }

        function _getHistoryPrizes() {
            $log.debug("[HistoryController][_getHistoryPrizes]");

            if (!vm.hasMorePrizes)
                return;

            DataService.getHistory("prizes", vm.prizesLastMonthIndex, 1).then(function (_result) {
                _model = _result;

                if (_model.getPrizes().length === 0 && vm.prizesLastMonthIndex !== 0)
                    vm.hasMorePrizes = false;

                _model.getPrizes().map(function (prize) {
                    vm.prizesItems.push(prize);
                });

                $timeout(function () {
                    checkLastItemDisplayed();
                }, 250);

            }, function (_error) {

                $log.debug("[AchievementsController][_getHistoryPrizes]: ERROR", _error);
            });
        }

        function _getHistoryPlays() {
            $log.debug("[HistoryController][_getHistoryPlays]");

            if (!vm.hasMorePlays)
                return;

            DataService.getHistory("plays", vm.playsLastMonthIndex, 1).then(function (_result) {
                _model = _result;

                if (_model.getPlays().length === 0 && vm.playsLastMonthIndex !== 0)
                    vm.hasMorePlays = false;

                _model.getPlays().map(function (prize) {
                    vm.playsItems.push(prize);
                });

                $timeout(function () {
                    checkLastItemDisplayed();
                }, 250);

            }, function (_error) {

                $log.debug("[AchievementsController][_getHistoryPrizes]: ERROR", _error);
            });
        }

        function _goToProfile() {
            $log.debug("[HistoryController][_goToProfile]");
            $rootScope.animationClass = "slidedown";
            $timeout(function () {
                $location.path(appConfig.routes.profile);
            });
        }

        function _getUserPrizes() {
            DataService.getUserPrizes().then(function (response) {
                _userPrizes = response.prizes;
            });
        }


        function _init() {
            $log.debug("[HistoryController][_init]");
            _getUserPrizes();
            if (vm.playsSelected === true)
                _getHistoryPlays();
            if (vm.prizeSelected === true)
                _getHistoryPrizes();
        }

        function _redeemPrize(userPrizeId) {
            $log.debug("[HistoryController][_redeemPrize]: Redeem Prize with USERPRIZEID ", userPrizeId);

            if (userPrizeId && _model && _userPrizes) {
                for (var i in _userPrizes) {
                    var _prize = _userPrizes[i];

                    if (_prize && _prize.userPrizeId == userPrizeId) {
                        vm.showWinPrize = true;
                        vm.prize = {
                            "prize": _prize,
                            "type": "JOKER"
                        };

                        break;
                    }
                }
            } else {
                $log.debug("[HistoryController][_redeemPrize]: UNABLE to redeem prize!");
            }

        }

        function _selectTab(index) {
            $log.debug("[HistoryController][_selectTab]: ", index);

            if (index === 0) {
                vm.items = vm.prizesItems;
                vm.playsSelected = false;
                vm.prizeSelected = true;
                _getHistoryPrizes();
            } else if (index === 1) {
                vm.items = vm.playsItems;
                vm.playsSelected = true;
                vm.prizeSelected = false;
                _getHistoryPlays();
            }
        }

        var submiteSwipeUp = $rootScope.$on(appConfig.events.swipeUp, function () {
            checkLastItemDisplayed(true);
        });

        function checkLastItemDisplayed(checkAgain) {
            $log.debug("[HistoryController][checkLastItemDisplayed]", checkAgain);
            if (vm.prizeSelected) {
                if (vm.prizesItems && vm.prizesItems.length > 0) {
                    var indexElement = vm.prizesItems[vm.prizesItems.length - 1];
                    var element = document.getElementById("history_" + indexElement.id + "_" + indexElement.date);
                    if (element) {
                        var rect = element.getBoundingClientRect();
                        if (rect.top - (rect.height * 2) < $window.innerHeight) {
                            $log.debug("[HistoryController][checkLastItemDisplayed] Prize Item Inside screen", element);
                            vm.prizesLastMonthIndex++;
                            _getHistoryPrizes();
                            return;
                        } else {
                            if (checkAgain) {
                                $timeout(function () {
                                    checkLastItemDisplayed(false);
                                }, 500);
                                return;
                            }
                        }
                    }
                } else {
                    $log.debug("[HistoryController][checkLastItemDisplayed] No Prizes prizesLastMonthIndex:", vm.prizesLastMonthIndex);
                    vm.prizesLastMonthIndex++;
                    _getHistoryPrizes();
                }
            }

            if (vm.playsSelected) {
                if (vm.playsItems && vm.playsItems.length > 0) {
                    var indexElement = vm.playsItems[vm.playsItems.length - 1];
                    var element = document.getElementById("history_" + indexElement.id + "_" + indexElement.date);
                    if (element) {
                        var rect = element.getBoundingClientRect();
                        if (rect.top - (rect.height * 2) < $window.innerHeight) {
                            $log.debug("[HistoryController][checkLastItemDisplayed] Play Item Inside screen", element);
                            vm.playsLastMonthIndex++;
                            _getHistoryPlays();
                            return;
                        } else {
                            if (checkAgain) {
                                $timeout(function () {
                                    checkLastItemDisplayed(false);
                                }, 500);
                                return;
                            }
                        }
                    }
                } else {
                    $log.debug("[HistoryController][checkLastItemDisplayed] No Prizes playsLastMonthIndex:", vm.playsLastMonthIndex);
                    vm.playsLastMonthIndex++;
                    _getHistoryPlays();
                }
            }
        }

        var submitCloseShakeCard = $rootScope.$on(appConfig.events.cardClose, function () {
            vm.showWinPrize = false;
            if (vm.prize) {
                vm.prize.prize = null;
            }
            _init();
        });

        var _isElementInViewport = function (element) {
            var rect = element.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= ($window.innerHeight || doc.documentElement.clientHeight) &&
                rect.right <= ($window.innerWidth || doc.documentElement.clientWidth)
            );
        };

        var submiteSwipeDown = $rootScope.$on(appConfig.events.swipeDown, function () {
            var position = $document[0].getElementById("yornTitleContainer");
            if (_isElementInViewport(position)) {
                _goToProfile();
            }
        });

        $scope.$on('$destroy', function () {

            if (submitCloseShakeCard) {
                $log.debug("[CardController][$destroy] - submiteSwipeDown");
                submitCloseShakeCard();
            }

            if (submiteSwipeDown) {
                $log.debug("[CardController][$destroy] - submiteSwipeDown");
                submiteSwipeDown();
            }
        });

        _init();
    }

})();


angular.module('loading.controller', []).controller('LoadingController',
    LoadingController);

LoadingController.$inject = ['$location', '$routeParams', 'CacheService', 'appConfig', 'ImageLoadingService'];
/** @ngInject */
function LoadingController($location, $routeParams, CacheService, appConfig, ImageLoadingService) {
    var vm = this;
    var _misdn = $routeParams[appConfig.routesParameters.msisdn];
    if(_misdn){
        CacheService.setMsisdn(_misdn);
    }
    CacheService.init().then(function(){
        ImageLoadingService.init().then(function(){
            $location.path(appConfig.routes.landingPage);
            vm.hideLoading = true;
        });
    });


}


angular.module('main.controller', []).controller('MainController',
    MainController);

MainController.$inject = ["$log", "$interval", "$timeout", "$scope", "$window", "$location", "$rootScope", "CacheService", "DataService", 'appConfig', '$translate'];
/** @ngInject */
function MainController($log, $interval, $timeout, $scope, $window, $location,
    $rootScope, CacheService, DataService, appConfig, $translate) {

    var preloadImagesList = [];

    var vm = this;

    vm.msisdn = "";

    $rootScope.canSwipe = true;

    vm.isSideMenuOpen = false;
    vm.isHambVisible = true;
    $rootScope.isHambVisible = true;
    vm.isMotionDetected = null;

    vm.usershakes = null;
    vm.isBottomArrowVisible = true;
    vm.animationShake = false;
    vm.animationShakePromise = null;
    vm.animationBounce = null;
    vm.mainBackgroundImages = null;
    vm.displayImage = null;
    vm.displayMainText = true;
    vm.weakShake = null;
    vm.showImgBadge = null;
    vm.mysteryBoxStatus = $rootScope.mysteryBoxStatus;
    vm.canShake = true;



    var unregisterPingAchievements, unregisterInterval, submiteSwipeUp, updateUserShakesStatus, _badgeInterval;

    function setBadgePosition() {
        var _shakeImageAtDom = document.getElementById("mainShakeImg");

        if ((vm.isMotionDetected == null || vm.isMotionDetected) && _shakeImageAtDom && _shakeImageAtDom.complete == true) {
            if (_badgeInterval) {
                $interval.cancel(_badgeInterval);
            }

            var shakeImage = angular.element(_shakeImageAtDom);
            var shakeImgBounds = shakeImage[0].getBoundingClientRect();

            var badge = angular.element(document.getElementById("mainShakeBadgeHolder"));
            badge.css("top", (shakeImgBounds.top + (shakeImgBounds.height * 0.05) + "px"));
            badge.css("left", (shakeImgBounds.left + (shakeImgBounds.width * 0.65) + "px"));

            // var mainShakeBadgePlus = angular.element(document.getElementById("mainShakeBadgePlus"));
            // var badgeBounds = badge[0].getBoundingClientRect();
            // mainShakeBadgePlus.css("top", (badgeBounds.top + (badgeBounds.height * 0.11) + "px"));
            // mainShakeBadgePlus.css("left", (badgeBounds.left + (badgeBounds.width * 0.72) + "px"));

            $timeout(function () {
                vm.showImgBadge = true;
                animationShakeAction(true);
            }, 100);
        } else {
            if (!_badgeInterval && (vm.isMotionDetected == null || vm.isMotionDetected)) {
                _badgeInterval = $interval(function () {
                    setBadgePosition();
                }, 200);
            }
        }
    }

    function _pingAchievements() {
        if (appConfig.achievements_check_seconds >= 0 && $rootScope.sessionExpired === false) {
            try {
                DataService.checkAchievements(); // execute immediately
                unregisterPingAchievements = $interval(function () {
                    DataService.checkAchievements();
                }, appConfig.achievements_check_seconds * 1000);
            } catch (error) {

            }
        }

        if (unregisterPingAchievements && $rootScope.sessionExpired === true) {
            $interval.cancel(unregisterPingAchievements);
        }
    }

    function animationShakeAction(startAnimation) {

        if (vm.animationShakePromise) {
            $interval.cancel(vm.animationShakePromise);
        }
        if (startAnimation) {
            vm.animationShakePromise = $interval(function () {
                vm.animationShake = !vm.animationShake;
            }, 500);
        }
    }

    function weakBounce() {
        $rootScope.canSwipe = false;

        vm.isHambVisible = false;
        $rootScope.isHambVisible = false;
        vm.isBottomArrowVisible = false;
        vm.displayMainText = false;
        vm.animationBounce = true;

        $timeout(function () {
            animationShakeAction(false);

            $timeout(function () {
                vm.weakShake = true;

                $timeout(function () {
                    vm.weakShake = false;

                    $timeout(function () {
                        vm.weakShake = null;

                        $timeout(function () {
                            vm.animationBounce = false;
                            vm.isHambVisible = true;
                            $rootScope.isHambVisible = true;
                            vm.isBottomArrowVisible = true;
                            vm.displayMainText = true;
                            animationShakeAction(true);
                            $rootScope.canSwipe = true;
                        }, 200);

                    }, 100);

                }, 1100);

            }, 1000);

        }, 50);
    }

    function winBounce() {

        $rootScope.canSwipe = false;

        vm.isHambVisible = false;
        $rootScope.isHambVisible = false;
        vm.isBottomArrowVisible = false;
        vm.displayMainText = false;
        vm.animationBounce = true;
        animationShakeAction(false);

        CacheService.updateCanRefer(false);

        $timeout(function () {
            $rootScope.ignoreParams = false;
            $location.path(appConfig.routes.booklet + "/" + appConfig.routesParameters.shake);
        }, 1050);
    }

    var firstTimeDeviceMotionHandler = true;

    function deviceMotionHandler(eventData) {

        $log.debug("[MainController][deviceMotionHandler]", firstTimeDeviceMotionHandler, eventData);

        if (!firstTimeDeviceMotionHandler)
            return;

        firstTimeDeviceMotionHandler = false;

        var acceleration = eventData.accelerationIncludingGravity;
        $log.debug("[MainController][deviceMotionHandler] Acceleration:", acceleration);

        if (acceleration && (acceleration.x || acceleration.y || acceleration.z)) {
            vm.isMotionDetected = true;

            setBadgePosition();
            $window.removeEventListener('devicemotion', deviceMotionHandler);
            $window.addEventListener('devicemotion', shakeEventDidOccur);
        } else {
            $window.removeEventListener('devicemotion', deviceMotionHandler);
            vm.isMotionDetected = false;

        }
        //$scope.$apply();
    }

    var lastX = null;
    var lastY = null;
    var lastZ = null;
    var options = appConfig.mainShake;
    var startTime = null,
        count = 0;

    function shakeEventDidOccur(e) {

        if (!vm.usershakes || (vm.usershakes && vm.usershakes.shakesAvailable == 0) || vm.animationBounce || !$rootScope.canSwipe) return;

        var current = e.accelerationIncludingGravity;
        var currentTime;
        var deltaX = 0;
        var deltaY = 0;
        var deltaZ = 0;

        if ((lastX === null) && (lastY === null) && (lastZ === null)) {
            lastX = current.x;
            lastY = current.y;
            lastZ = current.z;
            return;
        }

        deltaX = Math.abs(lastX - current.x);
        deltaY = Math.abs(lastY - current.y);
        deltaZ = Math.abs(lastZ - current.z);

        if (((deltaX > options.threshold) && (deltaY > options.threshold)) || ((deltaX > options.threshold) && (deltaZ > options.threshold)) || ((deltaY > options.threshold) && (deltaZ > options.threshold))) {
            if (startTime === null) {
                startTime = new Date();
            }

            if (count >= options.minValidThresholds) {
                startTime = null;
                count = 0;

                vm.bounce(true);
                return;
            }

            count++;

        } else {
            if (startTime !== null) {
                if (new Date(new Date() - startTime).getSeconds() >= options.validationTime) {
                    startTime = null;
                    count = 0;
                    vm.bounce(false);
                }
            }
        }

        lastX = current.x;
        lastY = current.y;
        lastZ = current.z;

    }

    function motionValidation() {
        if ($window.DeviceMotionEvent) {
            if ($window.DeviceMotionEvent) {
                $window.addEventListener('devicemotion', deviceMotionHandler);
            } else {
                vm.isMotionDetected = false;

            }
        }
    }

    function requestLocationPermission() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                $log.debug("[MainController][requestLocationPermission] - location is enabled");
                console.log("[MainController][requestLocationPermission] - location is enabled");
            }, function (_error) {
                $log.info("[MainController][requestLocationPermission] - " + _error.message);
                console.log("[MainController][requestLocationPermission] - " + _error.message);
            });
        } else {
            console.log("[MainController][requestLocationPermission] - No geolocation");
        }
    }

    function init() {

        CacheService.getMysteryBoxStatus().then(function (result) {
            if (result.mysteryBoxEnabled) {
                if (result.canOpen) {
                    vm.mysteryBoxStatus = 1;
                } else {
                    vm.mysteryBoxStatus = 2;
                }
            } else {
                vm.mysteryBoxStatus = 0;
            }
            $rootScope.mysteryBoxStatus = vm.mysteryBoxStatus;
        });

        CacheService.getSplashScreens().then(function (_splashScreens) {
            vm.mainBackgroundImages = _splashScreens.splashscreenImages;
            vm.displayImage = 0;

            $timeout(function () {
                document.getElementById("mainBg_0").src = vm.mainBackgroundImages[0].image;
                document.getElementById("mainBg_1").src = vm.mainBackgroundImages[1].image;
                document.getElementById("mainBg_2").src = vm.mainBackgroundImages[2].image;

                unregisterInterval = $interval(function () {

                    vm.displayImage++;
                    if (vm.displayImage == vm.mainBackgroundImages.length) {
                        vm.displayImage = 0;
                    }

                    if (vm.displayImage !== 0)
                        document.getElementById("mainBg_0").style.zIndex = "-1";
                    if (vm.displayImage !== 1)
                        document.getElementById("mainBg_1").style.zIndex = "-1";
                    if (vm.displayImage !== 2)
                        document.getElementById("mainBg_2").style.zIndex = "-1";

                    document.getElementById("mainBg_" + vm.displayImage).style.zIndex = "0";

                }, 350);
            }, 100);
        });

        CacheService.getUserShakesStatus(true).then(function (_userShakesStatus) {
            vm.usershakes = _userShakesStatus;
            if (vm.usershakes.shakesAvailable == 0) {
                if (appConfig.when_zero_shakes_go_to_profile && appConfig.when_zero_shakes_go_to_profile === 'true') {

                    $timeout(function () {
                        if ($location.path() === "/" + appConfig.routes.landingPage && $rootScope.overlayActive === false) {
                            $location.path(appConfig.routes.profile);
                        }
                    }, appConfig.when_zero_shakes_go_to_profile_after_seconds * 1000);
                }
            }
            $rootScope.notifyUserNewPrize = _userShakesStatus.notifiedNewPrize;
            motionValidation();
        });

        CacheService.getBooklet(true).then(function (result) {

            if (appConfig.cacheImagesCount === undefined){
                appConfig.cacheImagesCount = 66;
            }

            if (appConfig.cacheImagesCount > 0) {
                var imagesCache = [];
                for (var indexRow = 0; indexRow < result.cards.length; indexRow++) {
                    var row = result.cards[indexRow];

                    for (var index = 0; index < row.length; index++) {
                        if (imagesCache.length < appConfig.cacheImagesCount) {
                            imagesCache.push(row[index].imageCached);
                        }
                    }
                }
                preloadImages(imagesCache);
            }
        });

        requestLocationPermission();

        $timeout(function () {
            angular.element(document.getElementById("motionDetectElements")).remove();
            vm.isMotionDetected = false;

        }, appConfig.global.shakePageShakeBtTimeout * 1000);

        _pingAchievements();

        // i18n - Run first time to set activeLang
        if(localStorage.getItem('NG_TRANSLATE_LANG_KEY')){
            $scope.activeLang = localStorage.getItem('NG_TRANSLATE_LANG_KEY');
        } else {
            $scope.activeLang = 'pt';
        }
    }

    function preloadImages(array) {
        if (!preloadImagesList) {
            preloadImagesList = [];
        }
        for (var i = 0; i < array.length; i++) {
            var img = new Image();
            img.onload = function () {
                var index = preloadImagesList.indexOf(this);
                if (index !== -1) {
                    preloadImagesList.splice(index, 1);
                }
            }
            preloadImagesList.push(img);
            img.src = array[i];
        }
    }

    vm.bounce = function (win) {
        if (!$rootScope.isSideMenuOpen) {

            $rootScope.mcareIntegration({
                'playSound': true,
                'action': 'shake'
            });

            if (win) {
                winBounce();
            } else {
                weakBounce();
            }
        }
    };

    submiteSwipeUp = $rootScope.$on(appConfig.events.swipeUp, function () {
        if (!$rootScope.isSideMenuOpen) {
            vm.goToProfile();
        }
    });

    updateUserShakesStatus = $rootScope.$on(appConfig.events.updateUserShakesStatus, function () {
        CacheService.getUserShakesStatus().then(function (_userShakesStatus) {
            vm.usershakes = _userShakesStatus;
        });
    });

    vm.goToProfile = function () {
        $log.debug("[MainController][goToProfile]");
        $rootScope.animationClass = "slideup";
        $timeout(function () {
            $location.path(appConfig.routes.profile);
        });
    };

    vm.openCamera = function(){
        $timeout(function () {
            $location.path(appConfig.routes.camera);
        });
    };


    vm.navigateToMysteryBox = function () {
        $location.path(appConfig.routes.mysterybox);
    };

    $scope.$on('$destroy', function () {

        if (submiteSwipeUp) {
            $log.debug("[MainController][$destroy] - submiteSwipeUp");
            submiteSwipeUp();
        }

        try {
            $log.debug("[MainController][$destroy] - submiteSwipeUp");
            $window.removeEventListener('devicemotion', shakeEventDidOccur);
        } catch (error) {
            $log.debug("[MainController][$destroy] - error removing listener", error);
        }

        if (unregisterPingAchievements) {
            $log.debug("[MainController][$destroy] - unregisterPingAchievements");
            $interval.cancel(unregisterPingAchievements);
        }
        if (unregisterInterval) {
            $log.debug("[MainController][$destroy] - unregisterInterval");
            $interval.cancel(unregisterInterval);
        }
        if (updateUserShakesStatus) {
            $log.debug("[MainController][$destroy] - updateUserShakesStatus");
            updateUserShakesStatus();
        }
        if (_badgeInterval) {
            $log.debug("[MainController][$destroy] - _badgeInterval");
            $interval.cancel(_badgeInterval);
        }

    });

    init();

    /*
    * Change language action
    * @params - languageCode - country code for language selection
    * Ex: 'pt' for Portuguese, 'en' for english (lowercase)
    * */
    $scope.changeLanguage = function (languageCode) {

        //Save on localstorage
        localStorage.setItem('NG_TRANSLATE_LANG_KEY', languageCode);
        //Activate language selected
        $translate.use(languageCode);
        $scope.activeLang = languageCode;

        //Emit broadcast on change language
        $rootScope.$broadcast('languageSelected',  $scope.activeLang);
    };

}

(function () {
    'use strict';
    
    angular.module("achievements.model", []).factory("Achievements", AchievementsFactory);

    AchievementsFactory.$inject = ["$translate"];

    function AchievementsFactory($translate) {
        function Achievements (){
            this.achievements = null;
            this.newachievement = null;

            this.unlocked = 0;//Number of unlocked achievements (each level only counts as one)
        }

        Achievements.prototype.getAchievements = function () {
            if(!this.achievements){
                this.achievements = [];
            }
            return this.achievements;
        };
        Achievements.prototype.setAchievements = function (achievements) {
            this.achievements = achievements;
        };

        Achievements.prototype.getNewAchievement = function () {
            return this.newachievement;
        };
        Achievements.prototype.setNewAchievement = function (achievement) {
            this.newachievement = achievement;
        };

        Achievements.prototype.getUnlocked = function () {
            return this.unlocked;
        };
        Achievements.prototype.setUnlocked = function (unlocked) {
            this.unlocked = unlocked;
        };

        Achievements.prototype.parseFromRest = function (data) {
            if(data && data.achievements){
                for (var i=0; i< data.achievements.length; i++){

                    var _achievement = {
                        "id": data.achievements[i].id,
                        "name": data.achievements[i].name,
                        "type": data.achievements[i].type,
                        "quantity": data.achievements[i].quantity,
                        "image": data.achievements[i].image,
                        "new": data.achievements[i].new,
                        "level": data.achievements[i].level===null?'':data.achievements[i].level.toLocaleLowerCase(),
                        "description": data.achievements[i].description,
                        "imageB64": data.achievements[i].imageB64
                    };

                    var _achievementLevel = _achievement.level.toLocaleLowerCase();
                    if(_achievementLevel === 'bronze' || _achievementLevel === 'silver' || _achievementLevel === 'gold')  {
                        var descriptionKey = 'text.achievement.description.'+_achievement.type.toLocaleLowerCase();
                        _achievement.description =  $translate.instant(descriptionKey).replace(":quantity:", _achievement.quantity);
                    }

                    if(_achievement.level !== ''){
                        this.unlocked ++;
                    }

                    if(_achievement.new === true){
                        this.setNewAchievement(_achievement);
                    }

                    this.getAchievements().push(_achievement);
                }
            }
        };

        return Achievements;
    }
    
})();
(function () {
    'use strict';

    angular.module('booklet.model', []).factory('Booklet', BookletFactory);

    BookletFactory.$inject = ["$filter", "$log", "appConfig"];

    function Card(data) {
        var _card = {
            htmlId: "position_" + data.position,
            canflip: data.flip,
            category: data.categoryPosition,
            duplicated: data.duplicated,
            id: data.id,
            image: data.image,
            imageCached: data.image,
            inCollection: data.inCollection, //if not in collection, it is a placeholder
            longDescription: data.longDescription,
            name: data.name,
            nameMask: data.nameMask,
            position: data.position,
            type: data.type,
            shortDescription: data.shortDescription,
            //variables below are for UIX and do not come from REST
            flippedtocover: false,
            overlay: false,
            animate: false,
            redeemActive: false,
            prizeRedemeed: false,
            row: function () {
                return (_card.position - _card.category + 6) / 6;
            }
        };

        return _card;
    }

    function BookletFactory($filter, $log, appConfig) {

        function Booklet() {
            this.cards = [];
            this.categories = [];
            this.name = null;
            this.deckimage = "";
            this.deckdetailimage = "";
            this.collectionCount = 0;
            this.cardsCount = 0;

            this.fulfilledColumnCount = [0, 0, 0, 0, 0, 0];
            this.collectionComplete = false;

            this.expireDate = '';
        }

        Booklet.prototype.getCards = function () {
            return this.cards;
        };
        Booklet.prototype.setCards = function (cards) {
            this.cards = cards;
        };
        Booklet.prototype.getCategories = function () {
            return this.categories;
        };
        Booklet.prototype.setCategories = function (categories) {
            this.categories = categories;
        };
        Booklet.prototype.getCollectionCount = function () {
            return this.collectionCount;
        };
        Booklet.prototype.setCollectionCount = function (collectionCount) {
            this.collectionCount = collectionCount;
        };
        Booklet.prototype.getCardsCount = function () {
            return this.cardsCount;
        };
        Booklet.prototype.setCardsCount = function (cardsCount) {
            this.cardsCount = cardsCount;
        };
        Booklet.prototype.getName = function () {
            return this.name;
        };
        Booklet.prototype.setName = function (name) {
            this.name = name;
        };
        Booklet.prototype.getDeckImage = function () {
            return this.deckimage;
        };
        Booklet.prototype.setDeckImage = function (deckimage) {
            this.deckimage = deckimage;
        };
        Booklet.prototype.getDeckDetailImage = function () {
            return this.deckdetailimage;
        };
        Booklet.prototype.setDeckDetailImage = function (deckdetailimage) {
            this.deckdetailimage = deckdetailimage;
        };
        Booklet.prototype.getExpireDate = function () {
            return this.expireDate;
        };
        Booklet.prototype.setExpireDate = function (expireDate) {
            this.expireDate = expireDate;
        };

        Booklet.prototype.addCard = function (_newCard) {
            $log.debug("[Booklet][addCard]", _newCard);
            if (!_newCard.duplicated) {
                // var _newCard = _card;
                var _newCardRow = _newCard.row();

                this.cards[_newCardRow][_newCard.category - 1] = _newCard;

                this.setCollectionCount(this.getCollectionCount() + 1);
                this.fulfilledColumnCount[_newCard.category - 1]++;

                //update category [https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-395]
                this.categories[_newCard.category - 1].hasCategoryPrize = _newCard.hasCategoryPrize;
                this.categories[_newCard.category - 1].redeemActive = _newCard.redeemActive;
            }
        };

        function _toMiddlePrizesMap(_cardsList) {
            var _temp = [];
            var _map = [];
            if (_cardsList) {
                for (var i = 0; i < _cardsList.length; i++) {
                    if (_cardsList.hasOwnProperty(i)) {
                        _temp.push(_cardsList[i]);
                        if ((i + 1) % 4 === 0) {
                            _map.push(_temp);
                            _temp = [];
                        }
                    }
                    if (i === 9) {
                        break;
                    }
                }
            }
            $log.debug("[Booklet][_toMiddlePrizesMap]: parsed to a map");
            return _map;
        }
        Booklet.prototype.parseCardFromData = function (data) {
            $log.debug("[Booklet][getCardFromData]");
            var _newCard = null;

            if (data.type === appConfig.cardTypes.collection && data.card) {
                _newCard = new Card(data.card);
                _newCard.prize = data.prize;
                _newCard.canflip = true;
            } else if (data.type === appConfig.cardTypes.gold && data.prize) {
                _newCard = {
                    category: data.categoryPosition,
                    id: data.prize.id,
                    type: data.type,
                    image: data.prize.image,
                    imageCached: data.prize.image,
                    inCollection: true,
                    name: data.prize.name,
                    htmlId: "position_gold_" + data.categoryPosition,
                    redeemActive: false,
                    prizeRedemeed: false,
                    overlay: false,
                    animate: false,
                    row: function () {
                        return 0;
                    }

                };
            }
            _newCard.hasCategoryPrize = data.hasCategoryPrize;
            _newCard.middlePrizes = _toMiddlePrizesMap(data.middlePrizes); //Middle game prize list
            _newCard.middlePrize = data.middlePrize; // selected prize for middle game
            _newCard.fullPrize = data.fullPrize; //when booklet i
            _newCard.prize = data.duplicatedPrize || data.prize;
            _newCard.middlePrizeStart = data.middlePrizeStart;
            _newCard.middlePrizeEnd = data.middlePrizeEnd;
            if (_newCard.prize) {
                _newCard.longDescription = _newCard.prize.description;
                _newCard.canflip = false;
                _newCard.redeemActive = (data.prize.userPrizeStatus === "NEW"
                    //https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-573
                    ||
                    data.prize.userPrizeStatus === "ANSWER_OK"
                    //https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-531
                    ||
                    data.prize.userPrizeStatus === "TERMS_ACCEPTED");
            }

            return _newCard;
        };


        Booklet.prototype.parseFromRest = function (data, ignorePrizes) {
            $log.debug("[Booklet][parseFromRest]", data, ignorePrizes);
            var _card = null;
            var _cardsCount = 0;
            var index = null;
            var _prizeCount = 0;

            if (ignorePrizes === undefined || ignorePrizes === null)
                ignorePrizes = false;

            if (data.categories && data.categories.length > 0) {
                data.categories.sort(function (card1, card2) {
                    return card1.sort - card2.sort;
                });

                //Parse Categories data and Prize cards
                var _goldcards = [];
                for (index in data.categories) {
                    if (data.categories.hasOwnProperty(index)) {
                        //DATA FOR CATEGORY
                        var _category = {
                            id: data.categories[index].id,
                            description: data.categories[index].description,
                            name: data.categories[index].name,
                            hasCategoryPrize: data.categories[index].hasCategoryPrize,
                            hasPendingPrize: (data.categories[index].goldPrize && data.categories[index].goldPrize.userPrizeStatus) ? (data.categories[index].goldPrize.userPrizeStatus === "NEW" ||
                                data.categories[index].goldPrize.userPrizeStatus === "REDEEM_CONDITIONAL" ||
                                //https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-573
                                data.categories[index].goldPrize.userPrizeStatus === "ANSWER_OK" ||
                                //https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-531
                                data.categories[index].goldPrize.userPrizeStatus === "TERMS_ACCEPTED") : null
                        };


                        //DATA FOR PRIZE/GOLD CARD
                        _card = {
                            category: data.categories[index].sort,
                            id: data.categories[index].id,
                            type: "GOLD",
                            image: data.categories[index].placeholderUrl,
                            inCollection: false,
                            htmlId: "position_gold_" + data.categories[index].sort,
                            redeemActive: false,
                            prizeRedemeed: false,
                            overlay: false,
                            animate: false

                        };
                        //IF IT HAS PRIZE, UPDATE DATA
                        if (data.categories[index].goldPrize !== null) {
                            _card.name = data.categories[index].goldPrize.name;
                            _card.image = data.categories[index].goldPrize.image;
                            _card.inCollection = true;
                            _card.longDescription = data.categories[index].goldPrize.description;
                            _card.canflip = false;

                            _card.redeemActive = (data.categories[index].goldPrize.userPrizeStatus.toUpperCase() === "NEW" ||
                                data.categories[index].goldPrize.userPrizeStatus.toUpperCase() === "ANSWER_OK" ||
                                data.categories[index].goldPrize.userPrizeStatus.toUpperCase() === "TERMS_ACCEPTED"); // changes card background to red
                            _card.prizeRedemeed = data.categories[index].goldPrize.userPrizeStatus.toUpperCase() === "REDEEMED" ||
                                data.categories[index].goldPrize.userPrizeStatus.toUpperCase() === "REDEEM_PENDING"; // adds stamp to card
                            _card.prize = data.categories[index].goldPrize;

                            _card.hasCategoryPrize = data.categories[index].hasCategoryPrize;
                            _prizeCount++;
                        }
                        //this changes labels UI
                        _category.redeemActive = _card.redeemActive;
                        _category.prizeRedemeed = _card.prizeRedemeed;

                        _goldcards.push(_card);
                        this.getCategories().push(_category);
                    }
                }

                this.getCards().push(_goldcards);
            }

            if (data.cards && data.cards.length > 0) {

                var _gamecards = [];

                for (index = 0; index < data.cards.length; index++) {
                    if (data.cards.hasOwnProperty(index)) {
                        _card = new Card(data.cards[index]);

                        if (_card.inCollection === true) {
                            _cardsCount++;
                            _card.canflip = true;
                        }
                        _gamecards.push(_card);
                    }
                }

                _gamecards.sort(function (card1, card2) {
                    return card1.position - card2.position;
                });

                var _cardslist = [];

                for (index = 0; index < _gamecards.length; index++) {

                    if (_gamecards.hasOwnProperty(index)) {
                        _cardslist.push(_gamecards[index]);
                    }

                    if ((index + 1) % data.categories.length === 0) {
                        this.getCards().push(_cardslist);
                        _cardslist = [];
                    }
                }
            }

            //THE COLLECTION DATA
            this.setName(data.collection.name);
            this.setExpireDate($filter('date')(data.collection.endDate, "dd/MM/yyyy HH:mm"));
            this.setDeckImage(data.collection.cardDeckImage);
            this.setDeckDetailImage(data.collection.cardDeckDetailImage);

            //ADDITIONAL DATA
            this.setCardsCount(_cardsCount);
            this.setCollectionCount(_prizeCount + _cardsCount);
            if (ignorePrizes === false) {
                //process data to set overlays
                if (_cardsCount < (10 * 6)) {
                    this.getFulfilledColumnIndex();                    
                    this.setOverlays(false);
                } else {
                    this.setOverlays(true);
                    this.collectionComplete = true;
                }
            }
        };

        Booklet.prototype.getFulfilledColumnIndex = function (_newcard) {
            $log.debug("[Booklet][getFulfilledColumnIndex]");

            var _MAXIMUMVALUE = this.cards.length;
            if (!_newcard) { //called on initial parsing

                for (var col in this.fulfilledColumnCount) {
                    for (var row = 0; row < _MAXIMUMVALUE; row++) {
                        if (this.cards[row][col] != undefined && this.cards[row][col] != null && this.cards[row][col].inCollection === true) {
                            this.fulfilledColumnCount[col]++;
                        }
                    }
                }
            } else if (_newcard.duplicated === true) { //if it is duplicated, it shall not trigger prize
                $log.debug("[getFulfilledColumnIndex] IT IS DUPLICATED");
                return -1;
            } else {
                //check if column is now full
                var _col = _newcard.category - 1;
                if (this.fulfilledColumnCount[_col] === _MAXIMUMVALUE) {
                    return _col;
                }
            }
            return -1;
        };        


        Booklet.prototype.setOverlays = function (_isFull) {
            $log.debug("[Booklet][setOverlays]");
            var _row = 0,
                _col = 0;
            if (_isFull) {
                for (var _col = 0; _col < this.cards[_row].length; _col++) {
                    if (this.cards[0][_col].hasCategoryPrize == true) {
                        this.cards[0][_col].overlay = true;
                    }
                }

                for (_row = 1; _row < this.cards.length; _row++) {
                    for (var _col = 0; _col < this.cards[_row].length; _col++) {
                        this.cards[_row][_col].overlay = true;
                    }
                }
            } else {
                var _maximumColValue = this.cards.length;

                for (_col in this.fulfilledColumnCount) {
                    if (this.fulfilledColumnCount[_col] === _maximumColValue) {
                        for (_row = 0; _row < _maximumColValue; _row++) {
                            this.cards[_row][_col].overlay = true;
                        }
                    }
                }
            }
        };

        return Booklet;
    }
})();

(function () {
    'use strict';

    angular.module("history.model", []).factory("History", HistoryFactory);

    HistoryFactory.$inject = ["$filter"];

    function HistoryFactory($filter) {
        function History() {
            this.prizes = null;
            this.plays = null;

        }

        History.prototype.getPrizes = function () {
            if (!this.prizes) {
                this.prizes = [];
            }
            return this.prizes;
        };
        History.prototype.setPrizes = function (prizes) {
            this.prizes = prizes;
        };

        History.prototype.getPlays = function () {
            if (!this.plays) {
                this.plays = [];
            }
            return this.plays;
        };
        History.prototype.setPlays = function (plays) {
            this.plays = plays;
        };

        History.prototype.parseFromRest = function (data, type) {
            if (data && data.items) {
                for (var i = 0; i < data.items.length; i++) {
                    var _item = {
                        "userPrizeId": data.items[i].userPrizeId,
                        "id": data.items[i].id,
                        "description": data.items[i].description,
                        "image": data.items[i].image,
                        "expiredate": data.items[i].prizeExpireDate,
                        "date": data.items[i].historyDate,
                        "historydate": $filter('date')(data.items[i].historyDate, "dd/MM/yyyy")
                    };

                    if (type.toLowerCase() === "plays") {
                        this.getPlays().push(_item);
                    } else if (type.toLowerCase() === "prizes") {
                        this.getPrizes().push(_item);
                    }
                }
            }
        };

        return History;
    }

})();

(function () {
  "use strict";

  angular.module("mysterybox.controller", []).controller("MysteryBoxController", MysteryBoxController);

  MysteryBoxController.$inject = [
    "$animateCss",
    "$document",
    "$location",
    "$log",
    "$rootScope",
    "$timeout",
    "appConfig",
    "DataService",
    "$scope",
    "CacheService"
  ];


  function MysteryBoxController($animateCss, $document, $location, $log, $rootScope, $timeout, appConfig, DataService, $scope, CacheService) {
    var vm = this;
    vm.status = null;
    vm.prize = null;
    vm.displayShakeItButton = 1;
    vm.placeHolder1 = false;
    vm.placeHolderImage1 = null;
    vm.placeHolder2 = false;
    vm.placeHolderImage2 = null;
    vm.placeHolder3 = false;
    vm.placeHolderImage3 = null;
    vm.placeHolder4 = false;
    vm.placeHolderImage4 = null;
    vm.placeHolder5 = false;
    vm.placeHolderImage5 = null;
    vm.displayFragment = false;
    vm.showOverlay = _showOverlay;
    vm.closeOverlay = closeOverlay;
    vm.placeCard = placeCard;
    vm.placingCard = false;
    vm.openBox = openBox;
    vm.shakeIt = shakeIt;
    vm.overlayState = 0; //0 Non-Display // 1 - Box // 2 - Box Open Request // 3 - Prize
    $scope.vm = vm;

    var openStatusEvent = $rootScope.$on(appConfig.events.openMysteryBox, function () {
      vm.showOverlay();
    });

    function init() {
      $log.debug("[MysteryBoxController][init]: Started!");

      CacheService.getMysteryBoxStatus().then(function (result) {
        $log.debug("[MysteryBoxController][init] getMysteryBoxStatus", result);
        vm.status = result;
        updateStatus(false);
        vm.showOverlay();
      });
    }

    function _showOverlay() {
      if (vm.status.canOpen === true) {
        vm.overlayState = 1;
      }
    }

    function openBox() {
      if (vm.status.canOpen === true) {
        vm.overlayState = 2;
        DataService.openMysteryBox().then(function (result) {
          $log.debug("[MysteryBoxController][openBox] openBox", result);
          CacheService.getMysteryBoxStatus(true).then(function (result) {
            $log.debug("[MysteryBoxController][openBox] getMysteryBoxStatus", result);
            vm.status = result;
            updateStatus(true);
          });
          if (result.didOpen === true) {

            $log.debug("[MysteryBoxController][openBox] Playing Sound.");
            $rootScope.mcareIntegration({
              'playSound': true,
              'action': 'openMysteryBox'
            });

            vm.overlayState = 3;
            vm.prize = result.prize;
            vm.status.canOpen = false;
            if (vm.prize.isCardFragment) {
              vm.displayFragment = true;

              //https://jira.sp.vodafone.com/browse/SIT-250
              if (parseInt(getAndroidVersion(), 10) < 5) {
                $timeout(function () {
                  var card = document.getElementById("mysteryBoxOverlayCardFragment");
                  card.style.top = "";
                  card.style.marginTop = "45%";
                  card.style.width = "80%";
                  card.style.height = "";
                  card.style.marginLeft = "8%";
                  //card.style.transform = "";
                }, 500);
              }
            } else {
                vm.displayFragment = false;
            }

          }
        });
      }
    }

    function updateStatus(removeLast) {

      vm.placeHolder1 = false;
      vm.placeHolder2 = false;
      vm.placeHolder3 = false;
      vm.placeHolder4 = false;
      vm.placeHolder5 = false;

      for (var i = 0; i < (removeLast ? (vm.status.fragments.length - 1) : vm.status.fragments.length); i++) {
        if (vm.status.fragments[i].number === 1) {
          vm.placeHolder1 = true;
          if (vm.placeHolderImage1 !== vm.status.fragments[i].image)
            vm.placeHolderImage1 = vm.status.fragments[i].image;
        }
        if (vm.status.fragments[i].number === 2) {
          vm.placeHolder2 = true;
          if (vm.placeHolderImage2 !== vm.status.fragments[i].image)
            vm.placeHolderImage2 = vm.status.fragments[i].image;
        }
        if (vm.status.fragments[i].number === 3) {
          vm.placeHolder3 = true;
          if (vm.placeHolderImage3 !== vm.status.fragments[i].image)
            vm.placeHolderImage3 = vm.status.fragments[i].image;
        }
        if (vm.status.fragments[i].number === 4) {
          vm.placeHolder4 = true;
          if (vm.placeHolderImage4 !== vm.status.fragments[i].image)
            vm.placeHolderImage4 = vm.status.fragments[i].image;
        }
        if (vm.status.fragments[i].number === 5) {
          vm.placeHolder5 = true;
          if (vm.placeHolderImage5 !== vm.status.fragments[i].image)
            vm.placeHolderImage5 = vm.status.fragments[i].image;
        }
      }
    }

    function closeOverlay() {
      $log.debug("[MysteryBoxController][closeOverlay]");

      var container = document.getElementById("mysteryBoxOverlayContainer");
      container.className = "animated fadeOut";
      vm.overlayState = 0;
      animationEnd();
    }

    function placeCard() {
      $log.debug("[MysteryBoxController][placeCard]");

      if (vm.placingCard)
        return;

      vm.placingCard = true;

      //https://jira.sp.vodafone.com/browse/SIT-250
      if (parseInt(getAndroidVersion(), 10) < 5) {
        vm.overlayState = 0;
        vm.placingCard = false;

        var card = document.getElementById("mysteryBoxOverlayCardFragment");
        card.style.display = "none";
        vm.displayFragment = false;
        vm.placingCard = false;

        if (vm.prize != null && vm.prize.cardCompleted)
          vm.displayShakeItButton = 2;
        else
          vm.displayShakeItButton = 1;

        var mbDisplayFragmentDIV = document.getElementById("mbDisplayFragmentDIV");
        if (mbDisplayFragmentDIV != null) 
          mbDisplayFragmentDIV.style.zIndex = "0";          

        CacheService.getMysteryBoxStatus(true).then(function (result) {
          $log.debug("[MysteryBoxController][init] getMysteryBoxStatus", result);
          vm.status = result;
          updateStatus(false);
        });

        return;
      }

      var card = document.getElementById("mysteryBoxOverlayCardFragment");
      if (vm.prize !== null) {
        if (vm.prize.fragmentNumber === 1) {
          card.className += "element-animation1";          
        } else if (vm.prize.fragmentNumber === 2) {
          card.className += "element-animation2";          
        } else if (vm.prize.fragmentNumber === 3) {
          card.className += "element-animation3";          
        } else if (vm.prize.fragmentNumber === 4) {
          card.className += "element-animation4";          
        } else if (vm.prize.fragmentNumber === 5) {
          card.className += "element-animation5";          
        }
      }

      var container = document.getElementById("mysteryBoxOverlayContainer");
      container.className = "animated fadeOut";
      $timeout(function () {
        vm.overlayState = 0;
        vm.placingCard = false;
      }, 1000);

      card.addEventListener("animationend", animationEnd, false);
    }

    function animationEnd() {
      //vm.displayFragment = false;
      vm.placingCard = false;

      if (vm.prize != null && vm.prize.cardCompleted)
        vm.displayShakeItButton = 2;
      else
        vm.displayShakeItButton = 1;

      var mbDisplayFragmentDIV = document.getElementById("mbDisplayFragmentDIV");
      if (mbDisplayFragmentDIV != null) {
        mbDisplayFragmentDIV.style.zIndex = "0";
        mbDisplayFragmentDIV.style.display = "none";
        updateStatus(false);
      }

      $scope.$apply();
    }

    function shakeIt() {
      $log.debug("[MysteryBoxController][shakeIt]");

      var container = document.getElementById("mysteryBoxOverlayContainer");
      if (container !== null)
        container.className = "animated fadeOut";

      $timeout(function () {
        $location.path(appConfig.routes.landingPage);
      }, 500);

    }

    init();

  }
})();
(function () {
  "use strict";

  angular.module("previousbooklet.controller", []).controller("PreviousBookletController", PreviousBookletController);

  PreviousBookletController.$inject = [
    "$animateCss",
    "$document",
    "$location",
    "$log",
    "$rootScope",
    "$timeout",
    "appConfig",
    "DataService",
    "$scope",
    "CacheService"
  ];


  function PreviousBookletController($animateCss, $document, $location, $log, $rootScope, $timeout, appConfig, DataService, $scope, CacheService) {
    var vm = this;
    vm.show4CategoryBooklet = false;
    vm.cards = null;
    vm.categories = null;
    vm.name = null;
    vm.addDimensionsToCardImageUrl = addDimensionsToCardImageUrl;
    $scope.vm = vm;


    function init() {
      $log.debug("[PreviousBookletController][init]: Started!");

      CacheService.getPreviousBooklet().then(function (result) {
        vm.cards = result.cards;
        vm.categories = result.categories;
        vm.name = result.name;

        if (vm.categories.length <= 4)
          vm.show4CategoryBooklet = true;

        if (vm.cards !== undefined && vm.cards !== null) {
          vm.cards.forEach(function (line) {
            line.forEach(function (card) {
              card.image = addDimensionsToCardImageUrl(card.image);
            });
          });
        }
      });

    }

    function addDimensionsToCardImageUrl(url) {
      var whCard = CacheService.getWidthHeightforCards();
      if (url != null && url != undefined && url.indexOf("width") < 0) {
        (url.indexOf("/image") > 0) ? url += "?": url += "&";
        url += "width=" + whCard.width + "&height=" + whCard.height + "&previousCollection=true";
        return url;
      } else {
        return url;
      }
    }

    init();

  }
})();
(function () {
    'use strict';

    angular.module('prizelist.controller', []).controller('PrizeListController',
        PrizeListController);

    PrizeListController.$inject = ["$scope", "$rootScope", 'appConfig', 'DataService', '$timeout', '$log'];
    /** @ngInject */
    function PrizeListController($scope, $rootScope, appConfig, DataService, $timeout, $log) {
        var vm = this;
        vm.prizeList = null;
        vm.canShowPrizeList = false;

        function init(){

            var removeNotifyUserNewPrize = $rootScope.notifyUserNewPrize===true;

            DataService.getPrizeList(removeNotifyUserNewPrize).then(function (response) {
                vm.prizeList = response.eligiblePrizeCategories;
                $rootScope.notifyUserNewPrize = response.notifyUserNewPrize;
            });

            positionPrizeListContainer(0);
        }

        function positionPrizeListContainer(count){
            var yornTitleContainerElement = document.getElementById("yornTitleContainer");
            var prizeListContainerElement = document.getElementById("prizeListContainer");

            if(!yornTitleContainerElement || !prizeListContainerElement){
                if(count == 10) {
                    $log.debug("[PrizeListController][positionPrizeListContainer]: yornTitleContainer or prizeListContainer not present.");
                    return;
                }
                $timeout(function(){
                    positionPrizeListContainer(++count);
                }, 500);
                return;
            }

            var prizeListContainerTopPosition = yornTitleContainerElement.getBoundingClientRect().top + yornTitleContainerElement.getBoundingClientRect().height;
            angular.element(prizeListContainerElement).css("top", prizeListContainerTopPosition + "px");

            vm.canShowPrizeList = true;
        }

        init();

    }

})();

(function () {
    'use strict';

    angular.module('profile.controller', []).controller('ProfileController',
        ProfileController);

    ProfileController.$inject = ['$interval', '$location', 'DataService', 'appConfig', '$rootScope', '$timeout', 'CacheService', '$scope', '$log', '$routeParams'];
    /** @ngInject */
    function ProfileController($interval, $location, DataService, appConfig, $rootScope, $timeout, CacheService, $scope, $log, $routeParams) {
        var options = {
            "prizes": "prizes"
        };

        var vm = this;
        vm.booklet = null;
        //This flag works as semaphore: https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-572
        var _redeemingPrize = false;
        $rootScope.canSwipe = true;

        vm.info = {
            "shakes": 0,
            "cards": {
                "count": 0,
                "total": appConfig.global.totalCards
            },
            "prizes": 0
        };
        vm.achievements = {
            "count": 0,
            "total": 0,
            "achievements": []
        };
        vm.prizesToRedeem = [];
        vm.info.prizes = null;

        vm.user = null;
        vm.isFacebookConnected = false;
        vm.showAwardedShakesOverlay = false;
        vm.awardedShakes = 0;
        vm.loginWithFacebook = loginWithFacebook;
        vm.getFacebookData = getFacebookData;
        vm.updateFacebookStatus = updateFacebookStatus;
        vm.userPhoto = userPhoto;



        // EVENT HANDLER
        //if answer ok or terms accepted, updates prizes in order to avoid flow again
        var submitUpdateUserPrize = $scope.$on(appConfig.events.update_userprize, function (event, params) {
            var _prize = params;
            if (params) {
                for (var card in vm.booklet.cards[0]) {

                    if (vm.booklet.cards[0][card].prize &&
                        vm.booklet.cards[0][card].prize.userPrizeId == _prize.userPrizeId) {
                        vm.booklet.cards[0][card].prize = _prize;
                    }
                }
            }

        });



        vm.goToHistoryPrizesTab = function () {
            $timeout(function () {
                $location.path(appConfig.routes.history).search({});
            });
        };

        vm.goToHistoryPlaysTab = function () {
            $timeout(function () {
                $location.path(appConfig.routes.history).search({
                    tab: '1'
                });

            });
        };

        vm.goToBookletPage = function () {
            $timeout(function () {
                $location.path(appConfig.routes.booklet).search({});
            });
        };

        vm.goToHistory = function () {
            $rootScope.animationClass = "slideup";
            $timeout(function () {
                $location.path(appConfig.routes.history).search({});
            });
        };

        vm.goToWinShakes = function () {
            $location.path(appConfig.routes.winshakes);
        };

        vm.goToAchievement = function () {
            $rootScope.animationClass = "slideleft";
            $timeout(function () {
                $location.path(appConfig.routes.achievements);
            });
        };

        vm.goToLandingPage = function () {
            $rootScope.animationClass = "slidedown";
            $timeout(function () {
                $location.path(appConfig.routes.landingPage);
            });
        };

        function loadProfileUserPrizes() {
            DataService.getUserPrizes().then(function (response) {
                vm.prizesToRedeem = response.prizes;
                vm.info.prizes = response.redeemedPrizesCount;
                vm.totalPoints = response.pointsTotal;
                vm.stepPoints = response.middlePrizesInfo;
                
                //Get Users current level
                getUserLevel();

                // Set percentage witdh to the percentage div
                var progress = angular.element(document.getElementById("progress"));
                progress.css("width", vm.userLevel.percentage + "%")

                if (vm.prizesToRedeem.length > 0) {
                    timer();
                }
            });
        }

        // Get user level
        function getUserLevel() {
            var points = vm.totalPoints;
            var levelLimit = 0;
            var arrayLevels = [];
            
            for(var i= 0; i < vm.stepPoints.length; i++) {
                levelLimit = parseInt(vm.stepPoints[i].points);
                if(points < levelLimit){
                    arrayLevels.push({
                        points: vm.stepPoints[i].points,
                        level: i + 1,
                        percentage: (points / vm.stepPoints[i].points) * 100
                    });
                }
            }
            vm.userLevel = arrayLevels[0];
        }

        var timerTimeout;

        function timer() {
            var allExpired = true;
            var remainingTime;
            for (var i = 0; i < vm.prizesToRedeem.length; i++) {
                remainingTime = showRemaining(vm.prizesToRedeem[i].expireDate);

                if (!remainingTime) {
                    vm.prizesToRedeem.splice(i, 1);
                } else if (remainingTime === "-1") {
                    vm.prizesToRedeem[i].formatedTime = null;
                } else {
                    vm.prizesToRedeem[i].formatedTime = remainingTime;
                    allExpired = false;
                }
            }

            if (!allExpired) {
                timerTimeout = $timeout(function () {
                    timer();
                }, 1000);
            }

            if (timerTimeout) {

                /* Comented this line to prevent time notcounting down and error of $interval:badprom
                * https://docs.angularjs.org/error/$interval/badprom
                */
                //$timeout.cancel(timerTimeout);
                timerTimeout = null;
            }
        }

        function showRemaining(expireDate) {
            if (expireDate < 0) {
                return "-1";
            }

            var now = new Date();
            var end = new Date(expireDate);

            var _second = 1000;
            var _minute = _second * 60;
            var _hour = _minute * 60;
            var _day = _hour * 24;

            var distance = end.getTime() - now.getTime();

            if (distance < 1000) {
                return null;
            }
            var d = new Date(distance);
            var days = Math.max(0, Math.floor(distance / _day));
            var hours = ("0" + ((days * 24) + d.getUTCHours())).substr(-2);
            var minutes = ("0" + d.getUTCMinutes()).substr(-2);
            var seconds = ("0" + d.getUTCSeconds()).substr(-2);

            return hours + ":" + minutes + ":" + seconds;

        }
        vm.prize = {
            "prize": null,
            "type": "JOKER"
        };

        vm.openPrize = function (index) {
            _redeemingPrize = true;

            vm.showWinPrize = true;
            vm.prize.prize = vm.prizesToRedeem[index];
        };


        var unregisterPingAchievements;
        var _pingAchievements = function () {
            if (appConfig.achievements_check_seconds >= 0 && $rootScope.sessionExpired === false) {
                try {

                    DataService.checkAchievements(); // execute immediately

                    unregisterPingAchievements = $interval(function () {

                        if (!_redeemingPrize) {
                            DataService.checkAchievements();
                        }

                    }, appConfig.achievements_check_seconds * 1000);
                } catch (error) {

                }
            }

            if (unregisterPingAchievements && $rootScope.sessionExpired === true) {
                $interval.cancel(unregisterPingAchievements);
            }

        };

        function updateFacebookStatus() {
            //Facebook OK
            if ($rootScope.user != undefined && $rootScope.user != null && $rootScope.user.name != null && $rootScope.user.name.length > 0) {
                vm.isFacebookConnected = true;
                vm.user = $rootScope.user;

            } else //Facebook KO
            {
                vm.isFacebookConnected = false;
            }
        }

        function userPhoto() {
            if (vm.user.photoBase64 != null && vm.user.photoBase64.length > 0) {
                return "data:image/png;base64," + vm.user.photoBase64;
            } else {
                return ''; //no photo. use default background
            }
        }


        function loginWithFacebook() {

            (function (d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) {
                    return;
                }
                js = d.createElement(s);
                js.id = id;
                js.src = "https://connect.facebook.net/en_US/sdk.js";
                js.onload = function () {
                    $log.debug("[ProfileController] Loaded Facebook.JS")
                    FB.init({
                        appId: '156187878423534',
                        autoLogAppEvents: true,
                        xfbml: true,
                        version: 'v2.12'
                    });

                    FB.login(function (response) {
                        $log.debug("[ProfileController] loginWithFacebook response: " + response);
                        if (response.authResponse) {
                            getFacebookData();
                        }
                    }, {
                        scope: 'user_birthday',
                        return_scopes: true
                    });
                };
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));

        }

        function getFacebookData() {
            FB.api(
                '/me',
                'GET', {
                    "fields": "name,first_name,last_name,birthday,picture"
                },
                function (response) {
                    $log.debug("[ProfileController] getFacebookData response: " + response);
                    DataService.saveFacebookInfo(response.name, response.id, response.birthday).then(function (responseSaveFacebookInfo) {
                        $log.debug("[ProfileController] saveFacebookInfo response: ", responseSaveFacebookInfo);
                        vm.isFacebookConnected = true;
                        vm.user = {};
                        vm.user.name = responseSaveFacebookInfo.name;
                        vm.user.photoBase64 = responseSaveFacebookInfo.photoBase64;
                        vm.awardedShakes = responseSaveFacebookInfo.awardedShakes;
                        vm.showAwardedShakesOverlay = true;
                    });
                }
            );
        }

        function init() {

            loadProfileUserPrizes();
            //getUserLevel();

            CacheService.getUserShakesStatus().then(function (_userShakesStatus) {
                vm.info.shakes = _userShakesStatus.shakesUsed;
            });

            CacheService.getBooklet().then(function (_booklet) {
                vm.booklet = _booklet;
                vm.info.cards.count = _booklet.getCardsCount();
            });

            DataService.getProfileAchievements().then(function (response) {
                vm.achievements.count = response.unlocked;
                vm.achievements.total = response.achievements.length;
                vm.achievements.achievements = response.achievements;

                var resizeAchievement = (window.innerWidth * 0.9) / vm.achievements.total;
                angular.element(document.getElementsByClassName("profile-achievement")).ready(function () {
                    angular.element(document.getElementsByClassName("profile-achievement")).css("width", resizeAchievement + "px");
                });
            });

            _pingAchievements();


            


            /*
            if ($rootScope.user != undefined) {
                updateFacebookStatus();
            } else {
                var updateMysteryBoxStatusEvent = $rootScope.$on(appConfig.events.updateLogin, function () {
                    updateFacebookStatus();
                });
            }
            */
        }

        var submitCloseShakeCard = $scope.$on(appConfig.events.cardClose, function () {
            vm.showWinPrize = false;
            vm.prize.prize = null;
            _redeemingPrize = false;
            DataService.checkAchievements();
        });

        var submiteUpdateProfileUserPrizes = $rootScope.$on(appConfig.events.submiteUpdateProfileUserPrizes, function () {
            loadProfileUserPrizes();
        });

        var submiteSwipeUp = $rootScope.$on(appConfig.events.swipeUp, function () {
            if (!$rootScope.isSideMenuOpen && $rootScope.canSwipe) {
                vm.goToHistory();
            }
        });

        var submiteSwipeDown = $rootScope.$on(appConfig.events.swipeDown, function () {
            if (!$rootScope.isSideMenuOpen && $rootScope.canSwipe) {
                vm.goToLandingPage();
            }
        });

        $scope.$on('$destroy', function () {
            submitCloseShakeCard();

            if (submiteSwipeUp) {
                $log.debug("[ProfileController][$destroy] - submiteSwipeUp");
                submiteSwipeUp();
            }

            if (submiteSwipeDown) {
                $log.debug("[ProfileController][$destroy] - submiteSwipeDown");
                submiteSwipeDown();
            }

            if (unregisterPingAchievements) {
                $log.debug("[ProfileController][$destroy] - unregisterPingAchievements");
                $interval.cancel(unregisterPingAchievements);
            }

            if (submiteUpdateProfileUserPrizes) {
                $log.debug("[CardController][$destroy] - submiteUpdateProfileUserPrizes");
                submiteUpdateProfileUserPrizes();
            }
        });

        // event triggered on wrong redeem answer
        var prizeAnswerWrong = $scope.$on(appConfig.events.prizeAnswerWrong, function (event, params) {
            $timeout(function () {
                $scope.$apply(loadProfileUserPrizes());

            });
        });

        $scope.$on('$destroy', function () {
            prizeAnswerWrong();
            submitUpdateUserPrize();
        });

        init();
    }

})();

(function () {
    'use strict';

    angular.module("promocode.controller", []).controller("PromoCodeController", PromoCodeController);

    PromoCodeController.$inject = ["$animateCss", "$document", "$location", "DataService", "CacheService", "$log", "$timeout", "$translate", "appConfig"];

    function PromoCodeController($animateCss, $document, $location, DataService, CacheService, $log, $timeout, $translate, appConfig) {

        var doc = $document[0];
        var vm = this;
        vm.validatePromoCode = validatePromoCode;
        vm.goBack = goBack;
        vm.shakeit = shakeit;
        vm.showSuccessPage = false;
        vm.numShakes = undefined;
        var counter;

        (function(){
            resetPage();
            vm.responseMessage = undefined;
            inputFocus();
        })();

        /*
         * ERROR_REDEEM_PROMOTION(306, "ERROR_REDEEM_PROMOTION")
         * ERROR_CODE_NOT_MATCH : There are no promotion with code
         * ERROR_CODE_ALREADY_USED : Promotion code already used
         * ERROR_PROMOTION_NOT_ACTIVE : Promotion with code is not active
         * ERROR_PROMOTION_RECURRENCE_OFF : Recurrence of Promotion is sold off
         * SUCCESS : Redeem promotion shakes successfully
         */
        function validatePromoCode() {
            counter++;
            if(counter === 1){
                vm.loadingSearch = true;
                console.log("vm.code : ", vm.inputCode.toUpperCase());

                //Send to BE
                DataService.promotionsRedeem(vm.inputCode.toUpperCase()).then(function (response) {
                    if (response) {

                        //Switch to show the correspondent message to User
                        switch (response.result) {
                            case 'SUCCESS': {

                                //Update Header Shakes
                                CacheService.getUserShakesStatus(true);

                                //Number of shakes won
                                vm.numShakes = response.numShakes;

                                $timeout(function () {
                                    vm.loadingSearch = false;
                                    vm.inputCode = '';
                                    vm.showSuccessPage = true;
                                }, 2500);
                                break;
                            }
                            case 'ERROR_CODE_NOT_MATCH': {
                                $timeout(function () {
                                    vm.showErrorPage = true;
                                    $translate('text.winshakes.promocode.error_code_not_match').then(function (translation) {
                                        vm.responseMessage = translation;
                                    });
                                }, 1000);
                                break;
                            }
                            case 'ERROR_CODE_ALREADY_USED': {
                                $timeout(function () {
                                    vm.showErrorPage = true;
                                    $translate('text.winshakes.promocode.error_code_already_used').then(function (translation) {
                                        vm.responseMessage = translation;
                                    });
                                }, 1000);
                                break;
                            }
                            case 'ERROR_PROMOTION_NOT_ACTIVE': {
                                $timeout(function () {
                                    vm.showErrorPage = true;
                                    $translate('text.winshakes.promocode.error_promo_not_active').then(function (translation) {
                                        vm.responseMessage = translation;
                                    });
                                }, 1000);
                                break;
                            }
                            case 'ERROR_PROMOTION_RECURRENCE_OFF': {
                                $timeout(function () {
                                    vm.showErrorPage = true;
                                    $translate('text.winshakes.promocode.error_campaign_recurrence_off').then(function (translation) {
                                        vm.responseMessage = translation;
                                    });
                                }, 1000);
                                break;
                            }
                            case 'ERROR_REDEEM_PROMOTION': {
                                $timeout(function () {
                                    vm.showErrorPage = true;
                                    $translate('text.winshakes.promocode.error_redeem_promotion').then(function (translation) {
                                        vm.responseMessage = translation;
                                    });
                                }, 1000);
                                break;
                            }
                            default: {
                                vm.showErrorPage = true;
                                console.log('[PROMO CODE] No message available');
                            }
                        }
                    }
                }, function (error) {
                    $log.error("[PromoCodeController]: ERROR!", error);
                    vm.inputCode = '';
                    vm.showErrorPage = true;
                    vm.loadingSearch = false;
                });
            }
        }

        function inputFocus(){
            var inputCodeObj = angular.element(doc.getElementById('inputCode'));
            $timeout(function() {
                inputCodeObj[0].focus();
                adjustContent();
            });
        }
        function resetPage(){
            vm.showErrorPage = false;
            vm.showSuccessPage = false;
            vm.buttonActive = false;
            vm.loadingSearch = false;
            counter = 0;
            vm.inputCode = '';
        }

        function goBack() {
            console.log('clicou no goback');
            resetPage();
            $location.path(appConfig.routes.promocode);
        }

        function shakeit() {
            $log.debug("[PromoCodeController][shakeit]: Started!");
            $location.path(appConfig.routes.landingPage);
        }

        function adjustContent(){
            angular.element(doc.getElementById('yornHeader')).ready(function () {
                angular.element(doc.getElementById('promoCodeBody')).css({ 'position': 'absolute', 'top': '25%' });
                angular.element(doc.querySelector("#yornTitleContainer")).css({
                    position: "relative",
                    padding: "4% 11% 8% 0%"
                  });
            });
        }
    }

})();

angular.module('qrcode.controller', []).controller("QrCodeController", QrCodeController);

QrCodeController.$inject = ['$scope', '$timeout', '$document', '$rootScope', '$window', 'DataService', '$log', '$location', 'appConfig', '$translate'];

/** @ngInject */
function QrCodeController($scope, $timeout, $document, $rootScope, $window, DataService, $log, $location, appConfig, $translate) {

    var vm = this;
    var auxTime = 100;
    var doc = $document[0];
    vm.showTopLeft = null;
    vm.showTopRight = null;
    vm.showBottomLeft = null;
    vm.showBottomRight = null;
    var initialAnimationRunning = true;
    $rootScope.qrPrize = {};
    $rootScope.qrMessage = '';
    $rootScope.responseQr = '';
    $rootScope.loadingSpinner = false;
    $rootScope.showErrorPage = false;

    // Close QrCode Window
    vm.closeQrCodeWindow = function () {
        $rootScope.overlayActive = false;
        $window.history.back();
    };

    //DEBUG
    /*vm.sendCode = function(code){
        sendCodeToReceivePrize(code)
    };*/

    // Animation Background
    $timeout(function () {
        vm.showTopLeft = true;
        $timeout(function () {
            vm.showTopRight = true;
            $timeout(function () {
                vm.showBottomRight = true;
                $timeout(function () {
                    vm.showBottomLeft = true;

                    $timeout(function () {
                        vm.showCardBt = true;
                        vm.showBgAnimation = true;
                        vm.showCloseBt = vm.showCloseBt && vm.showBgAnimation;
                        $timeout(function () {
                            angular.element(doc.getElementById("bgCardTopLeft")).removeClass("animated slideInLeft").addClass("leftRightAnimation");
                            angular.element(doc.getElementById("bgCardTopRight")).removeClass("animated slideInRight").addClass("rightLeftAnimation");
                            angular.element(doc.getElementById("bgCardBottomLeft")).removeClass("animated slideInLeft").addClass("leftRightAnimation");
                            angular.element(doc.getElementById("bgCardBottomRight")).removeClass("animated slideInRight").addClass("rightLeftAnimation");
                            initialAnimationRunning = false;
                        }, 700);
                    }, auxTime);
                }, auxTime);
            }, auxTime);
        }, auxTime);
    }, auxTime);

    var APICallback = function (methodName, callArguments) {

        var args = callArguments;
        var tmpArgs = [];
        for (var i = 0; i < args.length; i++) {
            tmpArgs.push(args[i]);
        }

        if ($rootScope.isAndroid) {
            if (typeof android[methodName] !== 'function') {
                throw this.UNSUPPORTED_TAG;
            }

            for (var i = 0; i < tmpArgs.length; i++) {
                if (typeof tmpArgs[i] === 'function') {
                    tmpArgs[i] = tmpArgs[i].name;
                }
            }

            if (tmpArgs.length > 0) {
                android[methodName].apply(android, tmpArgs);
            } else {
                android[methodName].apply(android);
            }
            return;
        }
        if ($rootScope.isIOS) {
            if (typeof window[methodName] !== 'function') {
                throw this.UNSUPPORTED_TAG;
            }
            if (tmpArgs.length > 0) {
                window[methodName].apply(window, tmpArgs);
            } else {
                window[methodName].apply(window);
            }
            return;
        }
        throw this.UNSUPPORTED_TAG;
    };

    /*
    * Sending CODE to server, and retrieve the PRIZE
    * ERROR CODES:
    * ERROR_QRCODE_NOT_MATCH - There are no campaign with QRCode
    * ERROR_CAMPAIGN_NOT_ACTIVE - Campaign with QRCode is not active
    * ERROR_USER_LOCATION_NOT_MACTH - User Location does not match with campaigns locations
    * ERROR_CAMPAIGN_RECURRENCE_OFF - Recurrence of Campaign is sold off
    * ERROR_NO_PRIZE_CAMPAIGN - There is no prize on campaign
    * SUCCESS - Found a prize on campaign
    * */
    function sendCodeToReceivePrize(code) {
        $rootScope.loadingSpinner = true;

        $timeout(function () {
            DataService.sendQrCodeCampaign(code).then(function (response) {

                //Set to rootScope the whole response
                $rootScope.responseQr = response;

                //Switch to show the correspondent message to User
                switch (response.result) {
                    case 'SUCCESS': {
                        console.log("QR CODE PRIZE: ", response.prize);

                        /* PRIZE TYPES AVAILABLE :
                        * TOP_UP_BONUS
                        * VOUCHERS
                        * FREE_SIEBEL_PRODUCTS
                        * PAID_SIEBEL_PRODUCTS
                        * SWAP
                        * MATERIAL_GOODS
                        * MORE_SHAKES
                        * WILDCARD
                        * */
                        $rootScope.qrPrize = {
                            "prize": response.prize,
                            "type": "JOKER"
                        };

                        break;
                    }
                    case 'ERROR_QRCODE_NOT_MATCH': {
                        $timeout(function () {
                            $rootScope.showErrorPage = true;
                            $rootScope.qrMessage = $translate.instant('texts.qrcode.error_qrcode_not_match');
                        }, 1000);
                        break;
                    }
                    case 'ERROR_CAMPAIGN_NOT_ACTIVE': {
                        $timeout(function () {
                            $rootScope.showErrorPage = true;
                            $rootScope.qrMessage = $translate.instant('texts.qrcode.error_campaign_not_active');
                        }, 1000);
                        break;
                    }
                    case 'ERROR_USER_LOCATION_NOT_MACTH': {
                        $timeout(function () {
                            $rootScope.showErrorPage = true;
                            $rootScope.qrMessage = $translate.instant('texts.qrcode.error_user_location_not_match');
                        }, 1000);
                        break;
                    }
                    case 'ERROR_CAMPAIGN_RECURRENCE_OFF': {
                        $timeout(function () {
                            $rootScope.showErrorPage = true;
                            $rootScope.qrMessage = $translate.instant('texts.qrcode.error_campaign_recurrence_off');
                        }, 1000);
                        break;
                    }
                    case 'ERROR_NO_PRIZE_CAMPAIGN': {
                        $timeout(function () {
                            $rootScope.showErrorPage = true;
                            $rootScope.qrMessage = $translate.instant('texts.qrcode.error_no_prize_campaign');
                        }, 1000);
                        break;
                    }
                    default: {
                        $rootScope.showErrorPage = true;
                        console.log('[QR CODE] No message available');
                    }
                }

                //Hide loading spinner
                $rootScope.loadingSpinner = false;
            }, function (error) {
                console.log("[QR CODE ERROR] " + error);
                $rootScope.loadingSpinner = false;
            });
        }, 0);
    }

        //DEBUG
        vm.sendCode = function (code) {
            sendCodeToReceivePrize(code)
        };

        vm.callCamera = function () {

            $rootScope.codeReaded = '';
            $timeout(function () {
                APICallback("requestQRCode", ["onSuccessQrCode", "onCancelledQrCodeReading", "onNoPermissionsQrCode"]);
            }, 0);

            onSuccessQrCode = function (code) {
                $location.path(appConfig.routes.qrcode);

                $rootScope.codeReaded = code;
                console.log("[QR_CODE] CODIGO: " + code);

                if (code) {
                    /* $timeout(function () {*/
                    sendCodeToReceivePrize(code);
                    /* }, 100);*/
                }
            };
            onCancelledQrCodeReading = function () {
                $rootScope.codeReaded = 'Leitura cancelada!';
                console.log('[QR_CODE] Leitura cancelada');
            };

            onNoPermissionsQrCode = function () {
                $rootScope.codeReaded = 'Sem permissões para ler QR Code';
                console.log('[QR_CODE] Sem permissões para ler QR Code');
            };
        }

    }


(function() {
  "use strict";

  angular.module("reward.directive", []).directive("rewardForm", RewardDirective);

  /** @ngInject */
  function RewardDirective() {
    var directive = {
      templateUrl: "app/reward/reward.template.html",
      controller: RewardController,
      controllerAs: "rwd",
      restrict: "AE",
      scope: {
        reward: "="
      }
    };

    return directive;
  }

  RewardController.$inject = [
    "$log",
    "$scope",
    "$timeout",
    "DataService",
    "$translate",
    "$rootScope",
    "appConfig",
    "$location",
    "CacheService"
  ];

  function RewardController(
    $log,
    $scope,
    $timeout,
    DataService,
    $translate,
    $rootScope,
    appConfig,
    $location,
    CacheService
  ) {
    var vm = this;

    vm.showRewardForm = null;
    vm.showTerms = null;
    vm.showWinMessage = null;
    vm.showQuestion = null;
    vm.saveAddressPreferences = false;
    vm.reward = $scope.reward;
    vm.rewardWinMessage = "";
    vm.fullWidthMaxLength = 254;
    vm.closeReward = false;

    vm.rewardIsAutoReclaim = vm.reward.autoReclaim == "true";
    vm.rewardHasRequestUserInfo = vm.reward.requestUserInfo == "true";
    vm.rewardHasTermsAndConditions = vm.reward.terms != null;
    vm.rewardHasQuestion =
      (vm.reward.questionId ? true : false) &&
      (vm.reward.userPrizeStatus === "NEW" ||
        vm.reward.userPrizeStatus === "MIDDLE_PRIZE_NOT_SHUFFLED"); // if already answered to question, skip it

    vm.question;
    vm.answerIsCorrect = null;

    vm.isFormDoorNumberDisabled = false;
    vm.isFormFloorDisabled = false;
    vm.isLocaleDisabled = true;
    vm.isAddressDisabled = true;
   
    vm.formDataChanged = formDataChanged;
    //WILD CARD
    vm.wildCardState = 0;
    vm.wildCard = null;
    vm.cards = null;
    vm.chooseWildCard = chooseWildCard;
    vm.redeemWildCard = redeemWildCard;
    vm.postalCodeSaved = {
      part1: null,
      part2: null
    }

    if (vm.rewardHasQuestion) {
      DataService.getQuestion(vm.reward.id).then(function(_response) {
        vm.question = _response.question;
      });
    }
    // Prize Address
    if ($rootScope.prizeAddress){
        vm.saveAddressPreferences = true;
        vm.prizeAddress = $rootScope.prizeAddress;
        vm.getSavedPostalCode = getSavedPostalCode($rootScope.prizeAddress.postalCode);
    }

    if (!vm.rewardHasRequestUserInfo && !vm.rewardHasTermsAndConditions) {
      vm.rewardIsAutoReclaim = true;
    }
    
    /**
     * @description
     * @author Diogo Paiva
     * @date 2020-04-28
     * @param {*} number
     * @returns the first and second part of the postal code to prepopulate the form with the values
     */
    function getSavedPostalCode(number) {
      if(number) {
        var value = getDigitsOnly(number);
        vm.postalCodeSaved.part1 = value.substr(0, 4) || null;
        vm.postalCodeSaved.part2 = value.substr(4) || null;
      }
      
      return vm.postalCodeSaved;
    }

    vm.rewardFormData = {
      dataToSend: {
        userPrizeId: vm.reward.userPrizeId,
        name: "",
        address: "",
        postalCode: "",
        doornumber: "",
        floor: "",
        locale: "",
        email: "",
        fiscalNumber: null,
        saveAddressPreferences: null
      },
      data: {
        userPrizeId: vm.reward.userPrizeId,
        name: vm.prizeAddress && vm.prizeAddress.name || "",
        address: vm.prizeAddress && vm.prizeAddress.address || "",
        postalCodePart1: vm.prizeAddress && parseFloat(vm.postalCodeSaved.part1) || "",
        postalCodePart2: vm.prizeAddress && parseFloat(vm.postalCodeSaved.part2) || "",
        doornumber: vm.prizeAddress && vm.prizeAddress.doorNumber || "",
        floor: vm.prizeAddress && vm.prizeAddress.floor || "",
        locale: vm.prizeAddress && vm.prizeAddress.locale || "",
        email: vm.prizeAddress && vm.prizeAddress.email || "",
        fiscalNumber: vm.prizeAddress && parseFloat(vm.prizeAddress.fiscalNumber) || null,
        saveAddressPreferences: vm.saveAddressPreferences || vm.prizeAddress ? true : false,
      },
      error: {
        name: false,
        address: false,
        postalCodePart1: false,
        postalCodePart2: false,
        locale: false,
        doornumber: false,
        floor: false,
        email: false,
        fiscalNumber: false
      },
      validations: {
        name: /^(\D){2,}/gi,
        address: /^(\D){2,}/gi,
        //"postalCode": /^(\d){4}-(\d){3}$/gi,
        locale: /^(\D){2,}/gi,
        doornumber: /(\S){2,}/gi,
        floor: /(\S){2,}/gi,
        email: /^(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])$/gi,
        fiscalNumber: /(\d){9}$/g,
      }
    };

    vm.closeRewardForm = function() {
      vm.closeReward = true;
      if ($scope.$parent.booklet) {
        $scope.$parent.booklet.queroOpened = false;
        $scope.$parent.booklet.showGoldCardInCarousel = false;
      }

      $timeout(function() {
        angular.element(document.getElementById("rewardForm")).remove();
        $rootScope.canSwipe = true;

        $scope.$emit(appConfig.events.cardClose);
      }, 500);
    };
    
    vm.fiscalNumberValidation = function(event) {
      var elem = event.srcElement;
      var valueLength = elem.value.toString().length;
     
      if(valueLength != 9){
        vm.rewardFormData.error.fiscalNumber = true;
        elem.value = elem.value.substr(0, 9);
      } else{
        vm.rewardFormData.error.fiscalNumber = false;
      }
    };

    vm.postalCodePart1Validation = function(event) {
      var elem = event.srcElement;
      var value = getDigitsOnly(elem.value);
      elem.value = value.substr(0, 4);
      if (value.length === 4) {
        document.getElementById("postalCodePart2").focus();
        vm.loadAddress();
      }
    };

    vm.postalCodePart2Validation = function(event) {
      var elem = event.srcElement;
      var value = getDigitsOnly(elem.value);
      elem.value = value.substr(0, 3);
      if (value.length === 3) vm.loadAddress();
    };

    var lastPostalCodeValidation = null;

    vm.addressesList = [];
    vm.localesList = [];

    vm.loadAddress = function() {
      var splited = [
        vm.rewardFormData.data.postalCodePart1.toString(),
        vm.rewardFormData.data.postalCodePart2.toString()
      ];
      if (splited[0] && splited[1] && splited[0].length === 4 && splited[1].length === 3) {
        if (lastPostalCodeValidation === splited[0] + splited[1]) {
          return;
        }

        lastPostalCodeValidation = splited[0] + splited[1];

        vm.addressesList = [];

        vm.localesList = [];

        DataService.getAddress(splited[0], splited[1]).then(function(response) {
          if (response.addresses === null || response.addresses.length === 0) {
            vm.isLocaleDisabled = false;
            vm.isAddressDisabled = false;
            vm.addressesList.push({});
            vm.localesList.push({});
          } else {
            for (var i = 0; i < response.addresses.length; i++) {
              var address = response.addresses[i].address;
              var locale = response.addresses[i].city;

              if (
                address &&
                address !== null &&
                address !== undefined &&
                !vm.addressesList.includes(address)
              ) {
                vm.addressesList.push(address);
              }

              if (
                locale &&
                locale !== null &&
                locale !== undefined &&
                !vm.localesList.includes(locale)
              ) {
                vm.localesList.push(locale);
              }
            }

            if (!vm.addressesList || (vm.addressesList && vm.addressesList.length === 0)) {
              vm.isAddressDisabled = false;
            }

            if (vm.addressesList && vm.addressesList.length >= 1) {
              vm.isAddressDisabled = false;
              vm.rewardFormData.data.address = vm.addressesList[0];
            }

            if (!vm.localesList || (vm.localesList && vm.localesList.length === 0)) {
              vm.isLocalDisabled = false;
            }

            if (vm.localesList && vm.localesList.length >= 1) {
              vm.isLocalDisabled = false;
              vm.rewardFormData.data.locale = vm.localesList[0];
            }
          }

          vm.isFormFloorDisabled = false;
          vm.isFormDoorNumberDisabled = false;
        });
      } else {
        vm.addressesList = [];
        vm.localesList = [];
        vm.rewardFormData.data.address = "";
        vm.rewardFormData.data.locale = "";
        vm.rewardFormData.data.doornumber = "";
        vm.rewardFormData.data.floor = "";
        // Is false so that the user can change the floor if he wants
        vm.isFormFloorDisabled = false; //true;
        vm.isFormDoorNumberDisabled = false; //true;
        // Is false so that the user can change Localidade and Morada if he wants
        vm.isLocaleDisabled = false;
        vm.isAddressDisabled = false;
        lastPostalCodeValidation = null;
        vm.isAddressListOpen = false;

        vm.isLocalesListOpen = false;
      }
    };

    vm.isAddressListOpen = false;
    vm.isLocalesListOpen = false;

    vm.openCloseAddressList = function() {
      vm.isAddressListOpen = !vm.isAddressListOpen;
    };

    vm.openCloseLocalesList = function() {
      vm.isLocalesListOpen = !vm.isLocalesListOpen;
    };

    vm.selectAddress = function(addressChangeValue) {
      vm.rewardFormData.data.address = addressChangeValue;
      vm.openCloseAddressList();
    };

    vm.selectLocale = function(localeChangeValue) {
      vm.rewardFormData.data.locale = localeChangeValue;
      vm.openCloseLocalesList();
    };

    vm.validateForm = function() {
      var submitBt = angular.element(document.getElementById("rewardFormSubmit"));
      var canSend = true;

      for (var key in vm.rewardFormData.data) {
        if (key != "doornumber" && key != "floor") {
          if (
            vm.rewardFormData.error.hasOwnProperty(key) &&
            vm.rewardFormData.validations.hasOwnProperty(key)
          ) {
            vm.rewardFormData.error[key] =
              !vm.rewardFormData.data[key] ||
              (vm.rewardFormData.data[key] &&
                !vm.rewardFormData.data[key].toString().match(vm.rewardFormData.validations[key]));

            canSend = canSend && !vm.rewardFormData.error[key];
          }
        } else {
          $log.debug(" skipping validation for " + key);
        }
      }

      if (canSend) {
        showWinMessage();
      }
    };

    vm.preventEnter = function(event) {
      if (13 == getKeyPressed(event)) {
        event.preventDefault();
        return false;
      }
    };

    vm.send = function() {
      vm.validateForm();
    };

    vm.termsDecision = function(accept, _userPrizeId) {
      if (accept) {
        if ($rootScope.userCanAcceptTerms == true) {
          $rootScope.userCanAcceptTerms = false;

          DataService.acceptPrizeTermsAndConditions(_userPrizeId).then(
            function(success) {
              vm.reward.terms = null;
              vm.reward.userPrizeStatus = "TERMS_ACCEPTED";
              $scope.$emit(appConfig.events.update_userprize, vm.reward);

              vm.showTerms = false;

              $rootScope.userCanAcceptTerms = true;

              if (vm.rewardHasRequestUserInfo) {
                vm.showRewardForm = true;
              } else {
                showWinMessage();
              }
            },
            function(error) {
              vm.showTerms = false;
              $rootScope.userCanAcceptTerms = true;
            }
          );
        }
      } else {
        vm.closeRewardForm();
      }
    };

    var questionAnswerSubmitted = false;
    var selectedAnswer = -1;
    var selectedAnswerElement = null;
    vm.selectAnswer = function(answerId) {
      if (!questionAnswerSubmitted) {
        if (selectedAnswer > -1) {
          angular
            .element(document.getElementById("rewardAnswer_" + selectedAnswer))
            .removeClass("selected");
          selectedAnswer = -1;
          selectedAnswerElement = null;
        }

        if (selectedAnswer != answerId) {
          selectedAnswerElement = angular.element(
            document.getElementById("rewardAnswer_" + answerId)
          );
          selectedAnswerElement.addClass("selected");
          selectedAnswer = answerId;
        }
      }
    };

    vm.confirmAction = function() {
      if (!questionAnswerSubmitted && selectedAnswerElement) {
        questionAnswerSubmitted = true;

        DataService.getQuestionValidation(
          vm.reward.userPrizeId,
          vm.question.id,
          selectedAnswer
        ).then(function(response) {
          vm.answerIsCorrect = response.answerIsCorrect;
          selectedAnswerElement.addClass(vm.answerIsCorrect ? "win" : "loose");
          if (!response.answerIsCorrect) {
            $rootScope.mcareIntegration({
              playSound: true,
              action: "notredeem"
            });

            $scope.$emit(appConfig.events.prizeAnswerWrong, vm.reward);
          } else {
            vm.reward.question = null;
            vm.reward.userPrizeStatus = "ANSWER_OK";
            vm.reward.questionId = null;
            $scope.$emit(appConfig.events.update_userprize, vm.reward);
          }
        });
      } else if (vm.answerIsCorrect != null) {
        if (vm.answerIsCorrect) {
          vm.closeQuestion();
        } else {
          vm.closeRewardForm();
        }
      }
    };

    function showWinMessage() {
      vm.rewardFormData.dataToSend.userPrizeId = vm.rewardFormData.data.userPrizeId;
      vm.rewardFormData.dataToSend.name = vm.rewardFormData.data.name;
      vm.rewardFormData.dataToSend.address = vm.rewardFormData.data.address;
      vm.rewardFormData.dataToSend.postalCode =
        vm.rewardFormData.data.postalCodePart1 + "-" + vm.rewardFormData.data.postalCodePart2;
      vm.rewardFormData.dataToSend.doornumber = vm.rewardFormData.data.doornumber;
      vm.rewardFormData.dataToSend.floor = vm.rewardFormData.data.floor;
      vm.rewardFormData.dataToSend.locale = vm.rewardFormData.data.locale;
      vm.rewardFormData.dataToSend.email = vm.rewardFormData.data.email;
      vm.rewardFormData.dataToSend.fiscalNumber = vm.rewardFormData.data.fiscalNumber;
      vm.rewardFormData.dataToSend.saveAddressPreferences = vm.rewardFormData.data.saveAddressPreferences;

      $log.debug(
        "[RewardController][showWinMessage] postPrizeRedeem request: ",
        vm.rewardFormData.dataToSend
      );

      DataService.postPrizeRedeem(vm.rewardFormData.dataToSend).then(function(response) {
        $log.debug("[RewardController][showWinMessage] postPrizeRedeem response: ", response);

        $scope.$emit(appConfig.events.submiteUpdateProfileUserPrizes);
        $rootScope.mcareIntegration({
          playSound: true,
          action: "redeem"
        });

        vm.showWinMessage = true;
      });
    }

    function getKeyPressed(event) {
      if (event) {
        return event.keyCode;
      } else if (event.which) {
        return event.which;
      }
    }

    function getDigitsOnly(value) {
      var rePattern = /(\d*)(\D*)/gi;
      return value.replace(rePattern, function(match, matchValue) {
        return matchValue;
      });
    }

    function pad_with_zeroes(number, length) {
      var my_string = "" + number;
      while (my_string.length < length) {
        my_string = "0" + my_string;
      }
      return my_string;
    }

    vm.closeQuestion = function() {
      if (vm.showQuestion) {
        vm.showQuestion = false;
      }

      if (vm.reward != null && vm.reward.type === "WILDCARD") {
        vm.wildCardState = 1;
        $log.debug("[RewardDirective][chooseWildCard] wildCardState = 1");
        CacheService.getBooklet(true).then(function(result) {
          vm.cards = result.cards;
        });
      } else if (vm.rewardIsAutoReclaim) {
        showWinMessage();
      } else if (vm.rewardHasTermsAndConditions) {
        vm.showTerms = true;
      } else if (vm.rewardHasRequestUserInfo) {
        vm.showRewardForm = true;
      }
    };

    function chooseWildCard(card) {
      if (!card.inCollection) {
        vm.wildCard = card;
        vm.wildCardState = 2;

        $timeout(function() {
          var wildCardBody2 = document.getElementById("wildCardBody2");
          if (wildCardBody2) {
            wildCardBody2.style.display = "inline-table";
            $log.debug("[RewardDirective][chooseWildCard] wildCardBody2 Changed");
          }
        }, 1000);

        $log.debug("[RewardDirective][chooseWildCard] wildCardState = 2");
      }
    }

    function redeemWildCard() {
      //if there is a request pending return
      if (vm.wildCardState === 3) {
        return;
      }
      var reward = vm.reward;

      if (vm.reward === null || vm.reward === undefined || vm.wildCard === null) {
        ErrorService.setError({
          statusCode: appConfig.statusCode.ERROR_REDEEM_FORM
        });
        $location.path(appConfig.routes.error);
      }

      $log.debug(
        "[RewardDirective][redeemWildCard]: Reward Id: " +
          vm.reward.userPrizeId +
          " Position: " +
          vm.wildCard.position
      );

      var rewardFormData = {
        data: {
          userPrizeId: reward.userPrizeId,
          name: "",
          address: "",
          postalCode: "",
          doornumber: "",
          floor: "",
          locale: "",
          email: "",
          wildcardPosition: vm.wildCard.position,
          fiscalNumber: null
        }
      };
      vm.wildCardState = 3;
      $log.debug("[RewardDirective][chooseWildCard] wildCardState = 3", rewardFormData.data);
      DataService.postPrizeRedeem(rewardFormData.data).then(
        function(response) {
          $log.debug(
            "[RewardDirective][redeemWildCard]: Reward Id: " +
              vm.reward.userPrizeId +
              " Position: " +
              vm.wildCard.position +
              " Result: ",
            response
          );

          $scope.$emit(appConfig.events.submiteUpdateProfileUserPrizes);

          $rootScope.mcareIntegration({
            playSound: true,
            action: "redeem"
          });

          $rootScope.exchangeReturn = response.awardedCard;
          $location.path(appConfig.routes.booklet);
        },
        function(_error) {
          vm.wildCardState = 2;
          $log.debug("[RewardDirective][chooseWildCard] wildCardState = 2 ", _error);
        }
      );
    }

    // Disable checkbox for default address if any address field is changed
    function formDataChanged() {
      vm.rewardFormData.data.saveAddressPreferences = false;
    }

    function init() {
      var rewardWinMessage = {
        title: null,
        message: null
      };
      if (vm.rewardHasRequestUserInfo) {
        rewardWinMessage.title = $translate.instant("text.reward.userinfo.title");
        rewardWinMessage.message = $translate.instant("text.reward.userinfo.message");
      } else {
        rewardWinMessage.message = $translate
          .instant("text.reward.autoreclaim.message")
          .replace(":prizeName", vm.reward.name);
      }
      vm.rewardWinMessage = rewardWinMessage;

      if (vm.rewardHasQuestion) {
        vm.showQuestion = true;
      } else {
        vm.closeQuestion();
      }
    }

    init();
  }
})();

(function () {
    'use strict';

    angular.module("cache.service", []).factory("CacheService", CacheService);

    CacheService.$inject = ['CacheManagementService', 'DataService', 'appConfig', '$q', '$rootScope', '$log', '$timeout', '$location'];

    function CacheService(CacheManagementService, DataService, appConfig, $q, $rootScope, $log, $timeout, $location) {
        var expireShakesPromisse = null;

        var service = {
            getMsisdn: getMsisdn,
            setMsisdn: setMsisdn,
            getBooklet: getBooklet,
            getPreviousBooklet: getPreviousBooklet,
            getUserFirstLogin: getUserFirstLogin,
            getSplashScreens: _getSplashScreens,
            setSplashScreens: _setSplashScreens,
            getUserShakesStatus: getUserShakesStatus,
            setUserShakesStatus: setUserShakesStatus,
            updateCanRefer: updateCanRefer,
            udpateDuplicatedCards: udpateDuplicatedCards,
            updateShakesAvailable: updateShakesAvailable,
            addDimensionsToCardImageUrl: addDimensionsToCardImageUrl,
            getWidthHeightforCards: getWidthHeightforCards,
            getTexts: getTexts,
            getReferral: getReferral,
            init: init,
            getListOfDuplicatedCards: getListOfDuplicatedCards,
            getMysteryBoxStatus: _getMysteryBoxStatus
        };

        return service;

        function getMsisdn() {
            return CacheManagementService.get("_msisdn");
        }

        function setMsisdn(msisdn) {
            CacheManagementService.put("_msisdn", msisdn);
        }

        function getBooklet(forceUpdate) {
            var deferred = $q.defer();
            var _booklet = CacheManagementService.get("_booklet");
            if (forceUpdate || !_booklet) {
                DataService.getGallery().then(function (response) {
                    CacheManagementService.put("_booklet", response);
                    createCardCachedImages(response);
                    deferred.resolve(response);
                });
            } else {
                $log.debug("[CacheService][Get]: _booklet");
                deferred.resolve(_booklet);
            }
            return deferred.promise;
        }

        function getPreviousBooklet() {
            var deferred = $q.defer();
            var _previousbooklet = CacheManagementService.get("_previousbooklet");
            if (!_previousbooklet) {
                DataService.getPreviousBooklet().then(function (response) {
                    CacheManagementService.put("_previousbooklet", response);
                    deferred.resolve(response);
                });
            } else {
                $log.debug("[CacheService][Get]: _previousbooklet");
                deferred.resolve(_previousbooklet);
            }
            return deferred.promise;
        }

        function createCardCachedImages(response) {

            for (var indexRow = 0; indexRow < response.cards.length; indexRow++) {
                var row = response.cards[indexRow];
                for (var index = 0; index < row.length; index++) {
                    row[index].imageCached = addDimensionsToCardImageUrl(row[index].image);
                }
            }
        }

        /**
         * Adds the width and height query params to a card imagecached url
         * So to resize it and returns the complete url
         */
        function addDimensionsToCardImageUrl(url) {
            var whCard = getWidthHeightforCards();
            if (url != null && url != undefined && url.indexOf("width") < 0) {
                if (url.indexOf("/image") > 0)
                    return url + "?width=" + whCard.width + "&height=" + whCard.height;
                else
                    return url + "&width=" + whCard.width + "&height=" + whCard.height;
            } else {
                return url;
            }
        }

        function getUserFirstLogin(forceUpdate) {
            var deferred = $q.defer();
            var _userFirstLogin = CacheManagementService.get("_userFirstLogin");
            if (!_userFirstLogin || forceUpdate) {
                DataService.getUserFirstLogin().then(function (response) {
                    CacheManagementService.put("_userFirstLogin", response);
                    $rootScope.notifyUserNewPrize = response.notifyUserNewPrize;
                    deferred.resolve(response);
                });
            } else {
                $log.debug("[CacheService][Get]: _userFirstLogin");
                deferred.resolve(_userFirstLogin);
            }
            return deferred.promise;
        }

        function validateExpireShakes(expireDate) {
            if (expireShakesPromisse) {
                $timeout.cancel(expireShakesPromisse);
                expireShakesPromisse = null;
            }
            var nextCheck = expireDate - new Date().getTime();

            if (nextCheck > 2147483647) {
                nextCheck = 2147483647;
            }

            console.log("[CacheService][validateExpireShakes]: nextCheck in " + nextCheck);

            if (nextCheck > 0) {
                expireShakesPromisse = $timeout(function () {
                    getUserShakesStatus(true);
                }, nextCheck);
            }
        }

        function getUserShakesStatus(forceUpdate) {
            var deferred = $q.defer();
            var _userShakesStatus = CacheManagementService.get("_userShakesStatus");
            if (!_userShakesStatus || forceUpdate) {
                DataService.getUserAvailableShakes().then(function (response) {
                    response.showPlus = (response.shakesAvailable > appConfig.global.maxShakes);

                    CacheManagementService.put("_userShakesStatus", response);

                    $rootScope.$emit(appConfig.events.updateUserShakesStatus);

                    if (!isNaN(response.expireDate) && response.expireDate > 0) {
                        validateExpireShakes(response.expireDate);
                    }

                    deferred.resolve(response);
                });
            } else {
                $log.debug("[CacheService][Get]: _userShakesStatus");
                deferred.resolve(_userShakesStatus);
            }
            return deferred.promise;
        }

        function getListOfDuplicatedCards(forceUpdate) {
            var deferred = $q.defer();
            var _listOfDuplicatedCards = CacheManagementService.get("_listOfDuplicatedCards");
            if (!_listOfDuplicatedCards || forceUpdate) {
                DataService.getListOfDuplicatedCards().then(function (response) {
                    CacheManagementService.put("_listOfDuplicatedCards", response);
                    $rootScope.$emit(appConfig.events.updateListOfDuplicatedCards);
                    createDuplicatedCardCachedImages(response);
                    deferred.resolve(response);
                });
            } else {
                $log.debug("[CacheService][Get]: _listOfDuplicatedCards");
                deferred.resolve(_listOfDuplicatedCards);
            }
            return deferred.promise;
        }

        function createDuplicatedCardCachedImages(response) {

            var whCard = getWidthHeightforCards();

            for (var index = 0; index < response.duplicates.length; index++) {
                var card = response.duplicates[index];
                card.imageCached = card.image + "?width=" + whCard.width + "&height=" + whCard.height;
            }
        }

        function setUserShakesStatus(userShakeStatus) {
            $log.debug("[CacheService][Get]: Updating _userShakesStatus");
            CacheManagementService.put("_userShakesStatus", userShakeStatus);
        }

        function updateShakesAvailable(val) {
            var deferred = $q.defer();

            getUserShakesStatus().then(function (_userShakesStatus) {
                _userShakesStatus.shakesAvailable = (_userShakesStatus.shakesAvailable > 0 ? _userShakesStatus.shakesAvailable + val : 0);
                deferred.resolve();
            });
            return deferred.promise;
        }

        function updateCanRefer(canReferVal) {
            var deferred = $q.defer();

            getReferral().then(function (_referral) {
                $rootScope.canRefer = _referral.canRefer = canReferVal;
                deferred.resolve();
            });
            return deferred.promise;
        }

        function udpateDuplicatedCards(val) {
            var deferred = $q.defer();

            getUserShakesStatus().then(function (_userShakesStatus) {
                _userShakesStatus.duplicated += 1;
                deferred.resolve();
            });
            return deferred.promise;
        }

        function _getSplashScreens(forceUpdate) {
            var deferred = $q.defer();
            var _splashScreens = CacheManagementService.get("_splashScreens");
            if (!_splashScreens || forceUpdate) {
                DataService.getSplashScreens().then(function (response) {
                    CacheManagementService.put("_splashScreens", response);
                    deferred.resolve(response);
                });
            } else {
                deferred.resolve(_splashScreens);
            }
            return deferred.promise;
        }

        function _setSplashScreens(_splashScreens) {
            CacheManagementService.put("_splashScreens", _splashScreens);
        }



        function getTexts(forceUpdate) {
            var deferred = $q.defer();
            var _texts = CacheManagementService.get("_texts");
            if (!_texts || forceUpdate) {
                var _localTexts;
                var _fullTexts;
                DataService.getLocalTexts().then(function (localResponse) {
                    _localTexts = localResponse;

                    DataService.getTexts().then(function (response) {

                        if (response && response.texts) {
                            _fullTexts = response.texts;

                            for (var key in _localTexts) {
                                if (!_fullTexts[key]) {
                                    _fullTexts[key] = _localTexts[key];
                                }
                            }
                        } else {
                            _fullTexts = _localTexts;
                        }

                        CacheManagementService.put("_texts", _fullTexts);
                        deferred.resolve(_fullTexts);

                    }, function (error) {
                        _fullTexts = _localTexts;
                        CacheManagementService.put("_texts", _fullTexts);
                        deferred.resolve(_fullTexts);
                    });
                });


            } else {
                deferred.resolve(_texts);
            }
            return deferred.promise;
        }

        function getReferral(forceUpdate) {
            var deferred = $q.defer();
            var _referral = CacheManagementService.get("_referral");
            if (!_referral || forceUpdate) {
                DataService.getReferral().then(function (response) {
                    $rootScope.canRefer = response.canRefer;
                    CacheManagementService.put("_referral", response);
                    deferred.resolve(response);
                });
            } else {
                $log.debug("[CacheService][Get]: _referral");
                deferred.resolve(_referral);
            }
            return deferred.promise;
        }

        function init() {
            var deferred = $q.defer();


            getUserFirstLogin(true).then(function (_userFirstLogin) {
                var _requests = [
                    _getSplashScreens(true),
                    getUserShakesStatus(true),
                    getReferral(true),
                    getBooklet(true)
                ];

                $q.all(_requests).then(function () {
                    deferred.resolve();
                });
            });

            return deferred.promise;
        }

        function getWidthHeightforCards() {
            var widthRatio = 0.25;
            if (appConfig.bookletXRatio != undefined)
                widthRatio = parseFloat(appConfig.bookletXRatio);
            var heightRatio = 1.4;

            var w = window,
                d = document,
                e = d.documentElement,
                g = d.getElementsByTagName('body')[0],
                x = w.innerWidth || e.clientWidth || g.clientWidth,
                y = w.innerHeight || e.clientHeight || g.clientHeight;
            var finalWidth = Math.round(x * widthRatio);
            var finalHeight = Math.round(finalWidth * heightRatio);

            return {
                width: finalWidth,
                height: finalHeight
            };
        }

        /**
         * Gets the status of the mystery box
         * The cached value is only valid for a given time
         */
        function _getMysteryBoxStatus(forceUpdate) {
            var deferred = $q.defer();
            var _mysteryBoxStatus = CacheManagementService.get("_mysteryBoxStatus");
            var ttl = appConfig.mysteryBoxStatusTimeout * 1000;
            var now = new Date().getTime();
            if (!_mysteryBoxStatus || forceUpdate || _mysteryBoxStatus.when < now - ttl) {
                DataService.statusMysteryBox().then(function (response) {
                    _mysteryBoxStatus = {
                        restResponse: response,
                        when: now
                    };
                    console.log(_mysteryBoxStatus);
                    CacheManagementService.put("_mysteryBoxStatus", _mysteryBoxStatus);
                    $rootScope.$emit(appConfig.events.updateMysteryBox);
                    deferred.resolve(response);
                });
            } else {
                $log.debug("[CacheService][Get]: _mysteryBoxStatus");
                deferred.resolve(_mysteryBoxStatus.restResponse);
            }

            return deferred.promise;
        }
    }

})();

(function () {	
	'use strict';
	/**
	 * Creates a service for temporary data caching
	 * methods: 
	 * 		- get(cacheId)
	 * 		- put(key, value)
	 * 		- info()
	 * 		- remove(key)
	 * 		- removeAll()
	 * 		- destroy()
	 */	
	angular.module("cachemanagement.service", []).factory("CacheManagementService", CacheManagementService);

    CacheManagementService.$inject=["$cacheFactory"];
	
	function CacheManagementService($cacheFactory){
		
		return $cacheFactory('_cacheId_');
	}

})();


(function () {
    'use strict';

    angular.module("css.service", []).factory("CssService", CssService);

    CssService.$inject = ['$http', '$q', 'appConfig'];

    function CssService($http, $q, appConfig) {
        var service = {
            getCssFile: getCssFile
        };

        return service;

        function getCssFile(dimension) {
            var deferred = $q.defer();

            var width = dimension.width;
            var height = dimension.height;

            var viewports = {
                "VH": "vh",
                "VW": "vw"
            };

            $http({
                method: 'GET',
                url: 'app/assets/styles/app.css?ver=3.0.0'
            }).then(function successCallback(response) {
                var css = (response.data);
                var rePattern = /((\d+)?(\.?)(\d+))(vw|vh)/gi;
                var cssElementPattern = /(.*)(((\d+)?(\.?)(\d+))(vw|vh)).*;/gi;
                var cssClassPattern = /([^{]+\{([\s\S]+?})\s*)/gi;
                var multiplier;
                var cssToReturn = "";
                var matchList;

                css.replace(cssClassPattern, function (matchClass) {
                    matchList = matchClass.match(cssElementPattern);
                    if (matchList) {
                        cssToReturn += matchClass.match(/.* {/gi)[0];
                        angular.forEach(matchList, function (value) {
                            cssToReturn += value;
                        });
                        cssToReturn += "} ";
                    }
                });

                deferred.resolve(cssToReturn.replace(rePattern, function (match, value, g3, g4, g5, viewport) {
                    multiplier = (viewport == viewports.VW ? width : height);
                    return ((value * multiplier) / 100) + "px";
                }));
            });

            return deferred.promise;
        }
    }

})();

(function () {
    'use strict';

    angular.module('customtranslationloader.service',[]).service('customTranslationLoader', CustomTranslationLoader);

    CustomTranslationLoader.$inject=['CacheService', '$q'];
    function CustomTranslationLoader (CacheService, $q) {
        return function () {
            var deferred = $q.defer();
            CacheService.getTexts().then(function(_texts){
                deferred.resolve(_texts);
            });
            return deferred.promise;
        };
    }
})();



(function() {
  "use strict";

  angular
    .module("httpinterceptor.service", [])
    .factory("HttpInterceptorService", HttpInterceptorService);

  HttpInterceptorService.$inject = [
    "$log",
    "appConfig",
    "ErrorService",
    "$location",
    "$q",
    "$rootScope",
    "$injector",
    "$translate"
  ];

  function HttpInterceptorService(
    $log,
    appConfig,
    ErrorService,
    $location,
    $q,
    $rootScope,
    $injector,
    $translate
  ) {
    return {
      request: function(config) {
        var _cacheService = $injector.get("CacheService");
        if (config.url.indexOf(appConfig.restapi) >= 0) {
          config.timeout = appConfig.httprequest_timeout_seconds * 1000;
          config.headers["X-XSS-Protection"] = "1; mode=block"; //https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-XSS-Protection
          config.headers["msisdn"] = _cacheService.getMsisdn();
          config.headers["Cache-control"] = "public";
          config.headers["expires"] = 86400;
        }
        $log.debug("[HttpInterceptorService] Config:", config);
        return config;
      },

      requestError: function(config) {
        return config;
      },

      response: function(response) {
        $log.debug("[HttpInterceptorService] Response:", response);
        var deferred = $q.defer();
        if (response.config.url.indexOf(appConfig.restapi) >= 0) {
          if (response.data && response.data.statusCode !== 0) {
            $rootScope.sessionExpired = false;

            if (
              response.data.statusCode === appConfig.statusCode.ERROR_SESSION_EXPIRED ||
              response.data.statusCode === appConfig.statusCode.ERROR_AUTH_INVALID_PARAMETERS ||
              response.data.statusCode === appConfig.statusCode.ERROR_USER_INACTIVE
            ) {
              console.log("Session expired");
              $rootScope.sessionExpired = true;
            }

            //user hotline 
            if (response.data.statusCode === appConfig.statusCode.ERROR_AUTH_HOTLINE_PRE_PAID ||
              response.data.statusCode === appConfig.statusCode.ERROR_AUTH_HOTLINE_POST_PAID) {

                var message = "";
                switch(response.data.statusCode){
                  case appConfig.statusCode.ERROR_AUTH_HOTLINE_PRE_PAID : {
                    message = $translate.instant("text.error.hotline.prepaid.message");
                    break;
                  }
                  case appConfig.statusCode.ERROR_AUTH_HOTLINE_POST_PAID : {
                    message = $translate.instant("text.error.hotline.postpaid.message");
                    break;
                  }
                }
              
                var error = {
                  statusCode: response.data.statusCode,
                  statusMessage: message,
                  location: "/"
                };
                ErrorService.setError(error);
                $location.path(appConfig.routes.error);
                return $q.reject(response);
            }

            //user blacklisted
            if (response.data.statusCode == appConfig.statusCode.ERROR_USER_BLACKLISTED) {
              ErrorService.setError({
                statusCode: appConfig.statusCode.ERROR_USER_BLACKLISTED
              });
              $location.path(appConfig.routes.error);
              return $q.reject(response);
            }

            if (
              response.data.statusCode === appConfig.statusCode.INFO_NEW_ACHIEVEMENT &&
              (response.config.url.indexOf("user") >= 0 ||
                response.config.url.indexOf("check") >= 0)
            ) {
              $location.url(appConfig.routes.achievements);
            } else if (
              response.data.statusCode == appConfig.statusCode.ERROR_DUPLICATED_GOLD_CARDS
            ) {
              $location.url(
                appConfig.routes.booklet + "/" + appConfig.routesParameters.duplicatedgold
              );
            } else if (
              response.data.statusCode ==
              appConfig.statusCode.WARNING_USER_MIDDLE_PRIZE_NOT_SHUFFLED_FOUND
            ) {
              $location.url(
                appConfig.routes.booklet + "/" + appConfig.routesParameters.middlePrizeNotShuffled
              );

              $rootScope.notShuffledMiddlegameprizes = response.data.middlePrizes;
              $rootScope.notShuffledMiddlegameprize = response.data.middlePrize;
            } else if (response.data.statusCode == appConfig.statusCode.ERROR_TERMS_NOT_ACCEPTED) {
              $location.url(appConfig.routes.terms);
            } else if (
              response.data.statusCode == appConfig.statusCode.SKIP_DUPLICATED_GOLD_CARDS
            ) {
              // $location.url(appConfig.routes.landingPage);
              // deferred.resolve(response);
              window.history.back();
            } else if (response.data.statusCode === appConfig.statusCode.ERROR_QR_CODE_MESSAGE) {
              deferred.resolve(response);
              $location.url(appConfig.routes.qrcode);
            } else if (response.data.statusCode === appConfig.statusCode.ERROR_PROMO_CODE_MESSAGE) {
              deferred.resolve(response);
              $location.url(appConfig.routes.promocode);
            } else if (
              response.data.statusCode === appConfig.statusCode.ERROR_EXCHANGE_CARDS_DISABLED
            ) {
              var error = {
                statusCode: response.data.statusCode,
                statusMessage: $translate.instant(
                  "text.exchangeforwildcard.error_exchange_cards_disabled"
                )
              };

              ErrorService.setError(error);
              $rootScope.showError();
              deferred.resolve(response);
            } else if (response.data.statusCode === appConfig.statusCode.ERROR_PRIZE_NOT_EXISTS) {
              var error = {
                statusCode: response.data.statusCode,
                statusMessage: $translate.instant("text.exchangeforwildcard.error_prize_not_exists")
              };

              ErrorService.setError(error);
              $rootScope.showError();
              deferred.resolve(response);
            } else if (
              response.data.statusCode ===
              appConfig.statusCode.ERROR_EXCHANGE_DUPLICATED_LIST_NUMBER
            ) {
              var error = {
                statusCode: response.data.statusCode,
                statusMessage: $translate.instant(
                  "text.exchangeforwildcard.error_exchange_duplicate_list_number"
                )
              };

              ErrorService.setError(error);
              $rootScope.showError();
              deferred.resolve(response);
            } else {
              ErrorService.setError(response.data);
              $rootScope.showError();
              deferred.reject(response);
            }
          } else {
            deferred.resolve(response);
          }

          return deferred.promise;
        }

        return response;
      },

      responseError: function(response) {
        $log.debug("[HttpInterceptorService] ResponseError:", response);
        $rootScope.sessionExpired = false;

        if (
          response.status === appConfig.statusCode.ERROR_SESSION_EXPIRED ||
          response.status === appConfig.statusCode.ERROR_AUTH_INVALID_PARAMETERS ||
          response.status === appConfig.statusCode.ERROR_USER_INACTIVE
        ) {
          console.log("Session expired");
          $rootScope.sessionExpired = true;
        }

        if (
          response.status == appConfig.statusCode.SERVER_ERROR ||
          response.config.url.indexOf(appConfig.restapi) >= 0
        ) {
          var _error = response.data;

          $rootScope.sessionExpired = false;

          if (appConfig.expiredSessionErrors.indexOf(_error.statusCode) > -1) {
            console.log("Session expired");
            $rootScope.sessionExpired = true;
          }

          //https://btracker.ws.sdd.vodafone.pt/browse/YSHAKEIT-239?filter=11526
          //errors shall not be rejected
          if (response.config.url.indexOf(appConfig.endpoint.checkachievements) >= 0) {
            return response;
          }

          //request timeout will trigger responseError callback with status -1
          if (
            response.status == appConfig.statusCode.TIMEOUT ||
            response.status == appConfig.statusCode.SERVER_ERROR
          ) {
            ErrorService.setError({
              statusCode: appConfig.statusCode.TIMEOUT
            });
            $location.path(appConfig.routes.error);
            return $q.reject(response);
          }

          ErrorService.setError(_error);

          if (appConfig.criticalErrors.indexOf(_error.statusCode) > -1) {
            $location.path(appConfig.routes.error);
          } else {
            $rootScope.showError();
          }

          return $q.reject(response);
        } else {
          return response;
        }
      }
    };
  }
})();


(function () {
    'use strict';

    var imgArray = [
        "/booklet/card_detail_bckg.png",
        "/booklet/card_overlay_blue.png",
        "/booklet/card_overlay_gold_left.png",
        "/booklet/grey_brushstroke.png",
        "/booklet/party_red_stripe.png",
        "/booklet/red_stripe.png",
        "/booklet/stamp.png",
        "/card/bottomLeft.png",
        "/card/bottomRight.png",
        "/card/stripe.png",
        "/card/topLeft.png",
        "/card/topRight.png",
        "/card/winPrizeBg.jpg",
        "/exchangecards/card_placeholder.png",
        "/exchangecards/deck_placeholder.png",
        "/exchangecards/shake_phone_icon.png",
        "/header/cards.png",
        "/header/shake.png",
        "/history/adhoc_campaign.png",
        "/history/answer_right.png",
        "/history/answer_wrong.png",
        "/history/blue_underline_stripe.png",
        "/history/collection_card.png",
        "/history/exchanged_cards.png",
        "/history/exchanged_friend_sent.png",
        "/history/exchanged_friend_received.png",
        "/history/expired_prize.png",
        "/history/expired_shakes.png",
        "/history/fullfilled_booklet.png",
        "/history/fullfilled_column.png",
        "/history/fullfilled_lines.png",
        "/history/golden_card.png",
        "/history/prize_redeem.png",
        "/history/referral_used.png",
        "/history/rejected_goldcard.png",
        "/history/shake_jokercard.png",
        "/history/terms_accepted.png",
        "/history/topup.png",
        "/history/week_fee.png",
        "/history/white_arrow_top.png",
        "/history/mystery_box_card_completed.png",
        "/history/mystery_box_open.png",
        "/main/noshake.png",
        "/main/shake.png",
        "/menu/exclamation.png",
        "/menu/hamb.png",
        "/menu/hambRed.png",
        "/profile/complete.png",
        "/profile/gold_1.png",
        "/profile/gold_2.png",
        "/profile/gold_3.png",
        "/profile/gold_4.png",
        "/profile/gold_5.png",
        "/profile/gold_6.png",
        "/profile/joker.png",
        "/shared/arrow.png",
        "/shared/arrow_gray.png",
        "/shared/arrow_left_white.png",
        "/shared/arrow_right_white.png",
        "/shared/arrow_white.png",
        "/shared/button_blue_background.png",
        "/shared/button_grey_background.png",
        "/shared/button_grey_background_small.png",
        "/shared/button_light_blue_background.png",
        "/shared/button_red_background.png",
        "/shared/cards.png",
        "/shared/close.png",
        "/shared/formStripe.png",
        "/shared/grey_main_bckgd.jpg",
        "/shared/pink_brushstroke.png",
        "/shared/prizes.png",
        "/shared/shakes.png",
        "/shared/yornShakeit_Logo.png",
        "/social/facebook.png",
        "/social/messenger.png",
        "/social/sms.png",
        "/tutorial/page.png",
        "/tutorial/pageSelected.png"
    ];

    angular.module("imageloading.service", []).factory("ImageLoadingService", ImageLoadingService);

    ImageLoadingService.$inject=['$q', '$log', 'appConfig', 'CacheService'];
    function ImageLoadingService($q, $log, appConfig, CacheService){
        var vm = this;

        var service = {
            init: loadImages
        };

        return service;

        function loadImages(){
            var deferred = $q.defer();

            initializeImgArray().then(function(){
                loadAllImages().then(function() {
                    deferred.resolve();
                });
            });

            return deferred.promise;
        }

        function initializeImgArray() {
            var deferred = $q.defer();
            var i;

            for(i=0 ; i<imgArray.length ; i++){
                imgArray[i] = appConfig.global.imagesFolder + imgArray[i];
            }

            /* Splash Screen Images */
            CacheService.getSplashScreens().then(function (response) {
                for(var i=0; i<response.splashscreenImages.length; i++){
                    var _finalUrl = response.splashscreenImages[i].image + "?width=" + window.innerWidth + "&height=" + window.innerHeight;
                    imgArray.push(_finalUrl);
                    response.splashscreenImages[i].image = _finalUrl;
                }
                CacheService.setSplashScreens(response);
                deferred.resolve();
            });

            return deferred.promise;
        }

        function loadAllImages(){
            var deferred = $q.defer();
            var loadCompleteCount = 0;
            function loaded(data){
                loadCompleteCount++;
                if(data === "error") {
                    $log.debug("ImageLoadingService - " + data.path[0].attributes[0].nodeValue + " - Loading Error");
                }

                if(loadCompleteCount == imgArray.length){
                    $log.debug('Image Loading: ' + loadCompleteCount + ' Resource images loaded...');
                    deferred.resolve();
                }
            }


            for (var i = 0; i < imgArray.length; i++) {
                var img = new Image();
                img.onload = loaded;
                img.onerror = loaded;
                img.src = imgArray[i];
            }

            return deferred.promise;
        }

    }

})();

(function () {
    'use strict';

    angular.module("nearby.service", []).factory("NearbyService", NearbyService);

    NearbyService.$inject = ['$rootScope', '$log', '$timeout'];

    function NearbyService($rootScope, $log, $timeout) {       
        var service = {
            isAPIAvailable: _isAPIAvailable,
            startAPI: _startAPI,
            stopAPI: _stopAPI
        };

        return service;  

        /**
         * Checks if the nearby api is available
         */
        function _isAPIAvailable() {
            if ($rootScope.isAndroid) {
                return (typeof android !== "undefined" && typeof android.enableGoogleNearby !== "undefined");
            } else if ($rootScope.isIOS) {
                return (typeof enableGoogleNearby !== "undefined");                   
            } else {
                return false;
            }
        }

        /**
         * * Starts the nearby engine, when available
         * Returns true if function is available and executed, false otherwise         
         * @param {*char} caller 
         */
        function _startAPI(caller) {               
            if ($rootScope.isAndroid) {
                if (typeof android !== "undefined" && typeof android.enableGoogleNearby !== "undefined" && $rootScope.nearByIsEnabled !== true) {
                    $timeout(function () {
                        console.log(caller + " enableGoogleNearby");
                        android.enableGoogleNearby("onDeviceFound", "onDeviceLost");
                    }, 2500);
                    $rootScope.nearByIsEnabled = true;
                    return true;
                }
            } else {
                if ($rootScope.isIOS) {
                    if (typeof enableGoogleNearby !== "undefined" && $rootScope.nearByIsEnabled !== true) {
                        $timeout(function () {
                            console.log(caller + " enableGoogleNearby");
                            enableGoogleNearby(onDeviceFound, onDeviceLost);
                        }, 2500);
                        $rootScope.nearByIsEnabled = true;
                        return true;
                    }
                }
            }

            // $timeout(function () {
            //     onDeviceFound('{ "msisdn": "911234567" }');
            // }, 500);
        
            // $timeout(function () {
            //     onDeviceFound('{ "msisdn": "910025092" }');
            // }, 1500);
            // $timeout(function () {
            //     onDeviceFound('{ "msisdn": "913713882" }');
            // }, 1500);
            // $timeout(function () {
            //     onDeviceFound('{ "msisdn": "910077859" }');
            // }, 1500);
            // $timeout(function () {
            //     onDeviceFound('{ "msisdn": "916268823" }');
            // }, 1500);
            // $timeout(function () {
            //     onDeviceFound('{ "msisdn": "910012505" }');
            // }, 1500);

            return false;         
        }

        /**
         * Stops the nearby engine, when available
         * Returns true if function is available and executed, false otherwise
         */
        function _stopAPI(caller) {                    
            if ($rootScope.isAndroid) {
                if (typeof android !== "undefined" && typeof android.disableGoogleNearby !== "undefined") {
                    console.log(caller + " disableGoogleNearby");
                    android.disableGoogleNearby();
                    $rootScope.nearByIsEnabled = false;
                    return true;
                }
            } else {
                if ($rootScope.isIOS) {
                    if (typeof disableGoogleNearby !== "undefined") {
                        console.log(caller + " disableGoogleNearby");
                        disableGoogleNearby();
                        $rootScope.nearByIsEnabled = false;
                        return true;
                    }
                }
            }
            return false;         
        }
    }
        
})();
(function () {
    'use strict';

    angular.module("utilities.service", []).factory("Utilities", UtilitiesFactory);
    
    function UtilitiesFactory() {
        return {
            parseDate: _parseDate
        };

        function _parseDate (dateMils, mask){
            var _numericMonth = ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"];
            var _parsedDate = '';
            var _datelong = 0;
            if(typeof dateMils !== "number"){
                _datelong = parseInt(dateMils);
            }else {
                _datelong = dateMils;
            }

            if(_datelong && _datelong > 0){
                var _date = new Date(_datelong);
                _parsedDate = mask.replace('dd', _date.getDate()).replace('mm', _numericMonth[_date.getUTCMonth()]).replace('yyyy', _date.getUTCFullYear());
            }
            return _parsedDate;
        }
    }
})();
(function () {
    'use strict';

    angular.module('share.directive', []).directive('share', ShareDirective).controller("ShareController", ShareController);


    function ShareDirective() {
        var directive = {
            restrict: 'AE',
            templateUrl: 'app/share/share.template.html',
            scope: {
                option: '@',
                referral: '@',
                achievement: '=',
                reward: '='
            },
            controller: ShareController,
            controllerAs: 'share'
        };

        return directive;
    }


    ShareController.$inject = ["$scope", 'appConfig', '$translate', '$rootScope'];
    /** @ngInject */
    function ShareController($scope, appConfig, $translate, $rootScope) {
        var vm = this;
        vm.isAchievement = false;
        vm.isReferral = false;

        var achievement = null;
        var reward = null;
        var shareText = null;

        vm.shareApp = {
            "messenger": "messenger",
            "facebook": "facebook",
            "sms": "sms",
            "whatsapp": "whatsapp"
        };

        if ($scope.option == "achievement") {
            vm.isAchievement = true;
            achievement = $scope.achievement;
            var shareKey = "text.share.achievement." + achievement.type.toLocaleLowerCase();
            shareText = $translate.instant(shareKey).replace(":level:", _getPtLevel(achievement.level)) + " " + achievement.image;
        } else if ($scope.option == "referral") {
            vm.isReferral = true;
        } else if ($scope.option == "reward") {
            reward = $scope.reward;
            var shareKey = "text.share.reward." + reward.type.toLocaleLowerCase();
            shareText = $translate.instant(shareKey).replace(":reward_name:", reward.name) + " " + reward.image;
        }

        vm.doShare = function (option) {
            if (option == vm.shareApp.facebook) {
                shareOnFacebook();
            } else {
                var referralCode = $rootScope.myReferralCode;
                shareText = $translate.instant('text.share.referral').replace(":referralCode:", referralCode);
                shareLink(sharePrefix[option] + encodeURIComponent(shareText));
            }
        };

        var sharePrefix = {
            "messenger": "fb-messenger://share?link=",
            "sms": "sms:" + ($rootScope.isIOS ? "?&" : "?") + "body=",
            "whatsapp": "whatsapp://send?text="
        };


        function shareOnFacebook() {
            var referralCode = $rootScope.myReferralCode;
            shareText = $translate.instant('text.share.referral').replace(":referralCode:", referralCode);
            var fbShare = "https://www.facebook.com/v2.8/dialog/share?" +
                "client_id=" + appConfig.facebook_id +
                "&href=" + encodeURIComponent("http://www.yorn.net") +
                "&quote=" + encodeURIComponent(shareText);
            shareLink(fbShare);
        }

        function shareLink(shareLink) {
            $rootScope.mcareIntegration({
                "shareLink": shareLink
            });

        }

        function _getPtLevel(_level) {
            _level = _level.toLowerCase();
            switch (_level) {
                case 'gold':
                    return 'ouro';
                case 'silver':
                    return 'prata';
                case 'bronze':
                    return 'bronze';
            }
        }
    }
})();

(function () {
    'use strict';

    angular.module('sidemenu.directive', []).directive('sidemenu', SideMenuDirective).controller("SideMenuController", SideMenuController);

    /** @ngInject */
    function SideMenuDirective() {
        var directive = {
            restrict: 'AE',
            templateUrl: 'app/sidemenu/sidemenu.template.html',
            scope: {
                isHambVisible: '=',
                isHeader: '='
            },
            controller: SideMenuController,
            controllerAs: 'sidemenu'
        };

        return directive;
    }


    SideMenuController.$inject = ["$scope","$log", "$rootScope", "$location", "appConfig", 'CacheService', 'DataService'];
    /** @ngInject */
    function SideMenuController($scope,$log, $rootScope, $location, appConfig, CacheService, DataService) {
        var vm = this;
        $rootScope.isSideMenuOpen = null;
        $rootScope.isFirstTime = false;
        vm.showMainPageNavigation = ($location.$$path != "/");
        vm.isHambVisible = $scope.isHambVisible;
        vm.isHeader = $scope.isHeader;
        vm.showTutorial = false;
        vm.showTerms = false;
        vm.showPreviousBooklet = false;
        
        vm.closeSideMenu = closeSideMenu;
        vm.toggleSound = toggleSound;
        vm.toggleVibrate = toggleVibrate;
        var option = 0;
        vm.menuOption = {
            "myProfile": "submitMenuOption_" + option++,
            "booklet": "submitMenuOption_" + option++,
            "prizes": "submitMenuOption_" + option++,
            "winShakes": "submitMenuOption_" + option++,
            "repeatedCards": "submitMenuOption_" + option++,
            "terms": "submitMenuOption_" + option++,
            "tutorial": "submitMenuOption_" + option++,
            "previousbooklet": "submitMenuOption_" + option++,
            "qrcode": "submitMenuOption_" + option++,
        };

        vm.selectOption = function (option) {
          
            if (option == vm.menuOption.tutorial) {
                vm.showTutorial = true;
                $rootScope.canSwipe = false;
            } else if (option == vm.menuOption.terms) {
                vm.showTerms = true;
                $rootScope.canSwipe = false;
            } else if (option == vm.menuOption.booklet) {
                $location.path(appConfig.routes.booklet);
            } else if (option == vm.menuOption.prizes) {
                $location.path(appConfig.routes.prizes);
            } else if (option == vm.menuOption.winShakes) {
                $location.path(appConfig.routes.winshakes);
            } else if (option == vm.menuOption.myProfile) {
                $location.path(appConfig.routes.profile);
            } else if (option == vm.menuOption.repeatedCards) {
                $location.path(appConfig.routes.exchangetype);
            } else if (option == vm.menuOption.previousbooklet) {
                $location.path(appConfig.routes.previousbooklet);
            }

            $rootScope.isSideMenuOpen = false;
        };

        var isFirstTime = false;

        var submitCloseTutorial = $rootScope.$on(appConfig.events.closeTutorial, function () {
            if (isFirstTime) {
                isFirstTime = false;

                CacheService.getUserFirstLogin(true).then(function (_userFirstLogin) {
                    $rootScope.user = _userFirstLogin;
                    $location.path(appConfig.routes.winshakes);
                    vm.showTutorial = false;
                    $rootScope.canSwipe = true;
                    $scope.$emit(appConfig.events.updateLogin);
                });
            } else {
                vm.showTutorial = false;
            }
        });

        var submitCloseTerms = $rootScope.$on(appConfig.events.closeTerms, function () {
            vm.showTerms = false;
            $rootScope.canSwipe = true;
        });

        //var submiteSwipeLeft = $rootScope.$on(appConfig.events.swipeLeft, function () {
        //    $rootScope.isSideMenuOpen = true;
        //    $rootScope.$apply();
        //});

        var submiteSwipeRight = $rootScope.$on(appConfig.events.swipeRight, function () {
            if (!vm.showTutorial && $rootScope.isSideMenuOpen != null) {
                $rootScope.isSideMenuOpen = false;
                $rootScope.$apply();
            }
        });

        //Hide side menu
        function closeSideMenu(event) {
            if ($rootScope.isSideMenuOpen === true) {
                $rootScope.isSideMenuOpen = false;
            }
        }

        // Initialize User Settings Variables 
        vm.soundEnabled = $rootScope.userSettings.sound || true;
        vm.vibrateEnabled = $rootScope.userSettings.vibration || true;

        $rootScope.$on('$destroy', function () {
            submitCloseTutorial();
            submitCloseTerms();
            //submiteSwipeLeft();
            submiteSwipeRight();
        });

        CacheService.getUserFirstLogin().then(function (_userFirstLogin) {
            $rootScope.user = _userFirstLogin;
            vm.showPreviousBooklet = _userFirstLogin.previousCollectionAvailable;
            
            // Set values User Settings values from the firstLogin
            $rootScope.userSettings = _userFirstLogin.userSettings;
            vm.soundEnabled = $rootScope.userSettings.sound;
            vm.vibrateEnabled = $rootScope.userSettings.vibration;
            
            $scope.$emit(appConfig.events.updateLogin);
            if (_userFirstLogin.firstLogin === true || _userFirstLogin.tutorialCompleted === false) {
                $rootScope.canSwipe = false;
                $rootScope.isFirstTime = true;
                isFirstTime = true;
                vm.showTutorial = true;
            }
        });

        DataService.keepAlive();

        function toggleSound(value) {
            if (value === true) {
                vm.soundEnabled = true;
                $scope.$emit('soundEnabled');
                
            }
            else {
                vm.soundEnabled = false;
                $scope.$emit('soundDisabled');
            }

            var data = {
                sound: vm.soundEnabled,
                vibration: vm.vibrateEnabled
            }

             sendSettings(data);
        }

        function toggleVibrate(value) {
            if (value === true) {
                vm.vibrateEnabled = true;
                $scope.$emit('vibrateEnabled');
            } else {
                vm.vibrateEnabled = false;
                $scope.$emit('vibrateDisabled');
            }

            var userSettings = {
                sound: vm.soundEnabled,
                vibration: vm.vibrateEnabled
            }

            sendSettings(userSettings);
        }


        function sendSettings(data) {

            DataService.userSettings(data).then(function (response) {
                if (response) {
                    $rootScope.userSettings.sound = data.sound;
                    $rootScope.userSettings.vibration = data.vibration;
                }
            }, function (error) {
                $log.error("[mediaSettings]: ERROR!", error);
            });
        }

        CacheService.getReferral().then(function (_referral) {
            $rootScope.canRefer = _referral.canRefer;
        });
    }
})();

(function () {
    'use strict';

    angular
        .module('splashvideo.directive', [])
        .directive('splashVideo', SplashVideoDirective)
        .controller("SplashVideoController", SplashVideoController);

    /** @ngInject */
    function SplashVideoDirective() {
        var directive = {
            restrict: 'E',
            templateUrl: 'app/splashvideo/splashvideo.template.html',
            controller: SplashVideoController,
            controllerAs: 'vm',
            scope: {
                model: '=',
                url: '@',
                type: '@',
                slideIndex: '@',
                sort: '@'
            },
            replace: 'true'
        };

        return directive;
    }

    SplashVideoController.$inject = ['$scope', '$timeout', '$window', 'appConfig', 'CacheService', '$rootScope', 'DataService', '$sce'];

    /** @ngInject */

    function SplashVideoController($scope, $timeout, $window, appConfig, CacheService, $rootScope, DataService, $sce) {
        var vm = this;
        vm.isVideoCompleted = false;
        vm.data = null;

        // Value in Seconds
        vm.waitingDelay = appConfig.global.videoPlaybackCountdown;
        vm.counterEnabled = false;
        $rootScope.isLocked = undefined;
        $rootScope.canSwipe = true;
        $scope.stopped = true;
        var youtubePlayer;
        var video;

        //Add validation from $sce trusted resource
        $scope.trustSrc = function(src) {
            return $sce.trustAsResourceUrl(src);
        };

        var isOnVisibleSlide = function () {
            return $scope.slideIndex === $scope.sort;
        };
        var isOnFirstSlide = function(){
            return $scope.slideIndex === "0";
        };

        /*YOUTUBE VIDEO PLAYER Settings*/
        if ($scope.type === 'youtube') {

            //Load Player
            var loadYoutubePlayer = function () {

                if (typeof (YT) == 'undefined' || typeof (YT.Player) == 'undefined') {

                    var tag = document.createElement('script');
                    tag.src = "https://www.youtube.com/iframe_api";
                    var firstScriptTag = document.getElementsByTagName('script')[0];
                    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

                    $window.onYouTubeIframeAPIReady = function () {
                        youtubePlayer = new YT.Player('youtubePlayer', {
                            height: '360',
                            width: '640',
                            events: {
                                'onReady': onPlayerReady,
                                'onStateChange': onPlayerStateChange
                            }
                        });
                    };
                } else {
                    $window.onYouTubeIframeAPIReady = function () {
                        youtubePlayer = new YT.Player('youtubePlayer', {
                            height: '360',
                            width: '640',
                            events: {
                                'onReady': onPlayerReady,
                                'onStateChange': onPlayerStateChange
                            }
                        });
                    }
                }
            };

            //Run Youtube Player
            loadYoutubePlayer();

            var onPlayerReady = function () {
                if (isOnVisibleSlide()) {
                    $scope.$broadcast('playVideo');
                }
            };

            /*
            * YOUTUBE video STATES
            *   -1 (unstarted)
                0 (ended)
                1 (playing)
                2 (paused)
                3 (buffering)
                5 (video cued)
            *
            * */
            var onPlayerStateChange = function (event) {
                if (event.data === YT.PlayerState.PLAYING) {
                 //   console.log('Está em PLAY');
                 //   $scope.$broadcast('playVideo');

                } else if (event.data === YT.PlayerState.PAUSED) {
                  //  console.log('Está em PAUSE');
                 //   $scope.$broadcast('pauseVideo');

                } else if (event.data === YT.PlayerState.ENDED) {
                    //  console.log('Video Terminou');
                }
            };

            var pauseYoutubeVideo = function () {
               return youtubePlayer.pauseVideo();
            };

            var playYoutubeVideo = function () {
                return youtubePlayer.playVideo();
            };
        }

        /*HTML5 VIDEO PLAYER Settings*/
        $timeout(function () {
            if ($scope.type === 'file') {
                var html5Player = angular.element(document.querySelector('#localPlayer'));
                video = html5Player[0];

                //Hide Play Button
                $scope.renderBtnVideoPlay = false;

                video.playbackRate = 1;

                //Browser already has sufficient buffer to play the video
                video.addEventListener('canplay', function () {
                  //  console.log('O browser ja carregou o suficiente para iniciar o video');
                    if (isOnVisibleSlide()) {
                        $scope.$broadcast('playVideo');
                    } else {
                        $scope.$broadcast('pauseVideo');
                    }
                   // console.log('isOnVisibleSlide: ' + isOnVisibleSlide());
                }, false);

                //Video Stops because is buffering the next video segment
                 video.addEventListener('waiting', function () {
                   //  console.log('Está a fazer buffering');
                     $scope.$broadcast('pauseVideo');
                 }, false);

            }
        }, 0);

        //Play Video Event
        $scope.$on('playVideo', function (event) {
            //HTML5
            if (video) {
                video.play();
            }

            // YOUTUBE
            if (youtubePlayer) {
                playYoutubeVideo();
            }

            //Resume CountDown
            $scope.stopped = false;
            $scope.countTime();

            disableCarousel();
            console.log('PLAY');
        });

        //Pause Video Event
        $scope.$on('pauseVideo', function (event) {
         //   if (!$rootScope.isLocked) {

                //HTML5
                if (video) {
                    video.pause();
                }
                //YOUTUBE
                if (youtubePlayer) {
                    pauseYoutubeVideo();
                }

                //Pause Countdown
                $scope.stopped = true;
                $scope.countTime();
                console.log('PAUSE')
           // }
        });

        var disableCarousel = function () {
            $timeout(function () {
                $rootScope.isLocked = true;
                $rootScope.canSwipe = false;
            });
        };
        var enableCarousel = function () {
            $timeout(function () {
                $rootScope.isLocked = false;
                $rootScope.canSwipe = true;
            });
        };

        //COUNTER
        $scope.counter = vm.waitingDelay;
        var mytimeout = $timeout($scope.onTimeout, 1000);
        $scope.onTimeout = function () {
            if ($scope.counter > 0) {
                $scope.counter--;
                disableCarousel();

            } else if ($scope.counter === 0) {
                enableCarousel();
            }
            mytimeout = $timeout($scope.onTimeout, 1000);
        };

        //Timer Actions for freezing the carousel while time still not ended
        $scope.countTime = function () {
            if ($scope.counter > 0) {
                if ($scope.stopped) {
                    $timeout.cancel(mytimeout);
                } else {
                    mytimeout = $timeout($scope.onTimeout, 1000);
                }
            }
            $scope.stopped = !$scope.stopped;
        };
    }

})();

(function () {
	'use strict';

	angular.module('terms.directive', []).directive('terms', TermsDirective).controller("TermsController", TermsController);

	/** @ngInject */
	function TermsDirective() {
		var directive = {
			restrict: 'E',
			templateUrl: 'app/terms/terms.template.html',
			scope: true,
			controller: TermsController,
			controllerAs: 'terms'
		};

		return directive;
	}

    TermsController.$inject = ['$scope', '$timeout', 'appConfig', 'DataService', '$rootScope', '$location'];
	/** @ngInject */
	function TermsController($scope, $timeout, appConfig, DataService, $rootScope, $location) {
		var vm = this;
        vm.showActions = true;
        var _buttonLocked = false;
        if($location.url().indexOf(appConfig.routes.terms) >= 0){
        	vm.showAcceptBt = true;
		}

        $rootScope.canSwipe = false;
        $rootScope.overlayActive = true;

        vm.closeTerms = function(){
            vm.showActions = false;
            $rootScope.overlayActive = false;
            $timeout(function () {
                $scope.$emit(appConfig.events.closeTerms);
                $rootScope.canSwipe = true;
            }, 500);
        };

        vm.acceptTerms = function() {
            if(!_buttonLocked) {
                _buttonLocked = true;
                DataService.acceptTermsAndConditions().then(function () {
                    $location.url(appConfig.routes.landingPage);
                });
            }
		};
        DataService.getTermsAndConditions().then(function (response) {
            vm.data = response.terms;
        });

    }

})();

(function () {
    'use strict';

    angular.module('tutorial.directive', []).directive('tutorial', TutorialDirective).controller("TutorialController", TutorialController);

    /** @ngInject */
    function TutorialDirective() {
        var directive = {
            restrict: 'E',
            templateUrl: 'app/tutorial/tutorial.template.html',
            controller: TutorialController,
            controllerAs: 'vm',
            scope: {
                isFromSideMenu: '='
            }
        };

        return directive;
    }

    TutorialController.$inject = ["$scope", "$timeout", 'appConfig', 'CacheService', '$rootScope', 'DataService', '$sce'];
    /** @ngInject */
    function TutorialController($scope, $timeout, appConfig, CacheService, $rootScope, DataService, $sce) {

        $rootScope.canSwipe = false;
        $rootScope.overlayActive = true;
        $rootScope.isLocked =  false;

        var _isTutorialCompleted = false;
        var vm = this;
        vm.carouselIndex = 0;
        vm.showActions = true;

        console.log("Tutorial HasCloseButton:" + (appConfig.global.tutorialHasCloseButton === 'true') + " First Time: " + ($rootScope.isFirstTime));
        vm.showCloseBt = ((appConfig.global.tutorialHasCloseButton === 'true') && !$rootScope.isFirstTime && !$rootScope.isLocked);
        vm.data = [];
        vm.video = null;

        var tutorialData = null;

        vm.validateActions = function () {
            if (vm.carouselIndex < (tutorialData.length - 1) && !$rootScope.isLocked) {
                vm.carouselIndex++;
            } else if ($rootScope.isLocked) {
                return vm.carouselIndex;
            } else {
                vm.closeTutorial();
            }
        };
        vm.validateActionsRight = function () {
            if (vm.carouselIndex < (tutorialData.length - 1) && !$rootScope.isLocked) {
                vm.carouselIndex--;
            } else if ($rootScope.isLocked || (!$rootScope.isLocked && vm.carouselIndex === 0)) {
                return vm.carouselIndex;
            }
        };



        vm.closeTutorial = function () {
            console.log("TutorialController closeTutorial");
            if (!_isTutorialCompleted) {
                _isTutorialCompleted = true;
            }
            if (!vm.showCloseBt) {
                console.log("TutorialController Remove Bullet");
                tutorialData.pop();
            }

            DataService.setUserTutorialCompleted().then(function () {
                vm.showActions = false;
                $rootScope.canSwipe = true;
                $rootScope.overlayActive = false;
                $scope.$emit(appConfig.events.closeTutorial);
                console.log("TutorialController Emitted close tutorial");

                CacheService.getUserShakesStatus(true).then(function () {
                    $scope.$broadcast(appConfig.events.updateUserShakesStatus);
                    console.log("TutorialController Update shakes");
                });
            });
        };

        // Get Tutorial Data
        DataService.getUserTutorial().then(function (response) {
            vm.data = response.tutorialScreens;
            vm.videoData = response.introductionVideo;
            tutorialData = response.tutorialScreens;
            $scope.videoSort = vm.videoData.sort;

            //Added query parameters to Youtube player
            if (vm.videoData && vm.videoData.type === 'youtube') {
                var baseYoutubeUrl = 'https://www.youtube.com/embed/' + vm.videoData.url;

                vm.videoData.url = baseYoutubeUrl + "/?iv_load_policy=3" +
                    "&fs=0" +
                    "&disablekb=1" +
                    "&autohide=1" +
                    "&enablejsapi=1" +
                    "&controls=0" +
                    "&modestbranding=1" +
                    "&playsinline=1" +
                    "&rel=0" +
                    "&showinfo=0";
            }

            //Merge array Tutorial with Video
            if(vm.videoData && vm.videoData.url){
                vm.data.push(vm.videoData);
            }

            //Sort asc by Sort field
            vm.data.sort(function (a, b) {
                return (a.sort > b.sort) ? 1 : ((b.sort > a.sort) ? -1 : 0);
            });
        });

        // If video exists, then emit broadcast
        // to permit video control in the swipe events
        vm.videoSwipeIndex = function ($nextIndex) {
            //console.log('CURRENT INDEX: ' + vm.carouselIndex + ' || NEXT SLIDE INDEX: ' + $nextIndex + ' || VIDEO SORT: ' + $scope.videoSort);
            if (vm.videoData && vm.videoData.url) {
                if ($nextIndex === $scope.videoSort || ($scope.videoSort === 0 && $nextIndex === 0)) {
                    $timeout(function(){
                        $scope.$broadcast('playVideo');
                        $rootScope.isLocked = true;
                    },0);
                } else if($nextIndex >= 0 && !$rootScope.isLocked) {
                    $timeout(function(){
                        $scope.$broadcast('pauseVideo');
                    },0);
                }
            }
        };


        CacheService.getUserFirstLogin(false).then(function (_userFirstLogin) {
            $rootScope.user = _userFirstLogin;
            _isTutorialCompleted = _userFirstLogin.tutorialCompleted;
            $scope.$emit(appConfig.events.updateLogin);
        });
    }
})();


(function () {
    'use strict';

    angular.module('winshakes.controller', []).controller('WinShakestController',
        WinShakestController);

    WinShakestController.$inject = ['DataService', '$rootScope', '$location', '$log', 'appConfig', 'CacheService', '$timeout'];
    /** @ngInject */
    function WinShakestController(DataService, $rootScope, $location, $log, appConfig, CacheService, $timeout) {
        var attemptedReferrals = [];
        var _CODE_MAX_LENGTH = 10;
        var vm = this;
        vm.invalidCode = false;
        vm.invalidCodeMessage = "";
        vm.referralCode = "";
        vm.showPrizeOverLay = null;
        vm.showShare = false;
        vm.lockInput = false;
        vm.referralCodePattern = '[a-zA-Z0-9]+';
        vm.editingReferralCode = false;

        vm.overlayoptions = {
            "close": 1,
            "shakeit": 2
        };

        vm.goToExchangeCards = function () {
            $location.path(appConfig.routes.cardsexchange);
        };

        vm.gotoPromoCode = function () {
            $location.path(appConfig.routes.promocode);
        };


        vm.validateCode = function () {
            if (vm.lockInput) {
                $log.debug(" Win Shakes - request being processed... shall wait for response");
            } else {
                if ($rootScope.canRefer && vm.referralCode.length > 0 && vm.referralCode.length <= _CODE_MAX_LENGTH) {
                    vm.lockInput = true;
                    DataService.validateReferralCode(vm.referralCode.toUpperCase()).then(function (response) {

                        if (!response.isReferralCodeValid) {
                            vm.invalidCode = true;
                        } else {
                            vm.showPrizeOverLay = true;
                        }

                        vm.lockInput = false;
                    }, function (error) {
                        vm.lockInput = false;
                    });
                }
            }
        };

        vm.keypressAction = function () {
            if (vm.referralCode && vm.referralCode.length > _CODE_MAX_LENGTH) {
                vm.referralCode = vm.referralCode.substr(0, _CODE_MAX_LENGTH);
            }
            if (vm.invalidCode) {
                vm.invalidCode = false;
            }
        };

        vm.overlayOption = function (option) {

            CacheService.updateCanRefer(false);

            if (option == vm.overlayoptions.close) {
                vm.showPrizeOverLay = false;
                $timeout(function () {
                    angular.element(document.getElementById("div_showPrizeOverLay")).remove();
                }, 500);
            } else if (option == vm.overlayoptions.shakeit) {
                $location.path(appConfig.routes.landingPage);
            }
        };

        vm.editReferralCode = function () {
            vm.editingReferralCode = true;

            var winShakesContainer = document.getElementById("winShakesContainer");
            winShakesContainer.scrollTop = 0;

            var referralCodeInput = document.getElementById("referralCodeInput");
            var scrollAmountY = referralCodeInput.getBoundingClientRect().top - referralCodeInput.getBoundingClientRect().height;
            winShakesContainer.scrollTop = scrollAmountY;

            $timeout(function () {
                document.getElementById("referralCodeInput").focus();
            }, 250);

        };

        vm.saveReferralCode = function () {

            var reg = new RegExp("^[a-zA-Z0-9]{8,10}$");
            if (appConfig.nicknamePattern != undefined)
                reg = new RegExp(appConfig.nicknamePattern);

            var newReferralCode = vm.myReferralCode;
            if (reg.test(newReferralCode)) {
                vm.invalidCode = false;
                $log.debug("[winshakes] saveReferralCode: Valid newReferralCode: " + newReferralCode);
                DataService.saveNickName(newReferralCode.toUpperCase()).then(function (response) {
                    if (response.isInvalid) {
                        vm.invalidCode = true;
                        vm.invalidCodeMessage = "text.winshakes.newReferralCode.error";
                        return;
                    }
                    if (response.isInUse) {
                        vm.invalidCode = true;
                        vm.invalidCodeMessage = "text.winshakes.newReferralCode.alreadyUsed";
                        return;
                    }
                    vm.editingReferralCode = false;
                    CacheService.getReferral(true).then(function (_referral) {
                        $rootScope.myReferralCode = _referral.referralCode;
                        vm.myReferralCode = _referral.referralCode;
                        vm.originalReferralCode = _referral.referralCode;
                    });

                }, function (error) {
                    vm.invalidCode = true;
                });
            } else {
                $log.debug("[winshakes] saveReferralCode: Invalid newReferralCode: " + newReferralCode);
                vm.invalidCode = true;
                vm.invalidCodeMessage = "text.winshakes.newReferralCode.error";
            }

        };

        vm.cancelReferralCode = function () {
            vm.editingReferralCode = false;
            vm.myReferralCode = vm.originalReferralCode;
        }

        CacheService.getReferral().then(function (_referral) {
            $rootScope.myReferralCode = _referral.referralCode;
            vm.myReferralCode = _referral.referralCode;
            vm.originalReferralCode = _referral.referralCode;
            vm.showShare = true;

            if ($rootScope.winshakesEditOnEnter !== undefined && $rootScope.winshakesEditOnEnter !== null && $rootScope.winshakesEditOnEnter === true) {
                $timeout(function () {
                    vm.editReferralCode();
                }, 250);
                $rootScope.winshakesEditOnEnter = false;
            }
        });

        DataService.getProfileShakes().then(function (result) {
            vm.profileShakes = result;
            console.log(result);
        }, function (error) {

        });

    }

})();
